<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<topic xml:id="minimal-vm-combustion"
 role="concept" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Using &combustion; with &minvm;</title>
    <meta name="maintainer" content="dpopov@suse.com" its:translate="yes"/>
  </info>
  <para>
    &minvm; comes with the &combustion; configuration tool that makes it
    possible to configure the system on first boot using a dedicated script
    file. Using &combustion; instead of &jeosfirstboot; allows you to
    automatically apply identical configuration to multiple &minvm; instances.
  </para>
  <para>
    To trigger the &combustion; tool in &kvm;, use the <command>qemu</command>
    command with the <parameter>fw_cfg</parameter> parameter that specifies the
    location of the <filename>script</filename> file.
  </para>
  <para>
    To see how this works in practice, you can use a simple &combustion; script
    that automatically adds the &rootuser; user to the &minvm; instance running
    in &qemu;.
  </para>
  <para>
    First, generate a hash of the desired &rootuser; password. This can be done
    using the <command>openssl passwd -6</command> command. Add the following
    instruction to the <filename>script</filename> file (replace the example
    hash with the generated one):
  </para>
<screen>echo 'root:$5$.wn2BZHlEJ5R3B1C$TAHEchlU.h2tvfOpOki54NaHpGYKwdNhjaBuSpDotD7' | chpasswd -e</screen>
  <para>
    Run a new virtual machine based on &minvm; in &qemu; using the following
    command (replace <replaceable>IMAGE</replaceable> and
    <replaceable>SCRIPT</replaceable> with the path name of the
    <filename>.qcow2</filename> image and the <filename>script</filename>
    file):
  </para>
<screen>&prompt.user;qemu-system-x86_64 \
      -enable-kvm \
      -m 1G \
      -smp 1 \
      -drive if=virtio,format=qcow2,file=<replaceable>IMAGE</replaceable>.qcow2 \
      -nographic \
      -netdev user,id=net0,hostfwd=tcp::2222-:22 \
      -device virtio-net-pci,netdev=net0 \
      -fw_cfg name=opt/org.opensuse.combustion/script,file=<replaceable>SCRIPT</replaceable>
      </screen>
  <para>
    Keep in mind that when &combustion; is running, it does not provide any
    feedback or output. The only indication that the configuration has been
    performed correctly is the fact that the system does not launch
    &jeosfirstboot; tool, and you can log in to the system as &rootuser; using
    the password you generated earlier.
  </para>
</topic>
