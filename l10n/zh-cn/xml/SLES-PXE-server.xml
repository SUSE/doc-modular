<?xml version="1.0"?>
<article xmlns="http://docbook.org/ns/docbook" version="5.2" xml:id="sles-pxe-server-setup" xml:lang="zh-cn">
  <info>
    <title xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude">在 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 上设置 PXE 引导服务器</title>
    <revhistory xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xml:id="rh-sles-pxe-server-setup">
      <revision>
        <date>2025-11-04</date>
        <revdescription>
          <para>
              初始版本
            </para>
        </revdescription>
      </revision>
    </revhistory>
    <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/> <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" name="architecture">
      <phrase>AMD64/Intel 64</phrase>
      <phrase>AArch64</phrase>
    </meta> <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" name="productname" its:translate="no">
      <productname version="16.0">
        <phrase>
          <phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase>
        </phrase>
      </productname>
    </meta>
    <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" name="title" its:translate="yes">在 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 上设置 PXE 引导服务器</meta>
    <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" name="description" its:translate="yes">如何使用 GRUB 2、nginx 和 Agama 安装程序映像配置 PXE 启动服务器</meta>
    <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" name="social-descr" its:translate="yes">使用 GRUB 2 和 Agama 设置 PXE 启动服务器</meta>
    <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" name="category" its:translate="no">
      <phrase>Deployment &amp; Upgrade</phrase>
    </meta> <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" name="task" its:translate="no">
      <phrase>Configuration</phrase>
      <phrase>Installation</phrase>
    </meta> <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" name="series" its:translate="no">Products &amp; Solutions</meta>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude">
      <dm:bugtracker>
        <dm:url>https://bugzilla.suse.com/enter_bug.cgi</dm:url>
        <dm:component>Documentation</dm:component>
        <dm:product>SUSE Linux Enterprise Server 16.0</dm:product>
        <dm:assignee>souvik.sarkar@suse.com</dm:assignee>
      </dm:bugtracker>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
    <abstract xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude">
      <variablelist>
        <varlistentry>
          <term>内容</term>
          <listitem>
            <para>
                设置支持 UEFI 安全引导和 Agama 安装程序的 PXE 引导服务器。
              </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>原因</term>
          <listitem>
            <para>
                通过网络自动完成多个 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 系统的安装，简化安装流程。
              </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>工作量</term>
          <listitem>
            <para>
                系统或网络管理员阅读并理解本文通常需要 30 至 45 分钟。
              </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>目标</term>
          <listitem>
            <para>
                打造一台可运行的 PXE 服务器，能将多种体系结构的设备引导至 Agama 安装程序。
              </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>要求</term>
          <listitem>
            <itemizedlist>
              <listitem>
                <para>
                    具备管理员权限的 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 系统
                  </para>
              </listitem>
              <listitem>
                <para>
                    用于获取 ISO 映像的互联网连接
                  </para>
              </listitem>
              <listitem>
                <para>
                    PXE 服务器的静态 IP 配置
                  </para>
              </listitem>
            </itemizedlist>
          </listitem>
        </varlistentry>
      </variablelist>
    </abstract>
  </info>
  <section role="concept" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-introduction">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion"><phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 的 PXE 引导概述</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        PXE 引导可使计算机通过网络引导至安装或运行时环境，而无需本地存储设备。本章将介绍 PXE 在 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> Agama 及实时安装程序映像中的工作原理，重点说明 GRUB 2 的相关配置。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-what-is">
      <title>PXE 引导是什么？</title>
      <para>
      PXE（预引导执行环境）是一种让系统通过 DHCP 和 TFTP/HTTP 从网络服务器检索引导加载程序和操作系统安装程序的方法。它广泛用于无需物理媒体或预安装操作系统的计算机配置场景。
    </para>
    </section>
    <section xml:id="sles-pxe-server-benefits">
      <title>PXE 引导的优势</title>
      <para>
      PXE 引导无需本地安装媒体或手动设置，简化了计算机配置流程，具体优势包括：
    </para>
      <itemizedlist>
        <listitem>
          <para>
          通过网络以无人值守的方式安装许多系统
        </para>
        </listitem>
        <listitem>
          <para>
          集中管理安装程序版本和引导配置
        </para>
        </listitem>
        <listitem>
          <para>
          支持多种体系结构和固件类型，包括 UEFI 安全引导
        </para>
        </listitem>
        <listitem>
          <para>
          通过 GRUB 2 菜单动态选择安装程序或安装参数
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-how-it-works">
      <title><phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 中 PXE 引导的工作原理</title>
      <para>
      <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 中的 PXE 引导使用 GRUB 2 作为引导加载程序，使用 Agama 作为安装界面。导加载程序和安装程序文件通过 HTTP 或 TFTP 协议从网络提供，其中 GRUB 2 负责获取内核、initrd 和实时映像。PXE 客户端可根据其体系结构（如 AMD64/Intel 64、AArch64、ppc64le、s390x）的需求，使用多种固件（包括常用的 BIOS 或 UEFI）、引导加载程序可执行文件或映像格式。此外，此类客户端必须支持在 IPv4 和 IPv6 两种网络环境中运行。
    </para>
      <para>
      引导加载程序会传递内核参数（如 <literal>root=live:</literal>），用于从实时 ISO 映像加载基于 squashfs 的根文件系统，进而启动 Agama 界面 - 该界面既可以在本地运行，也可以作为 Web 服务运行，以支持远程 Web UI 操作。
    </para>
      <section xml:id="sles-pxe-server-backward-compatibility-with-sle-15">
        <title>与 <phrase><phrase os="sles">SLES</phrase></phrase> 15.x 的向后兼容性</title>
        <para>
        本文信息主要适用于 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> 16.0 及更高版本，重点介绍与 Agama 安装程序集成、依赖实时安装映像的 PXE 引导流程。在本文的背景与讨论范围内，<phrase><phrase os="sles">SLES</phrase></phrase> 16.0 及更高版本与 <phrase><phrase os="sles">SLES</phrase></phrase> 15.x 存在以下差异：
      </para>
        <variablelist>
          <varlistentry>
            <term>安装程序</term>
            <listitem>
              <para>
              使用 <literal>dracut</literal> 和 Agama，而非 <literal>linuxrc</literal> 和 YaST。
            </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term>DHCP 服务器</term>
            <listitem>
              <para>
              不再支持 ISC DHCP（2022 年已终止服务），需改用 Kea 或 dnsmasq 作为 DHCP 服务器。
            </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term>引导参数</term>
            <listitem>
              <para>
              使用 <literal>root=live:</literal> 参数加载 Agama 安装程序映像，使用可选参数 <literal>inst.install_url=</literal> 而非 <literal>install=</literal> 参数指定非默认安装储存库。
            </para>
            </listitem>
          </varlistentry>
        </variablelist>
        <para>
        引导加载程序的选择（如 GRUB 2、pxelinux 等）保持灵活性，不依赖版本。
      </para>
      </section>
      <section xml:id="sles-pxe-server-different-possible-setups">
        <title>多种可行的设置方案和步骤</title>
        <para>
        本文包含必选设置步骤以及可选或替代配置。请仅参考与您的部署相关的章节，跳过所有不适用于您部署场景的替代方案。
      </para>
        <variablelist>
          <varlistentry>
            <term>必选步骤</term>
            <listitem>
              <para>
              所有设置场景下，均须完成以下任务：安装组件、准备安装程序映像、配置 GRUB 2 以及验证服务器。
            </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term>文件分发方式</term>
            <listitem>
              <para>
              使用 HTTP 服务器（推荐与 Agama 搭配使用，如 <literal>nginx</literal>）和/或 TFTP 服务器（如 <literal>tftp</literal> 或 <literal>dnsmasq</literal>）。
            </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term>DHCP 服务器</term>
            <listitem>
              <para>
              选择 Kea 或 dnsmasq。
            </para>
              <note>
                <title>所选方案的局限性和特性</title>
                <itemizedlist>
                  <listitem>
                    <para>
                    <emphasis role="strong">Kea</emphasis> 是 ISC 推出的新一代 DHCP 服务器，可作为 ISC DHCP 的现代化替代方案。有关 Kea 的详细信息，请访问 <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://www.isc.org/kea/"/>。有关 ISC DHCP 终止服务的通知，请访问 <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://www.isc.org/dhcp/"/>。Kea 只是 DHCP 服务器，需搭配单独的 TFTP 服务器软件使用。Kea DHCP 服务器支持通过 IPv4 和 IPv6 实现 TFTP/PXE 引导的相关选项，也支持通过 IPv4 实现 HTTP 引导的选项。通过 IPv6 实现 HTTP 引导时，要求 DHCPv6 服务器能够向客户端返回 <literal>Vendor Class Option</literal>（请参见 <literal>RFC3315, Section 22.16</literal>，该信息用于供<quote>客户端标识供应商</quote>），目前暂不支持此功能。
                  </para>
                  </listitem>
                  <listitem>
                    <para><emphasis role="strong">dnsmasq</emphasis> 集 DNS 服务器、DHCP 服务器和 TFTP 服务器于一体。您可以使用它通过 TFTP 提供引导加载程序、内核、initrd 及其他文件。有关 dnsmasq 的详细信息，请访问 <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://thekelleys.org.uk/dnsmasq/doc.html"/>。dnsmasq DHCP 服务器支持通过 IPv4 和 IPv6 实现 TFTP/PXE 引导的相关选项，也支持通过 IPv4 实现 HTTP 引导的选项。通过 IPv6 实现 HTTP 引导时，要求 DHCPv6 服务器能够向客户端返回 <literal>Vendor Class Option</literal>（请参见 <literal>RFC3315, Section 22.16</literal>，该信息用于<quote>供客户端标识供应商</quote>），目前暂不支持此功能。
                  </para>
                  </listitem>
                </itemizedlist>
              </note>
            </listitem>
          </varlistentry>
        </variablelist>
        <figure xml:id="sles-pxe-server-setup-workflow">
          <title>PXE 服务器设置流程示例</title>
          <mediaobject>
            <imageobject role="html">
              <imagedata fileref="sles-pxe-server-setup-workflow.svg"/>
            </imageobject>
            <imageobject role="fo">
              <imagedata fileref="sles-pxe-server-setup-workflow.svg" width="85%"/>
            </imageobject>
            <textobject role="description">
              <phrase>设置 PXE 引导服务器的流程图</phrase>
            </textobject>
          </mediaobject>
        </figure>
      </section>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-prepare-network">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">为 PXE 引导服务准备网络</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍在 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 上部署 PXE 引导服务需要满足的网络基础架构要求。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-network-configuration-introduction">
      <title>简介</title>
      <para>
      PXE 服务器包含三类服务器：提供地址和引导文件（引导加载程序）位置的 DHCP 服务器，以及用于检索文件的 TFTP 和/或 HTTP 服务器。此外，可能还需要 DNS 服务器、NTP 服务器和支持 IPv6 的路由器 — 在生产环境网络中，这些服务器通常与 PXE 服务器分开部署。对于运行 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 的 PXE 服务器，可能还需进行特定的网络接口配置、在防火墙中添加特定的持久化规则，以及配置 <systemitem>SELinux</systemitem> 的相关权限。本章将以示例形式展示一个包含合适 IP 范围的网络环境，并说明防火墙和 SELinux 所需的必要规则。
    </para>
    </section>
    <section xml:id="sles-pxe-server-network-configuration">
      <title>假设和网络配置示例</title>
      <para>
      本文假设：
    </para>
      <itemizedlist>
        <listitem>
          <para>
          PXE 服务器在 <literal>eno1</literal> 网络接口上运行，网络配置如下：
        </para>
          <table frame="all">
            <title>PXE 网络配置示例</title>
            <tgroup cols="4">
              <colspec colname="c1"/>
              <colspec colname="c2"/>
              <colspec colname="c3"/>
              <colspec colname="c4"/>
              <thead>
                <row>
                  <entry/>
                  <entry>IPv4</entry>
                  <entry>IPv6</entry>
                  <entry>DNS 名称</entry>
                </row>
              </thead>
              <tbody>
                <row>
                  <entry>PXE 网络</entry>
                  <entry>192.168.1.0/24</entry>
                  <entry>2001:db8:0:1::/64</entry>
                  <entry>example.net</entry>
                </row>
                <row>
                  <entry>PXE 服务器</entry>
                  <entry>192.168.1.200</entry>
                  <entry>2001:db8:0:1::200</entry>
                  <entry>pxe.example.net</entry>
                </row>
                <row>
                  <entry>PXE 网关</entry>
                  <entry>192.168.1.1</entry>
                  <entry>2001:db8:0:1::1</entry>
                  <entry/>
                </row>
                <row>
                  <entry>DNS 服务器</entry>
                  <entry>192.168.1.200</entry>
                  <entry>2001:db8:0:1::200</entry>
                  <entry/>
                </row>
                <row>
                  <entry>NTP 服务器</entry>
                  <entry>192.168.1.1</entry>
                  <entry>2001:db8:0:1::1</entry>
                  <entry/>
                </row>
              </tbody>
            </tgroup>
          </table>
        </listitem>
        <listitem>
          <para>
          默认情况下，路由器、NTP 服务器和 DNS 服务器为外部服务器，运行在其他计算机上。本文会提供一些提示，但不包含其完整配置。
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-firewall-selinux">
      <title>为 PXE 服务配置网络接口、防火墙和 <systemitem>SELinux</systemitem></title>
      <para>
      配置网络接口和防火墙，以允许 PXE 服务器所需的网络服务。调整 <systemitem>SELinux</systemitem> 设置，以支持安装测试并定义持久的本地策略。
    </para>
      <procedure>
        <step>
          <para>
          验证 PXE 网络接口并将其分配到适当的 firewalld 区域。
        </para>
          <substeps>
            <step>
              <para>
              查看当前活跃的区域及其分配到的接口：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --get-active-zones</command></screen>
            </step>
            <step>
              <para>
              如果 <literal>eno1</literal> 未分配到 <literal>public</literal> 区域，请将其分配到该区域：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --zone=public --change-interface=eno1</command></screen>
            </step>
            <step>
              <para>
              使接口分配在系统重引导后仍生效：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --permanent --zone=public --add-interface=eno1</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          配置防火墙以允许访问 DNS 服务。
        </para>
          <substeps>
            <step>
              <para>
              向当前会话开放 DNS 服务访问权限：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --zone=public --add-service=dns</command></screen>
            </step>
            <step>
              <para>
              使该更改持久生效：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --permanent --zone=public --add-service=dns</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          配置防火墙以允许访问 NTP 服务。
        </para>
          <substeps>
            <step>
              <para>
              向当前会话开放 NTP 服务访问权限：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --zone=public --add-service=ntp</command></screen>
            </step>
            <step>
              <para>
              使该更改持久生效：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --permanent --zone=public --add-service=ntp</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          配置防火墙以允许访问 DHCP (IPv4) 服务。
        </para>
          <substeps>
            <step>
              <para>
              向当前会话开放 DHCP 服务访问权限：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --zone=public --add-service=dhcp</command></screen>
            </step>
            <step>
              <para>
              使该更改持久生效：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --permanent --zone=public --add-service=dhcp</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          配置防火墙以允许访问 DHCPv6 服务。
        </para>
          <substeps>
            <step>
              <para>
              向当前会话开放 DHCPv6 服务访问权限：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --zone=public --add-service=dhcpv6</command></screen>
            </step>
            <step>
              <para>
              使该更改持久生效：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --permanent --zone=public --add-service=dhcpv6</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          配置防火墙以允许访问 TFTP 服务。
        </para>
          <substeps>
            <step>
              <para>
              向当前会话开放 TFTP 服务访问权限：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --zone=public --add-service=tftp</command></screen>
            </step>
            <step>
              <para>
              使该更改持久生效：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --permanent --zone=public --add-service=tftp</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          配置防火墙以允许访问 HTTP 服务。
        </para>
          <substeps>
            <step>
              <para>
              向当前会话开放 HTTP 服务访问权限：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --zone=public --add-service=http</command></screen>
            </step>
            <step>
              <para>
              使该更改持久生效：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --permanent --zone=public --add-service=http</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          配置防火墙以允许访问 HTTPS 服务。
        </para>
          <substeps>
            <step>
              <para>
              向当前会话开放 HTTPS 服务访问权限：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --zone=public --add-service=https</command></screen>
            </step>
            <step>
              <para>
              使该更改持久生效：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --permanent --zone=public --add-service=https</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          临时禁用 <systemitem>SELinux</systemitem> 以进行设置测试。
        </para>
          <substeps>
            <step>
              <para>
              将 <systemitem>SELinux</systemitem> 设置为宽松模式：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>setenforce 0</command></screen>
            </step>
            <step>
              <para>
              检查 <systemitem>SELinux</systemitem> 状态：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>sestatus</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          生成并安装与 PXE 相关的服务的本地 <systemitem>SELinux</systemitem> 策略模块。
        </para>
          <substeps>
            <step>
              <para>
              为 <literal>nginx</literal> 创建并安装模块：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>if test `ausearch -c 'nginx' --raw | wc -l` -gt 0 ; then</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>  ausearch -c 'nginx' --raw | audit2allow -a -M local-nginx</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>  semodule -i local-nginx.pp</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>fi</command></screen>
            </step>
            <step>
              <para>
              为 <literal>dnsmasq</literal> 创建并安装模块：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>if test `ausearch -c 'dnsmasq' --raw | wc -l` -gt 0 ; then</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>  ausearch -c 'dnsmasq' --raw | audit2allow -a -M local-dnsmasq</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>  semodule -i local-dnsmasq.pp</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>fi</command></screen>
            </step>
            <step>
              <para>
              为 <literal>in.tftpd</literal> 创建并安装模块：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>if test `ausearch -c 'in.tftpd' --raw | wc -l` -gt 0 ; then</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>  ausearch -c 'in.tftpd' --raw | audit2allow -a -M local-tftpd</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>  semodule -i local-tftpd.pp</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>fi</command></screen>
            </step>
          </substeps>
        </step>
        <step>
          <para>
          重新启用 <systemitem>SELinux</systemitem> 强制模式。
        </para>
          <substeps>
            <step>
              <para>
              将 <systemitem>SELinux</systemitem> 设置为强制模式：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>setenforce 1</command></screen>
            </step>
            <step>
              <para>
              验证 <systemitem>SELinux</systemitem> 状态：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>sestatus</command></screen>
            </step>
          </substeps>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-firewall-selinux-summary">
      <title>总结</title>
      <para>
      通过上述过程，您已正确配置 PXE 服务器的网络接口、防火墙和 <systemitem>SELinux</systemitem> 策略，确保服务器能安全且正常运行，具体包括：
    </para>
      <itemizedlist>
        <listitem>
          <para>
          验证 PXE 服务接口（本示例中为 <filename>eno1</filename>）并将其分配到 firewalld 的 <literal>public</literal> 区域。
        </para>
        </listitem>
        <listitem>
          <para>
          开放 PXE 运行所需的防火墙服务，包括 <literal>dns</literal>、<literal>ntp</literal>、<literal>dhcp</literal>、<literal>dhcpv6</literal>、<literal>tftp</literal>、<literal>http</literal> 和 <literal>https</literal>。
        </para>
        </listitem>
        <listitem>
          <para>
          临时将 <systemitem>SELinux</systemitem> 设置为 <literal>permissive</literal> 模式，以便进行服务测试并记录 AVC 拒绝信息。
        </para>
        </listitem>
        <listitem>
          <para>
          使用 <command>ausearch</command> 和 <command>audit2allow</command> 生成并安装针对 <systemitem>nginx</systemitem>、<systemitem>dnsmasq</systemitem>、<systemitem>in.tftpd</systemitem> 等服务的自定义 SELinux 策略模块。
        </para>
        </listitem>
        <listitem>
          <para>
          将 <systemitem>SELinux</systemitem> 恢复为 <literal>enforcing</literal> 模式，确保系统适合生产环境使用。
        </para>
        </listitem>
      </itemizedlist>
      <para>
      完成以上步骤后，PXE 服务器已完成安全配置，可通过 IPv4 或 IPv6 网络为客户端计算机提供服务。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-install-components">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">安装所需的 PXE 服务器组件</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何在 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 中安装支持 PXE 引导所需的软件包，包括 GRUB 2、DHCP、TFTP 和/或 HTTP 组件。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-install-components-intro">
      <title>简介</title>
      <para>
      要在 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 上配置 PXE 引导服务器，需要安装多个服务和工具。根据具体设置情况，可能需要以下组件：
    </para>
      <itemizedlist>
        <listitem>
          <para>
          <package>dnsmasq</package> 软件包：集成了 DNS 服务器、TFTP 服务器和 DHCP 服务器（支持 DHCPv4 和 DHCPv6），同时对 IPv6 路由器通告 (RA) 提供有限支持。具体功能包括：
        </para>
          <itemizedlist>
            <listitem>
              <para>
              dnsmasq DHCP 服务器：支持根据请求和客户端体系结构有条件地传递 DHCP 选项，适用于：
            </para>
              <itemizedlist>
                <listitem>
                  <para>
                  使用 DHCPv4 和 DHCPv6 的 PXE 引导请求
                </para>
                </listitem>
                <listitem>
                  <para>
                  使用 DHCPv4 的 HTTP 引导请求
                </para>
                  <note>
                    <title>dnsmasq 通过 DHCPv6 实现 HTTP 引导的局限性</title>
                    <para>
                    目前，dnsmasq 不支持发送 HTTP 引导所需的 <literal>vendor-class</literal> DHCPv6 选项。
                  </para>
                  </note>
                </listitem>
              </itemizedlist>
            </listitem>
            <listitem>
              <para>
              dnsmasq TFTP 服务器：在 PXE 引导过程中，通过 TFTP 提供引导加载程序文件、内核和 initrd。
            </para>
            </listitem>
            <listitem>
              <para>
              dnsmasq DNS 服务器：为客户端固件和安装程序/操作系统中的 <filename>/etc/resolv.conf</filename> 提供域名及 IP 地址的递归解析服务。
            </para>
            </listitem>
            <listitem>
              <para>
              dnsmasq IPv6 RA：当 PXE 服务器同时作为路由器时，支持发送 IPv6 RA（配置能力仅限于<quote>通用 RA 模式</quote>）。
            </para>
            </listitem>
          </itemizedlist>
        </listitem>
        <listitem>
          <para>
          <package>kea</package> 软件包：一款 DHCP 服务器，是 ISC DHCP 服务器的继任者，支持根据请求和客户端体系结构有条件传递 DHCP 选项，适用于：
        </para>
          <itemizedlist>
            <listitem>
              <para>
              使用 DHCPv4 和 DHCPv6 的 PXE 引导请求
            </para>
            </listitem>
            <listitem>
              <para>
              使用 DHCPv4 的 HTTP 引导请求
            </para>
              <note>
                <title>Kea 通过 DHCPv6 实现 HTTP 引导的局限性</title>
                <para>
                目前，Kea 不支持发送 HTTP 引导所需的 <literal>vendor-class</literal> DHCPv6 选项。有关详细信息，请访问 <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://kea.readthedocs.io/en/latest/arm/dhcp6-srv.html#id4"/>。
              </para>
              </note>
            </listitem>
          </itemizedlist>
        </listitem>
        <listitem>
          <para>
          TFTP 服务器：通过 TFTP 提供引导加载程序文件、内核和 initrd；搭配 kea 实现 PXE 引导时，需通过 <package>tftp</package> 软件包提供 TFTP 功能，而 HTTP 引导无需此组件。如果使用 <package>dnsmasq</package>，则无需安装 <package>tftp</package> 软件包。
        </para>
        </listitem>
        <listitem>
          <para>
          Web 服务器：如 <package>nginx</package> 软件包，通过 HTTP 提供安装程序映像。
        </para>
          <note>
            <title>HTTP 服务器的必要性</title>
            <para>
            几乎所有安装场景都需要 nginx 这类 HTTP/HTTPS 服务器。其用途不仅限于 HTTP 引导，尤其在以下场景中必不可少：
          </para>
            <itemizedlist>
              <listitem>
                <para>
                是 HTTP 引导的基本要求。
              </para>
              </listitem>
              <listitem>
                <para>
                建议使用它来提供 <filename>squashfs.img</filename>。可在引导命令行中使用 <literal>root=live:tftp://.../squashfs.img</literal>。
              </para>
              </listitem>
              <listitem>
                <para>
                对于 <filename>SLES-16.0-Full-*.inline.iso</filename>，如果需通过 <literal>inst.install_url=http://.../install/</literal> 引导命令行参数向 Agama 提供 RPM 软件包，同时提供安装配置文件及其他用于无人值守安装的文件，也建议使用 HTTP 服务器。
              </para>
              </listitem>
            </itemizedlist>
          </note>
        </listitem>
        <listitem>
          <para>
          GRUB 2 引导加载程序软件包：为支持的体系结构和引导方式提供网络引导功能。例如，AMD64/Intel 64 体系结构支持 BIOS 和 UEFI 两种网络引导方式。此外，UEFI 通常支持 PXE (TFTP) 和 HTTP 引导。pxelinux 等其他引导加载程序不支持 UEFI 和 HTTP 引导。
        </para>
        </listitem>
        <listitem>
          <para>
          可选组件：IPv6 路由器通告守护程序（如 <package>radvd</package> 软件包）。如果 <phrase><phrase os="sles">SLES</phrase></phrase> 同时作为安装程序网络的路由器，则需安装此组件，以实现以下功能：
        </para>
          <itemizedlist>
            <listitem>
              <para>
              为 PXE 或 HTTP 引导客户端配置网络路由。
            </para>
            </listitem>
            <listitem>
              <para>
              允许 PXE 或 HTTP 引导客户端在网络上使用 DHCPv6。
            </para>
            </listitem>
          </itemizedlist>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-install-components-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          运行 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 且具备管理员权限的系统，已在 SUSE Customer Center 中注册，并通过 SUSEConnect 配置了对相应在线储存库的访问权限。
        </para>
        </listitem>
        <listitem>
          <para>
          已启用以下 SLE 模块：Server Applications Module、Legacy Module 和 Base System Module。
        </para>
        </listitem>
        <listitem>
          <para>
          可访问用于获取网络服务和引导加载程序的 SLE 模块储存库。
        </para>
        </listitem>
        <listitem>
          <para>
          可正常连接互联网以获取软件包。
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-install-components-exec">
      <title>安装软件包</title>
      <para>
      按以下步骤安装 PXE 引导服务器所需的核心软件包。
    </para>
      <procedure>
        <title>安装 PXE 引导服务器所需的必要软件包</title>
        <step>
          <para>
          安装 GRUB 2 引导加载程序和 nginx HTTP 服务器（通用要求）。
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install grub2 nginx</command></screen>
        </step>
        <step>
          <para>
          根据您的方案，运行以下任一命令安装必要软件包：
        </para>
          <stepalternatives>
            <step>
              <para>如果使用 <package>kea</package> 作为 DHCP 服务器、<package>tftp</package> 作为 TFTP 服务器，请运行：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install kea tftp</command></screen>
            </step>
            <step>
              <para>如果使用 <package>dnsmasq</package> 同时提供 DHCP、DNS 和 TFTP 服务，请运行：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install dnsmasq</command></screen>
            </step>
          </stepalternatives>
          <note>
            <title>Kea 和 dnsmasq 提供的 DHCP 服务器的局限性</title>
            <para>
            <emphasis>目前</emphasis>，<package>kea</package> 和 <package>dnsmasq</package> 软件包提供的 DHCP 服务器不支持通过 IPv6 实现 HTTP 引导，无法按照 UEFI 规范要求，向 HTTP 客户端返回 <literal>vendor-class</literal> 选项。
          </para>
          </note>
        </step>
        <step>
          <para>
          （可选）如果计划支持其他平台，可安装额外的体系结构专用 GRUB 2 目标。
        </para>
          <stepalternatives>
            <step>
              <para>
              对于 AMD64/Intel 64 体系结构：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install grub2-x86_64-efi grub2-i386-pc</command></screen>
            </step>
            <step>
              <para>
              对于 AArch64 体系结构：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install grub2-aarch64-efi</command></screen>
            </step>
            <step>
              <para>
              对于 ppc64le 体系结构：
            </para>
              <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install grub2-ppc64le-ieee1275</command></screen>
            </step>
          </stepalternatives>
          <note>
            <title>PXE 服务器如何向与自身体系结构不同的客户端提供 GRUB 2 软件包</title>
            <para>
            无论 PXE 服务器所在计算机使用的是哪种体系结构，GRUB 2 各体系结构专用的 <package>noarch.rpm</package> 软件包均包含在安装媒体/储存库的 <filename>noarch</filename> 子目录中。例如，可在运行于 AMD64/Intel 64 计算机上的 PXE 服务器上，安装 <package>grub2-arm64-efi</package> 和 <package>grub2-powerpc-ieee1275</package> 软件包，以支持其他体系结构的客户端。
          </para>
          </note>
        </step>
        <step>
          <para>
          （可选）如果需要为 AMD64/Intel 64 或 AArch64 启用 UEFI 安全引导，但不希望使用安装媒体 ISO 中的文件，可安装 <package>shim</package> 软件包。
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install shim</command></screen>
        </step>
        <step>
          <para>
          （可选）如果希望将 PXE 服务器用作路由器（不推荐用于生产环境网络），可安装路由器通告守护程序 <package>radvd</package>。
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install radvd</command></screen>
        </step>
        <step>
          <para>
          安装 <package>rsync</package> 实用程序，以便便捷地复制或同步 ISO 和目录树。
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install rsync</command></screen>
        </step>
        <step>
          <para>
          确保服务已安装但尚未启动。后续章节将介绍具体配置。
        </para>
        </step>
      </procedure>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-netboot-directories-uefi-secure-boot">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">为 PXE 服务器创建 GRUB 2 网络引导目录</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何使用 <command>grub2-mknetdir</command> 命令为 PXE 服务器创建 GRUB 2 网络引导目录，该命令会为 AMD64/Intel 64（UEFI 和 BIOS）、AArch64 和 ppc64le 系统生成体系结构专用目录。如果需要支持 UEFI 安全引导，管理员必须从安装媒体复制已签名的 EFI 文件，或使用 <package>shim</package> 软件包替换默认的未签名引导加载程序文件。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-netboot-directories-uefi-secure-boot-introduction">
      <title>简介</title>
      <para>
      本章介绍如何为多体系结构 PXE 服务器部署设置 GRUB 2 网络引导目录。<command>grub2-mknetdir</command> 命令会在 <filename>/srv/tftpboot/boot/grub2/</filename> 下为不同平台创建体系结构专用目录。例如，AMD64/Intel 64 系统会生成 UEFI (<filename>x86_64-efi</filename>) 和传统 BIOS (<filename>i386-pc</filename>) 目录，AArch64 和 ppc64le 系统会创建各自的 UEFI 目录（<filename>arm64-efi</filename> 和 <filename>powerpc-ieee1275</filename>）。
    </para>
      <para>
      默认的未签名 <filename>core.efi</filename> 文件不支持 UEFI 安全引导，如果需要支持此功能，管理员可从安装媒体复制已签名的 EFI 文件，或安装 <package>shim</package> 软件包并手动将所需的引导加载程序文件（<filename>shim.efi</filename>、<filename>grub.efi</filename>、<filename>MokManager.efi</filename>）复制到适当的体系结构目录，同时确保符号链接能正确解析，使所有文件均位于 TFTP 根目录内。
    </para>
    </section>
    <section xml:id="sles-pxe-server-netboot-directories-uefi-secure-boot-requirements">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已安装以下软件包：<package>grub2</package>、<package>tftp</package>，以及所有其他体系结构专用的 GRUB 2 软件包（如 <package>grub2-x86_64-efi</package>、<package>grub2-i386-pc</package>）。
        </para>
        </listitem>
        <listitem>
          <para>
          已准备好用于挂载的安装媒体 (ISO)，或系统上已安装 <package>shim</package> 软件包。可从 SUSE Customer Center 下载目标体系结构的安装媒体 (ISO)。
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-netboot-directories-uefi-secure-boot-executing">
      <title>准备网络引导目录和 UEFI 安全引导</title>
      <para>
      以下过程将创建 PXE 网络引导所需的 GRUB 2 目录结构，并可选择性地为多体系结构配置 UEFI 安全引导支持。
    </para>
      <procedure>
        <step>
          <para>
          创建 GRUB 2 网络引导目录结构。
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>grub2-mknetdir --net-directory=/srv/tftpboot
--subdir=/boot/grub2</command></screen>
          <para>
          此命令会创建体系结构专用目录：
        </para>
          <itemizedlist>
            <listitem>
              <para>
              AMD64/Intel 64：<filename>/srv/tftpboot/boot/grub2/x86_64-efi</filename> 和 <filename>/srv/tftpboot/boot/grub2/i386-pc </filename>
            </para>
            </listitem>
            <listitem>
              <para>
              AArch64：<filename>/srv/tftpboot/boot/grub2/arm64-efi</filename>
            </para>
            </listitem>
            <listitem>
              <para>
              ppc64le：<filename>/srv/tftpboot/boot/grub2/powerpc-ieee1275</filename>
            </para>
            </listitem>
          </itemizedlist>
          <warning>
            <para>
            请勿手动覆盖 <command>grub2-mknetdir</command> 命令创建的 <filename>grub.cfg</filename> 文件。
          </para>
          </warning>
        </step>
        <step>
          <para>
          将 <filename>/srv/tftpboot/boot/grub2/</filename> 目录下可用的其他体系结构无关目录（如 <filename>fonts/</filename>、<filename>locale/</filename>）复制到 TFTP 服务器。
        </para>
        </step>
        <step>
          <para>
          AMD64/Intel 64 或 AArch64 体系结构也可使用 <command>grub2-mknetdir</command> 命令安装的 <filename>/srv/tftpboot/boot/grub2/<replaceable>ARCH</replaceable>-efi/core.efi</filename> 文件进行 UEFI PXE 引导，但这些文件<emphasis>未签名</emphasis>，不支持 UEFI 安全引导。如需为支持的 AMD64/Intel 64 和 AArch64 体系结构选择性启用 UEFI 安全引导，可执行以下任一步骤：
        </para>
          <stepalternatives>
            <step>
              <para>
              从安装媒体 ISO 复制必要文件：
            </para>
              <substeps>
                <step>
                  <para>
                  挂载 ISO 映像。
                </para>
                  <screen><prompt>&gt; </prompt><command>sudo</command><command>mount -o loop /PATH/TO/SLES.ISO /mnt</command></screen>
                </step>
                <step>
                  <para>
                  复制 EFI 文件。
                </para>
                  <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v /mnt/EFI/BOOT/*.efi
/srv/tftpboot/boot/grub2/<replaceable>ARCH</replaceable>-efi/</command><co xml:id="copy-efi-files"/></screen>
                  <calloutlist>
                    <callout arearefs="copy-efi-files">
                      <para>
                      将 <filename><replaceable>ARCH</replaceable>-efi</filename> 替换为 <filename>x86_64-efi</filename> 或 <filename>arm64-efi</filename>（支持 UEFI 安全引导的体系结构）。
                    </para>
                    </callout>
                  </calloutlist>
                </step>
                <step>
                  <para>
                  卸载安装媒体 ISO。
                </para>
                  <screen><prompt>&gt; </prompt><command>sudo</command><command>umount /mnt</command></screen>
                </step>
              </substeps>
            </step>
            <step>
              <para>
              如果不希望使用安装媒体 ISO 中的文件，可使用 <package>shim</package> 软件包：
            </para>
              <substeps>
                <step>
                  <para>
                  如果尚未安装 <package>shim</package> 软件包，先执行安装。
                </para>
                  <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install shim</command></screen>
                </step>
                <step>
                  <para>
                  为所需体系结构复制已签名的引导加载程序文件：
                </para>
                  <substeps>
                    <step>
                      <para>
                      复制 <filename>shim.efi</filename> 文件。
                    </para>
                      <stepalternatives>
                        <step>
                          <para>
                          对于 AMD64/Intel 64 体系结构：
                        </para>
                          <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v -p -L /usr/share/efi/x86_64/shim.efi /srv/tftpboot/boot/grub2/x86_64-efi/bootx64.efi</command></screen>
                        </step>
                        <step>
                          <para>
                          对于 AArch64 体系结构：
                        </para>
                          <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v -p -L /usr/share/efi/aarch64/shim.efi /srv/tftpboot/boot/grub2/arm64-efi/bootaa64.efi</command></screen>
                        </step>
                      </stepalternatives>
                    </step>
                    <step>
                      <para>
                      复制 <filename>grub.efi</filename> 文件。
                    </para>
                      <stepalternatives>
                        <step>
                          <para>
                          对于 AMD64/Intel 64 体系结构：
                        </para>
                          <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v -p -L /usr/share/efi/x86_64/grub.efi /srv/tftpboot/boot/grub2/x86_64-efi/</command></screen>
                        </step>
                        <step>
                          <para>
                          对于 AArch64 体系结构：
                        </para>
                          <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v -p -L /usr/share/efi/aarch64/grub.efi /srv/tftpboot/boot/grub2/arm64-efi/</command></screen>
                        </step>
                      </stepalternatives>
                    </step>
                    <step>
                      <para>
                      复制 <filename>MokManager.efi</filename> 文件。
                    </para>
                      <stepalternatives>
                        <step>
                          <para>
                          对于 AMD64/Intel 64 体系结构：
                        </para>
                          <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v -p -L /usr/share/efi/x86_64/MokManager.efi /srv/tftpboot/boot/grub2/x86_64-efi/</command></screen>
                        </step>
                        <step>
                          <para>
                          对于 AArch64 体系结构：
                        </para>
                          <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v -p -L /usr/share/efi/aarch64/MokManager.efi /srv/tftpboot/boot/grub2/arm64-efi/</command></screen>
                        </step>
                      </stepalternatives>
                    </step>
                  </substeps>
                  <note>
                    <para>
                    <literal>-L</literal> 标志用于解析符号链接，确保文件均位于 TFTP 根目录内。
                  </para>
                  </note>
                </step>
              </substeps>
            </step>
          </stepalternatives>
        </step>
      </procedure>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-prepare-installer">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">准备安装程序映像内容</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何从 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 安装媒体中提取并整理 PXE 引导环境所需的安装程序文件。内容涵盖 <literal>.install.iso</literal> 映像和 RPM 软件包两种提取方式，并提供针对不同体系结构和安装类型的具体说明。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-prepare-installer-intro">
      <title>简介</title>
      <para><phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase><phrase><phrase os="sles">16.0</phrase></phrase> 提供多种格式的安装程序文件，以支持不同的 PXE 引导场景。Agama 安装程序需要三个必要文件：内核映像 (<filename>linux</filename>)、initrd RAM 磁盘 (<filename>initrd</filename>) 和压缩根文件系统 (<filename>squashfs.img</filename>)。这些文件必须从安装媒体中提取，并整理到可通过 TFTP 和 HTTP 访问的目录结构中。
    </para>
      <para>
      本章将介绍从 <literal>.install.iso</literal> 映像和 RPM 软件包中提取文件的方法，确保适配 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 支持的各种体系结构和安装类型。
    </para>
    </section>
    <section xml:id="sles-pxe-server-prepare-installer-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para><phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase><phrase><phrase os="sles">16.0</phrase></phrase> 安装媒体（可从 SUSE Customer Center 获取）。可选类型如下：
        </para>
          <itemizedlist>
            <listitem>
              <para>
              在线 ISO：仅包含安装程序，用于网络安装 (<filename>SLES-16.0-Online-<replaceable>ARCH</replaceable>-<replaceable>BUILD</replaceable>.install.iso</filename>)
            </para>
            </listitem>
            <listitem>
              <para>
              完整 ISO：包含安装程序和安装储存库 (<filename>SLES-16.0-Full-<replaceable>ARCH</replaceable>-<replaceable>BUILD</replaceable>.install.iso</filename>)
            </para>
            </listitem>
            <listitem>
              <para>
              RPM 软件包：<package>tftpboot-agama-installer-SUSE_SLE_16_PXE-<replaceable>ARCH</replaceable></package>
            </para>
            </listitem>
          </itemizedlist>
        </listitem>
        <listitem>
          <para>
          临时挂载点（如 <filename>/mnt</filename>）。
        </para>
        </listitem>
        <listitem>
          <para>
          <filename>/srv/tftpboot</filename> 和 <filename>/srv/install</filename> 目录下有充足的磁盘空间（根据所选安装方式而定）。
        </para>
        </listitem>
        <listitem>
          <para>
          具备创建目录和复制文件的管理员权限。
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-prepare-installer-iso">
      <title>使用 ISO 映像准备安装程序文件</title>
      <para>
      ISO 映像提供了提取安装程序文件的简便方式。以下过程涵盖在线 ISO 和完整 ISO 两种类型，适合不同体系结构。
    </para>
      <section xml:id="sles-pxe-server-prepare-installer-iso-online">
        <title>使用在线 ISO 映像</title>
        <para>
        在线 ISO 映像仅包含安装程序组件，系统安装过程中需要通过网络访问安装储存库。与 GRUB 中的 <literal>SLES-16.0 Online Installation</literal> 引导菜单项对应。
       </para>
        <procedure xml:id="proc-prepare-online-iso-x86-aarch64">
          <title>从在线 ISO 中提取文件（适用于 x86_64 和 AArch64 体系结构）</title>
          <step>
            <para>
            创建安装程序文件的目录结构：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p /srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/</command></screen>
          </step>
          <step>
            <para>
            挂载在线 ISO 映像：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>mount -oro,loop /srv/install/iso/SLES-16.0-Online-<replaceable>ARCH</replaceable>-<replaceable>BUILD</replaceable>.install.iso /mnt</command></screen>
          </step>
          <step>
            <para>
            复制内核和 initrd 文件：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /mnt/boot/<replaceable>ARCH</replaceable>/loader/linux  /srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /mnt/boot/<replaceable>ARCH</replaceable>/loader/initrd /srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/</command></screen>
          </step>
          <step>
            <para>
            复制压缩根文件系统：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /mnt/LiveOS/squashfs.img /srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/</command></screen>
          </step>
          <step>
            <para>
            卸载 ISO 映像：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>umount /mnt</command></screen>
          </step>
        </procedure>
        <procedure xml:id="proc-prepare-online-iso-ppc64le">
          <title>从在线 ISO 中提取文件（适用于 PPC64LE 体系结构）</title>
          <step>
            <para>
            创建目录结构：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p /srv/tftpboot/boot/images/SLES-16.0/ppc64le/</command></screen>
          </step>
          <step>
            <para>
            挂载 ISO 映像：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>mount -oro,loop /srv/install/iso/SLES-16.0-Online-ppc64le-<replaceable>BUILD</replaceable>.install.iso /mnt</command></screen>
          </step>
          <step>
            <para>
            复制内核和 initrd 文件（注意 ppc64le 体系结构的路径结构不同）：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /mnt/boot/ppc64le/linux /srv/tftpboot/boot/images/SLES-16.0/ppc64le/</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /mnt/boot/ppc64le/initrd /srv/tftpboot/boot/images/SLES-16.0/ppc64le/</command></screen>
          </step>
          <step>
            <para>
            复制压缩根文件系统：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /mnt/LiveOS/squashfs.img /srv/tftpboot/boot/images/SLES-16.0/ppc64le/</command></screen>
          </step>
          <step>
            <para>
            卸载 ISO 映像：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>umount /mnt</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-prepare-installer-iso-full">
        <title>使用完整 ISO 映像</title>
        <para>
        完整 ISO 映像包含安装程序和安装储存库，无需依赖外部网络即可完成本地安装。与 GRUB 中的 <literal>SLES-16.0 Local Installation</literal> 引导菜单项对应，需要额外添加参数 <literal>inst.install_url=http://pxe.example.net/install/SLES-16.0/${arch}</literal>。
      </para>
        <procedure xml:id="proc-prepare-full-iso">
          <title>从完整 ISO 中提取文件</title>
          <step>
            <para>
            为安装程序文件和安装储存库创建目录：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p /srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p /srv/install/SLES-16.0</command></screen>
          </step>
          <step>
            <para>
            挂载完整 ISO 映像：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>mount -oro,loop /srv/install/iso/SLES-16.0-Full-<replaceable>ARCH</replaceable>-<replaceable>BUILD</replaceable>.install.iso /mnt</command></screen>
          </step>
          <step>
            <para>
            复制内核和 initrd 文件（ppc64le 体系结构路径需按前文所述过程调整）：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /mnt/boot/<replaceable>ARCH</replaceable>/loader/linux  /srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /mnt/boot/<replaceable>ARCH</replaceable>/loader/initrd /srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/</command></screen>
          </step>
          <step>
            <para>
            复制压缩根文件系统：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /mnt/LiveOS/squashfs.img /srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/</command></screen>
          </step>
          <step>
            <para>
            复制安装储存库，供本地 HTTP 服务器访问：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>rsync -avP /mnt/install/ /srv/install/SLES-16.0/<replaceable>ARCH</replaceable>/</command></screen>
          </step>
          <step>
            <para>
            卸载 ISO 映像：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>umount /mnt</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-prepare-installer-rpm">
      <title>使用 RPM 软件包准备安装程序文件</title>
      <para>
      RPM 软件包提供了获取在线安装程序文件的另一种方式。
    </para>
      <procedure xml:id="proc-prepare-rpm-packages">
        <title>安装并使用 tftpboot RPM 软件包</title>
        <step>
          <para>
          安装所需的软件包：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper in tftpboot-agama-installer-SUSE_SLE_16-<replaceable>ARCH</replaceable></command></screen>
        </step>
        <step>
          <para>
          将 linux、initrd、squashfs.img 复制到 tftpboot 中：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p
/srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable></command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>cd
/srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable></command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v /usr/share/tftpboot-installation/agama-installer-SUSE_SLE_16/<replaceable>ARCH</replaceable>/loader/linux .</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v /usr/share/tftpboot-installation/agama-installer-SUSE_SLE_16/<replaceable>ARCH</replaceable>/loader/initrd .</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v /usr/share/tftpboot-installation/agama-installer-SUSE_SLE_16/<replaceable>ARCH</replaceable>/loader/squashfs.img .</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-prepare-installer-dir-structure">
      <title>推荐的目录结构</title>
      <para>
      按以下目录结构整理提取的文件，以确保一致性和可维护性。该结构支持多种体系结构和安装类型。
    </para>
      <example xml:id="ex-pxe-directory-layout">
        <title>完整的 PXE 服务器目录结构</title>
        <screen>/srv/tftpboot/
├── boot/
│   ├── grub2/
│   │   ├── x86_64-efi/
│   │   │   ├── bootx64.efi
│   │   │   └── grub.cfg
│   │   ├── i386-pc/
│   │   │   └── core.0
│   │   ├── arm64-efi/
│   │   │   └── bootaa64.efi
│   │   └── powerpc-ieee1275/
│   │       └── core.elf
│   └── images/
│       └── SLES-16.0/
│           ├── x86_64/
│           │   ├── linux <co xml:id="co-kernel"/>
│           │   ├── initrd <co xml:id="co-initrd"/>
│           │   └── squashfs.img <co xml:id="co-squashfs"/>
│           ├── aarch64/
│           └── ppc64le/
/srv/install/
└── SLES-16.0/
    ├── x86_64/ <co xml:id="co-install-repo"/>
    ├── aarch64/
    └── ppc64le/</screen>
      </example>
      <calloutlist>
        <callout arearefs="co-kernel">
          <para>
          从安装媒体中提取的内核映像
        </para>
        </callout>
        <callout arearefs="co-initrd">
          <para>
          初始 RAM 磁盘映像
        </para>
        </callout>
        <callout arearefs="co-squashfs">
          <para>
          Agama 安装程序的压缩根文件系统
        </para>
        </callout>
        <callout arearefs="co-install-repo">
          <para>
          完整 ISO 中 <filename>install</filename> 目录下的安装储存库（可选）
        </para>
        </callout>
      </calloutlist>
    </section>
    <section xml:id="sles-pxe-server-prepare-installer-verify">
      <title>验证安装</title>
      <para>
      提取并整理安装程序文件后，需要验证所有必需组件是否存在且可访问。
    </para>
      <procedure xml:id="proc-verify-installer-files">
        <title>验证步骤</title>
        <step>
          <para>
          检查必要文件是否存在：
        </para>
          <screen><prompt>&gt; </prompt><command>ls -la /srv/tftpboot/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/*</command></screen>
        </step>
        <step>
          <para>
          确保文件权限正确无误：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>find /srv/tftpboot/boot/images/ -type d -exec chmod 0755 {} \;</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>find /srv/tftpboot/boot/images/ -type f -exec chmod 0644 {} \;</command></screen>
        </step>
      </procedure>
      <important>
        <title>文件可访问性</title>
        <para>
        确保所有提取的文件均可被 TFTP 和 HTTP 服务读取。PXE 客户端会在引导过程中访问这些文件，因此正确的权限和服务配置对部署成功至关重要。
      </para>
      </important>
    </section>
    <section xml:id="sles-pxe-server-prepare-installer-next">
      <title>后续步骤</title>
      <para>
      正确准备并整理安装程序文件后，可继续执行以下操作：
    </para>
      <itemizedlist>
        <listitem>
          <para>
          配置 GRUB 2 以支持 PXE 引导，在菜单项中引用这些文件
        </para>
        </listitem>
        <listitem>
          <para>
          设置 HTTP 和 TFTP 服务，以提供提取的内容
        </para>
        </listitem>
        <listitem>
          <para>
          配置 DHCP，引导 PXE 客户端使用适当的引导加载程序
        </para>
        </listitem>
      </itemizedlist>
      <para>
      GRUB 2 配置中将通过类似 <literal>root=live:http://pxe.example.net/boot/images/SLES-16.0/<replaceable>ARCH</replaceable>/squashfs.img</literal> 的路径引用提取的文件。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-configure-grub2">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">配置 GRUB 2 以支持 PXE 引导</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何在 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 上配置 GRUB 2 引导加载程序以支持 PXE 引导。内容包括创建网络引导目录结构、设置体系结构专用引导加载程序，以及实现支持多体系结构和多种安装场景的灵活配置系统。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-configure-grub2-intro">
      <title>简介</title>
      <para>
      GRUB 2 作为 PXE 客户端的网络引导加载程序，负责加载内核和 initrd 文件以启动 Agama 安装程序。本章将演示如何创建功能完善的 GRUB 2 配置：可自动检测客户端体系结构、管理网络接口选择，并提供支持多种安装类型和目标体系结构的统一引导菜单。
    </para>
      <para>
      该配置采用模块化设计，将体系结构检测、变量定义和引导菜单项分别存储在不同文件中。这样既支持针对特定计算机的配置，也支持自动化安装配置文件，同时又能在不同硬件平台间保持一致性。
    </para>
    </section>
    <section xml:id="sles-pxe-server-configure-grub2-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已按前文章节所述设置好 GRUB 2 网络引导目录结构。
        </para>
        </listitem>
        <listitem>
          <para>
          已按前文章节所述正确整理安装程序文件。
        </para>
        </listitem>
        <listitem>
          <para>
          已安装所有目标体系结构的 GRUB 2 软件包：<package>grub2-x86_64-efi</package>、<package>grub2-i386-pc</package>、<package>grub2-aarch64-efi</package> 和 <package>grub2-ppc64le-ieee1275</package>。
        </para>
        </listitem>
        <listitem>
          <para>
          已安装用于提供 UEFI 安全引导支持的 <package>shim</package> 软件包（可选）。
        </para>
        </listitem>
        <listitem>
          <para>
          具备对 <filename>/srv/tftpboot</filename> 或等效 PXE 根目录的管理员访问权限。
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-configure-grub2-main-config">
      <title>创建 GRUB 2 配置</title>
      <para>
      GRUB 2 配置文件主要负责三项任务：检测客户端体系结构、管理网络接口，以及加载其他配置文件。这种模块化设计提供了很大的灵活性，可支持不同的部署场景。
    </para>
      <procedure xml:id="proc-create-main-grub-config">
        <title>设置主 <filename>grub.cfg</filename> 文件</title>
        <step>
          <para>
          在 <filename>/srv/tftpboot/boot/grub2/grub.cfg</filename> 路径下创建 GRUB 2 主配置文件：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /srv/tftpboot/boot/grub2/grub.cfg &lt;&lt; 'EOF'</command>
# Architecture detection and mapping
if [ "$grub_cpu" == "i386" ]; then
  set arch='x86_64'
elif [ "$grub_cpu" == "x86_64" ]; then
  set arch='x86_64'
elif [ "$grub_cpu" == "arm64" ]; then
  set arch='aarch64'
elif [ "$grub_cpu" == "powerpc" ]; then
  set arch='ppc64le'
fi

if [ "X$arch" == "X" ]; then
  echo "ERROR: No architecture found for ${grub_cpu}"
  exit
else
  echo "Running on $arch CPU architecture"
fi
export arch


# Network interface configuration for PXE-selected NIC
# - dracut based images on SLE-16:
set ipcfg="ifname=pxe0:${net_default_mac} ip=pxe0:dhcp"
export ipcfg
# - linuxrc installer on SLE-15:
set ifcfg="ifcfg=${net_default_mac}=dhcp"
export ifcfg

# Define typical serial console kernel parameter
#set sconsole="console=tty0 console=ttyS0,115200n8"
#export sconsole

# Load machine-specific configuration if available
if [ -s "${config}/${net_default_mac}/grub.cfg" ]; then
  ## Source a host specific configuration of grub menu:
  source "${config}/${net_default_mac}/grub.cfg"
else
  ## Source default grub boot menu:
  source "${prefix}/menu.cfg"
fi
EOF
</screen>
        </step>
      </procedure>
      <variablelist>
        <title>关键配置元素</title>
        <varlistentry>
          <term>体系结构检测</term>
          <listitem>
            <para>
            将 GRUB 2 CPU 类型映射至发行套件体系结构，使统一的菜单项可在不同硬件平台上正常工作。
          </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>网络接口管理</term>
          <listitem>
            <para>
            使用 GRUB 2 变量 <varname>${net_default_mac}</varname> 定义 <varname>${ipcfg}</varname> 变量，仅在名为 <literal>pxe0</literal> 的 PXE 引导接口上启用 DHCP，避免多接口系统出现网络探测问题。
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>工具定义</term>
          <listitem>
            <para>
            定义包含串行控制台参数的典型 <varname>${sconsole}</varname> 变量。
          </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term>针对特定计算机的配置</term>
          <listitem>
            <para>
            根据 MAC 地址加载可选的特定计算机配置文件，支持自定义特定计算机的引导参数和自动化安装配置文件。
          </para>
          </listitem>
        </varlistentry>
      </variablelist>
    </section>
    <section xml:id="sles-pxe-server-configure-grub2-menu">
      <title>创建统一引导菜单</title>
      <para>
      引导菜单使用主配置中的变量提供与体系结构无关的菜单项，可自动适配不同硬件平台和安装类型。
    </para>
      <procedure xml:id="proc-create-grub-menu">
        <title>设置 menu.cfg 文件</title>
        <step>
          <para>
          在 <filename>/srv/tftpboot/boot/grub2/menu.cfg</filename> 下创建统一引导菜单：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /srv/tftpboot/boot/grub2/menu.cfg &lt;&lt; 'EOF'</command>
menuentry 'SLES-16.0 Online Installation' {
  linux  /boot/images/SLES-16.0/${arch}/linux showopts root=live:http://pxe.example.net/boot/images/SLES-16.0/${arch}/squashfs.img ${ipcfg} ${sconsole} ${autoinstall}
  initrd /boot/images/SLES-16.0/${arch}/initrd
}

menuentry 'SLES-16.0 Local Installation' {
  linux  /boot/images/SLES-16.0/${arch}/linux showopts root=live:http://pxe.example.net/boot/images/SLES-16.0/${arch}/squashfs.img inst.install_url=http://pxe.example.net/install/SLES-16.0/${arch} ${ipcfg} ${sconsole} ${autoinstall}
  initrd /boot/images/SLES-16.0/${arch}/initrd
}
EOF
</screen>
        </step>
      </procedure>
      <note>
        <title>菜单项的灵活性</title>
        <para>
        菜单项使用的变量会根据客户端体系结构和配置自动填充。<varname>${arch}</varname> 变量可确保加载正确的文件。
       </para>
        <para>
        可选的 <varname>${ipcfg}</varname> 变量仅会设置 PXE 所选的网络接口。
       </para>
        <para>
        可选的 <varname>${sconsole}</varname> 变量可在安装程序系统中启用串行控制台。
       </para>
      </note>
    </section>
    <section xml:id="sles-pxe-server-configure-grub2-machine-specific">
      <title>针对特定计算机的配置</title>
      <para>
      对于高级部署场景，可创建针对特定计算机的配置文件，以覆盖默认设置或提供自动化安装参数。
    </para>
      <procedure xml:id="proc-machine-specific-config">
        <title>创建针对特定计算机的配置</title>
        <step>
          <para>
          为针对特定计算机的配置创建目录：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p /srv/tftpboot/boot/config</command></screen>
        </step>
        <step>
          <para>
          对于 MAC 地址为 <literal>aa:bb:cc:dd:ee:ff</literal> 的计算机，创建特定配置：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p /srv/tftpboot/boot/config/aa:bb:cc:dd:ee:ff</command></screen>
        </step>
        <step>
          <para>
          创建针对特定计算机的 <filename>grub.cfg</filename>：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /srv/tftpboot/boot/config/aa:bb:cc:dd:ee:ff/grub.cfg &lt;&lt; 'EOF'</command>
# Machine-specific configuration for aa:bb:cc:dd:ee:ff
set default='SLES-16.0 Full Installation'

# Activate the menu-entry after 5sec timeout
set timeout=5

# Use know predictable network interface name
set ipcfg="ip=eno1:dhcp"

# Set the autoinstall variable for this machine
set autoinstall="inst.auto=http://pxe.example.net/install/profiles/aa:bb:cc:dd:ee:ff/sles16.json"
export autoinstall

# Load the default menu
source "/boot/grub2/menu.cfg"
EOF
</screen>
          <para>
          或者，也可在针对特定主机的 <filename>grub.cfg</filename> 中提供自己的菜单项（例如为特定引导尝试生成）：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /srv/tftpboot/boot/config/aa:bb:cc:dd:ee:ff/grub.cfg &lt;&lt; 'EOF'</command>
set default='SLES-16.0 Auto-Installation'
set timeout=5

menuentry 'SLES-16.0 Auto-Installation' {
  linux  /boot/images/SLES-16.0/${arch}/linux showopts root=live:http://pxe.example.net/boot/images/SLES-16.0/${arch}/squashfs.img inst.install_url=http://pxe.example.net/install/SLES-16.0/${arch} inst.auto=http://pxe.example.net/install/profiles/${net_default_mac}/sles16.json ip=eno1:dhcp
  initrd /boot/images/SLES-16.0/${arch}/initrd
}
EOF
</screen>
        </step>
      </procedure>
      <example xml:id="ex-machine-specific-parameters">
        <title>针对特定计算机的常用参数</title>
        <variablelist>
          <varlistentry>
            <term>
              <varname>default</varname>
            </term>
            <listitem>
              <para>
              指定自动引导的菜单项
            </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term>
              <varname>timeout</varname>
            </term>
            <listitem>
              <para>
              设置引导超时时间（秒）
            </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term>
              <varname>ipcfg</varname>
            </term>
            <listitem>
              <para>
              为特定硬件覆盖网络接口配置
            </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term>
              <varname>autoinstall</varname>
            </term>
            <listitem>
              <para>
              提供针对特定计算机的自动化安装配置文件 URL
            </para>
            </listitem>
          </varlistentry>
        </variablelist>
      </example>
    </section>
    <section xml:id="sles-pxe-server-configure-grub2-verify">
      <title>验证 GRUB 2 配置</title>
      <para>
      创建配置文件后，需要验证设置是否正确，且所有必需文件是否就位。
    </para>
      <procedure xml:id="proc-verify-grub-config">
        <title>验证步骤</title>
        <step>
          <para>
          检查 GRUB 2 目录结构：
        </para>
          <screen><prompt>&gt; </prompt><command>find /srv/tftpboot/boot/grub2 -type f -name "*.cfg" -o -name "*.efi" -o -name "core.*"</command></screen>
        </step>
        <step>
          <para>
          使用 GRUB 2 工具验证配置文件语法：
        </para>
          <screen><prompt>&gt; </prompt><command>grub2-script-check /srv/tftpboot/boot/grub2/grub.cfg</command></screen> <screen><prompt>&gt; </prompt><command>grub2-script-check /srv/tftpboot/boot/grub2/menu.cfg</command></screen>
        </step>
        <step>
          <para>
          确保文件权限正确无误：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>chmod -R 644 /srv/tftpboot/boot/grub2/*.cfg</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>find /srv/tftpboot/boot/grub2 -type d -exec chmod 0755 {} \;</command></screen>
        </step>
      </procedure>
      <important>
        <title>配置测试</title>
        <para>
        您需要使用实际 PXE 客户端测试 GRUB 2 配置，以确保体系结构检测和菜单功能正常。<varname>${net_default_mac}</varname> 变量仅在实际网络引导场景中可用。
      </para>
      </important>
    </section>
    <section xml:id="sles-pxe-server-configure-grub2-troubleshooting">
      <title>GRUB 2 配置查错</title>
      <para>
      以下是 GRUB 2 PXE 配置中常见的问题及其解决方案。每个问题均包含诊断步骤和具体解决命令。
    </para>
      <section xml:id="sles-pxe-server-grub2-troubleshoot-arch">
        <title>体系结构检测失败</title>
        <para>
        当 GRUB 2 无法检测到正确体系结构时，客户端可能会加载错误的二进制文件或完全无法加载。
      </para>
        <procedure xml:id="proc-debug-arch-detection">
          <title>调试体系结构检测功能</title>
          <step>
            <para>
            在 GRUB 2 配置中添加调试输出，以查看检测到的值：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt;&gt; /srv/tftpboot/boot/grub2/grub.cfg &lt;&lt; 'EOF'</command>
# Debug architecture detection
echo "Detected grub_cpu: ${grub_cpu}"
echo "Mapped arch: ${arch}"
sleep 3
EOF</screen>
          </step>
          <step>
            <para>
            测试配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>grub2-script-check /srv/tftpboot/boot/grub2/grub.cfg</command></screen>
          </step>
          <step>
            <para>
            如果体系结构映射不完整，则扩展检测逻辑：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i '/elif \[ "$grub_cpu" == "powerpc" \]/a\\nelif [ "$grub_cpu" == "riscv64" ]; then\n  set arch='\''riscv64'\''\\' /srv/tftpboot/boot/grub2/grub.cfg</command></screen>
          </step>
          <step>
            <para>
            验证体系结构专用目录是否存在：
          </para>
            <screen><prompt>&gt; </prompt><command>ls -la /srv/tftpboot/boot/grub2/</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-grub2-troubleshoot-network">
        <title>找不到网络接口</title>
        <para>
        部分固件实现可能未正确设置 <varname>${net_default_mac}</varname> 变量，导致网络配置失败。
      </para>
        <procedure xml:id="proc-debug-network-interface">
          <title>诊断网络接口问题</title>
          <step>
            <para>
            添加调试输出，以检查网络变量：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i '/set ipcfg=/i\\necho "Default MAC: ${net_default_mac}"\necho "Network variables set"\nsleep 2' /srv/tftpboot/boot/grub2/grub.cfg</command></screen>
          </step>
          <step>
            <para>
            创建备用网络配置：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt;&gt; /srv/tftpboot/boot/grub2/grub.cfg &lt;&lt; 'EOF'</command>

# Fallback network configuration if net_default_mac is empty
if [ "X${net_default_mac}" == "X" ]; then
  set ipcfg="ip=dhcp"
  set ifcfg="ifcfg=*=dhcp"
  echo "WARNING: Using fallback network configuration"
  sleep 2
fi
EOF
</screen>
          </step>
          <step>
            <para>
            使用特定接口测试网络配置：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>echo 'set ipcfg="ip=eno1:dhcp"' &gt; /srv/tftpboot/boot/config/test-network.cfg</command></screen>
          </step>
          <step>
            <para>
            验证目标系统上的网络接口名称：
          </para>
            <screen><prompt>&gt; </prompt><command>ip link show</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-grub2-troubleshoot-file-paths">
        <title>找不到文件路径</title>
        <para>
        文件路径错误会导致 GRUB 2 无法加载内核和 initrd 文件，致使引导失败。
      </para>
        <procedure xml:id="proc-debug-file-paths">
          <title>验证文件路径可访问性</title>
          <step>
            <para>
            检查安装程序文件是否位于预期位置：
          </para>
            <screen><prompt>&gt; </prompt><command>find /srv/tftpboot/boot/images -name "linux" -o -name "initrd" -o -name "squashfs.img"</command></screen>
          </step>
          <step>
            <para>
            验证能否通过 TFTP 访问引导文件：
          </para>
            <screen><prompt>&gt; </prompt><command>tftp localhost -c get /boot/grub2/grub.cfg /tmp/test-grub.cfg</command></screen>
          </step>
          <step>
            <para>
            测试能否通过 HTTP 访问安装程序文件：
          </para>
            <screen><prompt>&gt; </prompt><command>curl -I http://localhost/boot/images/SLES-16.0/x86_64/linux</command></screen>
          </step>
          <step>
            <para>
            检查文件权限和所有权：
          </para>
            <screen><prompt>&gt; </prompt><command>ls -la /srv/tftpboot/boot/images/SLES-16.0/*/</command></screen>
          </step>
          <step>
            <para>
            根据需要更正权限：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>chmod -R 644 /srv/tftpboot/boot/images/</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>find /srv/tftpboot/boot/images/ -type d -exec chmod 755 {} \;</command></screen>
          </step>
          <step>
            <para>
            验证符号链接是否未被破坏：
          </para>
            <screen><prompt>&gt; </prompt><command>find /srv/tftpboot/boot/images/ -type l -exec ls -la {} \;</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-grub2-troubleshoot-efi">
        <title>EFI 引导失败</title>
        <para>
        EFI 和安全引导问题可能会导致引导加载程序无法初始化或身份验证失败。
      </para>
        <procedure xml:id="proc-debug-efi-boot">
          <title>诊断 EFI 引导问题</title>
          <step>
            <para>
            验证安全引导文件是否存在：
          </para>
            <screen><prompt>&gt; </prompt><command>ls -la /srv/tftpboot/boot/grub2/x86_64-efi/*.efi</command></screen>
          </step>
          <step>
            <para>
            检查是否已正确复制 shim（bootx64.efi 或 shim.efi）、grub.efi 和 MokManager.efi 文件：
          </para>
            <screen><prompt>&gt; </prompt><command>file /srv/tftpboot/boot/grub2/x86_64-efi/bootx64.efi</command></screen>
          </step>
          <step>
            <para>
            验证 EFI 文件完整性：
          </para>
            <screen><prompt>&gt; </prompt><command>sha256sum /srv/tftpboot/boot/grub2/x86_64-efi/*.efi</command></screen>
          </step>
          <step>
            <para>
            测试能否通过 TFTP 访问这些文件：
          </para>
            <screen><prompt>&gt; </prompt><command>tftp localhost -c get /boot/grub2/x86_64-efi/bootx64.efi /tmp/test-shim.efi</command></screen>
          </step>
          <step>
            <para>
            对于 aarch64 系统，验证 ARM64 EFI 文件：
          </para>
            <screen><prompt>&gt; </prompt><command>ls -la /srv/tftpboot/boot/grub2/arm64-efi/*.efi</command></screen>
          </step>
          <step>
            <para>
            检查 DHCP 配置是否提供了正确的引导加载程序路径：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -n "bootx64.efi\|shim.efi\|bootaa64.efi"
/etc/dnsmasq.d/dhcp.conf /etc/kea/kea-dhcp?.conf /etc/dhcpd?.conf</command></screen>
          </step>
          <step>
            <para>
            如果文件缺失，从挂载到 /mnt 的 ISO 或 shim 软件包文件中重新复制相应文件：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -v /mnt/EFI/BOOT/*.efi /srv/tftpboot/boot/grub2/x86_64-efi/</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>cp -pL /usr/share/efi/x86_64/*.efi /srv/tftpboot/boot/grub2/x86_64-efi/</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-grub2-troubleshoot-menu">
        <title>未加载菜单项</title>
        <para>
        当 GRUB 2 成功加载，但菜单项加载失败或显示错误时，问题通常与变量展开或文件引用有关。
      </para>
        <procedure xml:id="proc-debug-menu-entries">
          <title>调试菜单项问题</title>
          <step>
            <para>
            测试菜单配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>grub2-script-check /srv/tftpboot/boot/grub2/menu.cfg</command></screen>
          </step>
          <step>
            <para>
            在菜单项中添加调试输出：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i '/linux_kernel.*{images}/i\\necho "Loading: ${images}/SLES-16.0/${arch}/linux"\necho "Architecture: ${arch}"' /srv/tftpboot/boot/grub2/menu.cfg</command></screen>
          </step>
          <step>
            <para>
            验证变量展开是否正常工作：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /srv/tftpboot/boot/grub2/debug-menu.cfg &lt;&lt; 'EOF'</command>
menuentry 'Debug Variables' {
  echo "arch = ${arch}"
  echo "images = ${images}"
  echo "ipcfg = ${ipcfg}"
  sleep 5
}
EOF
</screen>
          </step>
          <step>
            <para>
            使用简化的菜单项进行测试：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /srv/tftpboot/boot/grub2/simple-menu.cfg &lt;&lt; 'EOF'</command>
menuentry 'Simple Test' {
  linux /boot/images/SLES-16.0/x86_64/linux
  initrd /boot/images/SLES-16.0/x86_64/initrd
}
EOF
</screen>
          </step>
          <step>
            <para>
            临时加载测试菜单：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i 's|source "${prefix}/menu.cfg"|source "${prefix}/simple-menu.cfg"|' /srv/tftpboot/boot/grub2/grub.cfg</command></screen>
          </step>
          <step>
            <para>
            测试完成后恢复原始菜单：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i 's|source "${prefix}/simple-menu.cfg"|source "${prefix}/menu.cfg"|' /srv/tftpboot/boot/grub2/grub.cfg</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-grub2-troubleshoot-logging">
        <title>启用详细日志记录</title>
        <para>
        对于持续存在的问题，可启用全面日志记录，以捕获引导过程的详细信息。
      </para>
        <procedure xml:id="proc-enable-grub-logging">
          <title>设置 GRUB 2 调试日志记录</title>
          <step>
            <para>
            创建主配置的调试版本：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cp /srv/tftpboot/boot/grub2/grub.cfg /srv/tftpboot/boot/grub2/grub.cfg.backup</command></screen>
          </step>
          <step>
            <para>
            添加全面的调试输出：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /srv/tftpboot/boot/grub2/debug.cfg &lt;&lt; 'EOF'</command>
# Debug configuration for GRUB troubleshooting
set debug=all
set pager=1

echo "=== GRUB Debug Information ==="
echo "grub_cpu: ${grub_cpu}"
echo "grub_platform: ${grub_platform}"
echo "net_default_mac: ${net_default_mac}"
echo "net_default_server: ${net_default_server}"
echo "============================="
sleep 5
EOF
</screen>
          </step>
          <step>
            <para>
            在主文件中包含调试配置：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i '1i\source "${prefix}/debug.cfg"' /srv/tftpboot/boot/grub2/grub.cfg</command></screen>
          </step>
          <step>
            <para>
            在引导尝试期间监控 TFTP 日志：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo journalctl -f -u tftp.socket</command></screen>
          </step>
          <step>
            <para>
            监控 DHCP 日志中的 PXE 请求：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo journalctl -f -u dhcpd</command></screen>
          </step>
          <step>
            <para>
            完成查错后禁用调试模式：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i '/source "${prefix}\/debug.cfg"/d' /srv/tftpboot/boot/grub2/grub.cfg</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-configure-grub2-next-steps">
      <title>后续步骤</title>
      <para>
      正确配置 GRUB 2 后，可继续执行以下操作：
    </para>
      <itemizedlist>
        <listitem>
          <para>
          配置 HTTP 和 TFTP 服务，以提供引导文件和安装程序内容
        </para>
        </listitem>
        <listitem>
          <para>
          设置 DHCP 服务，引导 PXE 使用适当的引导加载程序
        </para>
        </listitem>
        <listitem>
          <para>
          在目标硬件上测试完整的 PXE 引导过程
        </para>
        </listitem>
      </itemizedlist>
      <para>
      灵活的 GRUB 2 配置系统通过统一界面支持多种体系结构和安装类型，为复杂的 PXE 部署场景奠定了基础。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-configure-tftp">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">配置 TFTP 以支持 PXE 引导</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何配置 TFTP 服务，以提供安装 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 时所需的 GRUB 2 引导加载程序和 PXE 引导内容。内容涵盖传统的 <systemitem>in.tftpd</systemitem> 服务器和 <systemitem>dnsmasq</systemitem> 提供的集成 TFTP 功能。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-configure-tftp-intro">
      <title>简介</title>
      <para>
      TFTP 可在网络引导过程中向 PXE 客户端提供引导加载程序文件。<phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 支持两种 TFTP 服务器实现：<package>tftp</package> 软件包提供的传统 <systemitem>in.tftpd</systemitem> 服务器，以及 <systemitem>dnsmasq</systemitem> 中集成的 TFTP 功能。
    </para>
    </section>
    <section xml:id="sles-pxe-server-configure-tftp-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已安装 <package>tftp</package> 软件包或 <package>dnsmasq</package> 软件包
        </para>
        </listitem>
        <listitem>
          <para>
          已在 <filename>/srv/tftpboot</filename> 下整理好 PXE 引导文件
        </para>
        </listitem>
        <listitem>
          <para>
          具备配置服务的管理员权限
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-configure-tftp-intftpd">
      <title>配置 in.tftpd 服务器</title>
      <para>
      <systemitem>in.tftpd</systemitem> 服务器使用 <filename>/etc/sysconfig/tftp</filename> 配置文件定义 TFTP 根目录和服务器选项。
    </para>
      <procedure xml:id="proc-configure-intftpd">
        <title>设置 in.tftpd TFTP 服务器</title>
        <step>
          <para>
          （可选）通过设置 TFTP 选项启用详细日志记录：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i 's/^TFTP_OPTIONS=.*/TFTP_OPTIONS="-v"/' /etc/sysconfig/tftp</command></screen>
          <para>
          <option>-v</option> 选项会启用详细日志记录，可用于查看通过 TFTP 获取的文件名。
        </para>
        </step>
        <step>
          <para>
          启用并启动 TFTP 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now tftp.service</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-configure-tftp-dnsmasq">
      <title>配置 dnsmasq TFTP 服务器</title>
      <para><systemitem>dnsmasq</systemitem> 提供内置的 TFTP 服务器，后者可启用并配置为使用 <filename>/srv/tftpboot</filename> 目录。
    </para>
      <procedure xml:id="proc-configure-dnsmasq-tftp">
        <title>设置 dnsmasq TFTP 功能</title>
        <step>
          <para>
          创建 TFTP 配置文件：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/dnsmasq.d/tftp.conf &lt;&lt; 'EOF'</command>
enable-tftp
tftp-root=/srv/tftpboot
EOF
</screen>
        </step>
        <step>
          <para>
          启用并启动 dnsmasq 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now dnsmasq</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-configure-tftp-verify">
      <title>验证 TFTP 配置</title>
      <para>
      测试 TFTP 服务器功能，确保其能向 PXE 客户端提供文件。
    </para>
      <procedure xml:id="proc-verify-tftp">
        <title>测试 TFTP 服务器功能</title>
        <step>
          <para>
          创建测试文件：
        </para>
          <screen><prompt>&gt; </prompt><command>echo "test file" | sudo tee /srv/tftpboot/test.txt</command></screen>
        </step>
        <step>
          <para>
          通过 TFTP 检索测试文件：
        </para>
          <screen><prompt>&gt; </prompt><command>tftp localhost -c get test.txt /tmp/tftp-test.txt</command></screen>
        </step>
        <step>
          <para>
          验证是否成功检索了文件：
        </para>
          <screen><prompt>&gt; </prompt><command>cat /tmp/tftp-test.txt</command></screen>
        </step>
        <step>
          <para>
          清理测试文件：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>rm /srv/tftpboot/test.txt /tmp/tftp-test.txt</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-configure-tftp-troubleshooting">
      <title>TFTP 配置查错</title>
      <para>
      以下是为 PXE 引导环境配置 TFTP 服务时常见的问题。
    </para>
      <section xml:id="sles-pxe-server-tftp-troubleshoot-service-conflicts">
        <title>端口 69 上的服务冲突</title>
        <para>
        <systemitem>in.tftpd</systemitem> 和 <systemitem>dnsmasq</systemitem> 均使用 UDP 69 端口提供 TFTP 服务，因此不能同时运行。
      </para>
        <procedure xml:id="proc-resolve-tftp-conflicts">
          <title>解决 TFTP 服务冲突</title>
          <step>
            <para>
            检查哪些服务正在运行：
          </para>
            <screen><prompt>&gt; </prompt><command>systemctl status tftp.service dnsmasq</command></screen>
          </step>
          <step>
            <para>
            检查哪些进程在使用 69 端口：
          </para>
            <screen><prompt>&gt; </prompt><command>ss -ulnp | grep :69</command></screen>
          </step>
          <step>
            <para>
            停止冲突的服务（以 dnsmasq 为例）：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl stop dnsmasq</command></screen>
          </step>
          <step>
            <para>
            启动您首选的 TFTP 服务：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl start tftp.service</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-tftp-troubleshoot-directory">
        <title>TFTP 目录问题</title>
        <para>
        无法访问 TFTP 根目录会导致无法提供文件。
      </para>
        <procedure xml:id="proc-debug-tftp-directory">
          <title>验证 TFTP 目录配置</title>
          <step>
            <para>
            验证 in.tftpd 的 TFTP 目录设置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep TFTP_DIRECTORY /etc/sysconfig/tftp</command></screen>
          </step>
          <step>
            <para>
            验证 dnsmasq 的 TFTP 目录设置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep tftp-root /etc/dnsmasq.d/tftp.conf</command></screen>
          </step>
          <step>
            <para>
            检查目录是否存在：
          </para>
            <screen><prompt>&gt; </prompt><command>ls -la /srv/tftpboot/</command></screen>
          </step>
          <step>
            <para>
            如果目录缺失，则创建目录：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p /srv/tftpboot</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-tftp-troubleshoot-verbose">
        <title>启用 TFTP 日志记录</title>
        <para>
        详细日志记录有助于找出 TFTP 传输中的文件访问问题。
      </para>
        <procedure xml:id="proc-enable-tftp-verbose">
          <title>启用 TFTP 详细日志记录</title>
          <step>
            <para>
            检查当前的 TFTP 选项：
          </para>
            <screen><prompt>&gt; </prompt><command>grep TFTP_OPTIONS /etc/sysconfig/tftp</command></screen>
          </step>
          <step>
            <para>
            启用详细日志记录：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i 's/^TFTP_OPTIONS=.*/TFTP_OPTIONS="-v"/' /etc/sysconfig/tftp</command></screen>
          </step>
          <step>
            <para>
            重启 TFTP 服务：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl restart tftp.service</command></screen>
          </step>
          <step>
            <para>
            监控 TFTP 日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u tftp.service -f</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-configure-tftp-next-steps">
      <title>后续步骤</title>
      <para>
      TFTP 配置完毕后，可继续配置 HTTP 服务以提供安装程序文件，以及配置 DHCP 服务以引导 PXE 客户端使用适当的引导加载程序。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-configure-nginx">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">配置 nginx 以实现 HTTP 分发</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何配置 nginx，以通过 HTTP 提供 PXE 引导内容，使客户端能从某个集中位置加载内核、initrd、squashfs 映像等安装程序文件。HTTP 分发大型文件的性能比 TFTP 好，使用 Agama 安装 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 时需要启用该功能。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-configure-nginx-intro">
      <title>简介</title>
      <para>
      nginx 作为 PXE 引导环境的 HTTP 服务器，通过 Web 方式提供安装程序文件访问途径。HTTP 服务器会公开 TFTP 引导目录和安装储存库，使 PXE 客户端能通过 HTTP（而非传输速度较慢的 TFTP 协议）下载内核映像、initrd 文件和 Agama 安装程序组件。
    </para>
    </section>
    <section xml:id="sles-pxe-server-configure-nginx-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已安装 <package>nginx</package> 软件包
        </para>
        </listitem>
        <listitem>
          <para>
          已在 <filename>/srv/tftpboot/boot</filename> 下整理好 PXE 引导文件
        </para>
        </listitem>
        <listitem>
          <para>
          已在 <filename>/srv/install</filename> 下准备好安装储存库
        </para>
        </listitem>
        <listitem>
          <para>
          具备修改 nginx 配置的管理员权限
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-configure-nginx-setup">
      <title>配置 nginx 以支持 PXE 引导</title>
      <para>
      nginx 配置通过定义位置别名，通过 HTTP URL 将 TFTP 引导目录和安装储存库向客户端公开。
    </para>
      <procedure xml:id="proc-configure-nginx">
        <title>设置 nginx HTTP 服务器</title>
        <step>
          <para>
          编辑 nginx 配置文件：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>vim /etc/nginx/nginx.conf</command></screen>
        </step>
        <step>
          <para>
          在 <literal>http</literal> 部分中配置 HTTP 服务器块：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/nginx/nginx.conf &lt;&lt; 'EOF'</command>
http {

    include             mime.types;
    default_type        application/octet-stream;

    charset             utf-8;
    sendfile            on;
    keepalive_timeout   65;

    server {
        listen          80  default_server;
        listen     [::]:80  default_server;

        location / {
            root   /srv/www/htdocs/;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /srv/www/htdocs/;
        }

        # Expose TFTP boot directory for HTTP boot
        location /boot {
            alias      /srv/tftpboot/boot;
            autoindex  on;
        }

        # Expose installation repositories and profiles
        location /install {
            alias      /srv/install;
            autoindex  on;
        }
    }
}

events {
    worker_connections  1024;
}
EOF
</screen>
        </step>
        <step>
          <para>
          测试 nginx 配置语法：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>nginx -t</command></screen>
        </step>
        <step>
          <para>
          启用并启动 nginx 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now nginx.service</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-configure-nginx-verify">
      <title>验证 nginx 配置</title>
      <para>
      测试 HTTP 服务器功能，确保其能向客户端提供 PXE 引导文件和安装内容。
    </para>
      <procedure xml:id="proc-verify-nginx">
        <title>测试 nginx HTTP 服务器</title>
        <step>
          <para>
          测试能否通过 HTTP 访问引导文件：
        </para>
          <screen><prompt>&gt; </prompt><command>curl -I http://localhost/boot/</command></screen>
        </step>
        <step>
          <para>
          测试能否访问安装目录：
        </para>
          <screen><prompt>&gt; </prompt><command>curl -I http://localhost/install/</command></screen>
        </step>
        <step>
          <para>
          验证特定安装程序文件是否可访问：
        </para>
          <screen><prompt>&gt; </prompt><command>curl -I http://localhost/boot/images/SLES-16.0/x86_64/liveiso/LiveOS/squashfs.img</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-configure-nginx-troubleshooting">
      <title>nginx 配置查错</title>
      <para>
      以下是配置 nginx 以实现 PXE 引导 HTTP 分发时常见的问题。
    </para>
      <section xml:id="sles-pxe-server-nginx-troubleshoot-config">
        <title>配置语法错误</title>
        <para>
        不正确的 nginx 配置语法会导致服务无法正常启动或重新加载。
      </para>
        <procedure xml:id="proc-debug-nginx-config">
          <title>解决 nginx 配置问题</title>
          <step>
            <para>
            测试配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>nginx -t</command></screen>
          </step>
          <step>
            <para>
            如果 nginx 服务启动失败，则检查其状态：
          </para>
            <screen><prompt>&gt; </prompt><command>systemctl status nginx.service</command></screen>
          </step>
          <step>
            <para>
            查看详细错误日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u nginx.service -f</command></screen>
          </step>
          <step>
            <para>
            检查 nginx 错误日志文件：
          </para>
            <screen><prompt>&gt; </prompt><command>tail -f /var/log/nginx/error.log</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-nginx-troubleshoot-permissions">
        <title>文件访问和权限问题</title>
        <para>
        nginx 可能会因权限错误或目录缺失而无法提供文件。
      </para>
        <procedure xml:id="proc-debug-nginx-permissions">
          <title>解决文件访问问题</title>
          <step>
            <para>
            检查引导目录是否存在且可访问：
          </para>
            <screen><prompt>&gt; </prompt><command>ls -la /srv/tftpboot/boot/</command></screen>
          </step>
          <step>
            <para>
            检查安装目录是否存在：
          </para>
            <screen><prompt>&gt; </prompt><command>ls -la /srv/install/</command></screen>
          </step>
          <step>
            <para>
            验证 nginx 能否读取这些目录：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo -u nginx ls /srv/tftpboot/boot/</command></screen>
          </step>
          <step>
            <para>
            如果目录缺失，则创建目录：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p /srv/install</command></screen>
          </step>
          <step>
            <para>
            设置适当的权限：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>chmod -R 755 /srv/tftpboot/boot /srv/install</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-nginx-troubleshoot-port">
        <title>端口绑定冲突</title>
        <para>
        如果其他服务占用了 80 端口，nginx 将无法启动。
      </para>
        <procedure xml:id="proc-debug-nginx-port">
          <title>解决端口冲突</title>
          <step>
            <para>
            检查哪些进程在使用 80 端口：
          </para>
            <screen><prompt>&gt; </prompt><command>ss -tlnp | grep :80</command></screen>
          </step>
          <step>
            <para>
            根据需要停止冲突的服务：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl stop apache2</command></screen>
          </step>
          <step>
            <para>
            启动 nginx 服务：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl start nginx.service</command></screen>
          </step>
          <step>
            <para>
            验证 nginx 是否在 80 端口侦听：
          </para>
            <screen><prompt>&gt; </prompt><command>ss -tlnp | grep :80</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-configure-nginx-next-steps">
      <title>后续步骤</title>
      <para>
      为实现 HTTP 分发完成 nginx 配置后，可继续配置 DHCP 服务，以引导 PXE 客户端使用适当的引导加载程序和 HTTP 资源。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-configure-dns">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">使用 dnsmasq 配置 DNS 服务器</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何使用 dnsmasq 配置 DNS 服务，为访问 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 安装资源的 PXE 客户端提供主机名解析功能。DNS 配置使客户端能在引导 URL 和 DHCP 配置中使用主机名（而非 IP 地址）。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-configure-dns-intro">
      <title>简介</title>
      <para>
      DNS 服务使 PXE 客户端能解析引导 URL 和安装源中的主机名。虽然本文不会介绍完整的 DNS 服务器配置，但本章将提供使用 dnsmasq 的基本 DNS 配置，使客户端能将 PXE 服务器主机名 (<replaceable>PXE.EXAMPLE.NET</replaceable>) 解析为对应的 IP 地址。
    </para>
      <para>
      如果未配置 DNS，引导 URL 必须直接使用 IP 地址（如 <literal>http://192.168.1.200/</literal> 或 <literal>http://[2001:db8:0:1::200]/</literal>）。部分 BIOS/UEFI 固件实现不支持在 DHCP TFTP URL 中使用主机名，需使用类似 <literal>tftp://[2001:db8:0:1::200]/</literal> 的 IP 地址格式。
    </para>
    </section>
    <section xml:id="sles-pxe-server-configure-dns-requirements">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已安装 <package>dnsmasq</package> 软件包
        </para>
        </listitem>
        <listitem>
          <para>
          已为 PXE 服务器配置静态 IP 地址
        </para>
        </listitem>
        <listitem>
          <para>
          具备配置 DNS 服务的管理员权限
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-configure-dns-setup">
      <title>配置 dnsmasq DNS 服务</title>
      <para>
      dnsmasq DNS 配置提供本地主机名解析功能，并使用上游名称服务器处理外部查询。
    </para>
      <procedure xml:id="proc-configure-dnsmasq-dns">
        <title>设置 dnsmasq DNS 服务器</title>
        <step>
          <para>
          为 dnsmasq 创建 DNS 配置文件：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/dnsmasq.d/dns.conf &lt;&lt; 'EOF'</command>
# DNS configuration file for dnsmasq

# Log DNS queries
log-queries

# DNS cache behavior
cache-size=10000
local-ttl=60
neg-ttl=10

# Never forward A or AAAA queries for plain names to upstream name servers
domain-needed

# Add local domain to simple names in /etc/hosts and DHCP
expand-hosts

# Specifies DNS domain and networks including local forward and reverse declarations
domain=<replaceable>EXAMPLE.NET</replaceable>,192.168.1.0/24,local
domain=<replaceable>EXAMPLE.NET</replaceable>,2001:db8:0:1::/64,local
EOF
</screen>
        </step>
        <step>
          <para>
          在系统 hosts 文件中添加主机名条目：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt;&gt; /etc/hosts &lt;&lt; 'EOF'</command>
192.168.1.200 <replaceable>PXE.EXAMPLE.NET</replaceable>
2001:db8:0:1::200 <replaceable>PXE.EXAMPLE.NET</replaceable>
EOF
</screen>
        </step>
        <step>
          <para>
          测试 dnsmasq 配置：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>dnsmasq --test</command></screen>
        </step>
        <step>
          <para>
          启用并启动 dnsmasq 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now dnsmasq</command></screen>
        </step>
      </procedure>
      <note>
        <title>DNS 转发行为</title>
        <para>
        默认情况下，dnsmasq 会将 <filename>/etc/resolv.conf</filename> 中的名称服务器用作转发器，并提供从 <filename>/etc/hosts</filename> 中获取的记录。这种配置使 PXE 服务器既能解析外部主机名，又能为 PXE 相关服务提供本地解析。
      </para>
      </note>
    </section>
    <section xml:id="sles-pxe-server-configure-dns-verify">
      <title>验证 DNS 配置</title>
      <para>
      测试 DNS 服务器功能，确保 PXE 客户端能正常进行主机名解析。
    </para>
      <procedure xml:id="proc-verify-dns">
        <title>测试 DNS 服务器功能</title>
        <step>
          <para>
          测试 IPv4 主机名解析：
        </para>
          <screen><prompt>&gt; </prompt><command>nslookup <replaceable>PXE.EXAMPLE.NET</replaceable> localhost</command></screen>
        </step>
        <step>
          <para>
          测试 IPv6 主机名解析：
        </para>
          <screen><prompt>&gt; </prompt><command>nslookup <replaceable>PXE.EXAMPLE.NET</replaceable> localhost | grep 2001:db8</command></screen>
        </step>
        <step>
          <para>
          测试 IPv4 反向 DNS 查询：
        </para>
          <screen><prompt>&gt; </prompt><command>nslookup 192.168.1.200 localhost</command></screen>
        </step>
        <step>
          <para>
          验证外部 DNS 转发是否仍正常工作：
        </para>
          <screen><prompt>&gt; </prompt><command>nslookup google.com localhost</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-configure-dns-troubleshooting">
      <title>DNS 配置查错</title>
      <para>
      以下是为 PXE 环境配置 dnsmasq DNS 服务时常见的问题。
    </para>
      <section xml:id="sles-pxe-server-dns-troubleshoot-config">
        <title>配置和服务问题</title>
        <para>
        dnsmasq 可能会因配置错误或端口冲突而无法启动。
      </para>
        <procedure xml:id="proc-debug-dns-config">
          <title>解决 DNS 配置问题</title>
          <step>
            <para>
            测试 dnsmasq 配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>dnsmasq --test</command></screen>
          </step>
          <step>
            <para>
            检查 dnsmasq 服务状态：
          </para>
            <screen><prompt>&gt; </prompt><command>systemctl status dnsmasq</command></screen>
          </step>
          <step>
            <para>
            检查哪些进程在使用 DNS 53 端口：
          </para>
            <screen><prompt>&gt; </prompt><command>ss -ulnp | grep :53</command></screen>
          </step>
          <step>
            <para>
            查看 dnsmasq 错误日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dnsmasq -f</command></screen>
          </step>
          <step>
            <para>
            根据需要停止冲突的 DNS 服务：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl stop systemd-resolved</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dns-troubleshoot-resolution">
        <title>主机名解析失败</title>
        <para>
        DNS 查询可能会因配置错误或主机名条目缺失而失败。
      </para>
        <procedure xml:id="proc-debug-dns-resolution">
          <title>诊断 DNS 解析问题</title>
          <step>
            <para>
            检查 hosts 文件中是否存在主机名条目：
          </para>
            <screen><prompt>&gt; </prompt><command>grep <replaceable>PXE.EXAMPLE.NET</replaceable> /etc/hosts</command></screen>
          </step>
          <step>
            <para>
            验证 dnsmasq 中的域名配置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep domain= /etc/dnsmasq.d/dns.conf</command></screen>
          </step>
          <step>
            <para>
            以详细输出模式测试 DNS 查询：
          </para>
            <screen><prompt>&gt; </prompt><command>dig @localhost <replaceable>PXE.EXAMPLE.NET</replaceable></command></screen>
          </step>
          <step>
            <para>
            监控 dnsmasq 查询日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dnsmasq | grep "query"</command></screen>
          </step>
          <step>
            <para>
            重启 dnsmasq 以重新加载配置：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl restart dnsmasq</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dns-troubleshoot-forwarding">
        <title>DNS 转发问题</title>
        <para>
        如果上游名称服务器配置错误，外部 DNS 查询可能会失败。
      </para>
        <procedure xml:id="proc-debug-dns-forwarding">
          <title>排查 DNS 转发问题</title>
          <step>
            <para>
            检查上游名称服务器配置：
          </para>
            <screen><prompt>&gt; </prompt><command>cat /etc/resolv.conf</command></screen>
          </step>
          <step>
            <para>
            尝试直接向上游名称服务器发送查询：
          </para>
            <screen><prompt>&gt; </prompt><command>nslookup google.com 8.8.8.8</command></screen>
          </step>
          <step>
            <para>
            检查 dnsmasq 转发配置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -E "server=|no-resolv" /etc/dnsmasq.d/dns.conf</command></screen>
          </step>
          <step>
            <para>
            根据需要添加特定上游名称服务器：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>echo "server=8.8.8.8" &gt;&gt; /etc/dnsmasq.d/dns.conf</command></screen>
          </step>
          <step>
            <para>
            重启 dnsmasq 服务：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl restart dnsmasq</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-configure-dns-next-steps">
      <title>后续步骤</title>
      <para>
      DNS 服务配置完毕后，PXE 客户端现在可解析引导 URL 和安装源中的主机名。您接下来可配置引用该 DNS 服务器的 DHCP 服务，用于客户端配置。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-configure-ntp">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">使用 <systemitem>chrony</systemitem> 配置 NTP 服务器</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何使用 <systemitem>chrony</systemitem> 配置 NTP 服务，在 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 安装过程中为 PXE 客户端提供精准的时间同步。在基于网络的安装过程中，正确的时间同步对证书验证和系统日志记录至关重要。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-configure-ntp-intro">
      <title>简介</title>
      <para>
      NTP 服务可确保网络基础架构中的时间精准同步。在 PXE 引导环境中，同步的时间对 HTTPS 连接期间的证书验证、正确的日志时间戳以及协调的系统操作都至关重要。本章将介绍如何使用 <systemitem>chrony</systemitem> 进行基本的 NTP 服务器配置。
    </para>
    </section>
    <section xml:id="sles-pxe-server-configure-ntp-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已安装 <package>chrony</package> 软件包
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>zypper install chrony</command></screen>
        </listitem>
        <listitem>
          <para>
          能通过网络连接到上游 NTP 服务器
        </para>
        </listitem>
        <listitem>
          <para>
          具备配置 NTP 服务的管理员权限
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-configure-ntp-setup">
      <title>配置 <systemitem>chrony</systemitem> NTP 服务</title>
      <para>
      <systemitem>chrony</systemitem> 服务具备 NTP 功能，既能够自动与上游服务器实现时间同步，又拥有为网络客户端提供本地时间服务的能力。
    </para>
      <procedure xml:id="proc-configure-chrony">
        <title>设置 <systemitem>chrony</systemitem> NTP 服务器</title>
        <step>
          <para>
          启用并启动 <systemitem>chrony</systemitem> 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now chronyd.service</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-configure-ntp-verify">
      <title>验证 NTP 配置</title>
      <para>
      测试 NTP 服务功能，确保时间同步正常工作。
    </para>
      <procedure xml:id="proc-verify-ntp">
        <title>测试 NTP 服务器功能</title>
        <step>
          <para>
          检查 <systemitem>chrony</systemitem> 服务状态：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status chronyd.service</command></screen>
        </step>
        <step>
          <para>
          查看当前时间同步状态：
        </para>
          <screen><prompt>&gt; </prompt><command>chronyc tracking</command></screen>
        </step>
        <step>
          <para>
          列出已配置的 NTP 源：
        </para>
          <screen><prompt>&gt; </prompt><command>chronyc sources</command></screen>
        </step>
        <step>
          <para>
          查看 NTP 服务器统计信息：
        </para>
          <screen><prompt>&gt; </prompt><command>chronyc sourcestats</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-configure-ntp-troubleshooting">
      <title>NTP 配置查错</title>
      <para>
      以下是为 PXE 环境配置 <systemitem>chrony</systemitem> NTP 服务时常见的问题。
    </para>
      <section xml:id="sles-pxe-server-ntp-troubleshoot-service">
        <title>服务启动问题</title>
        <para><systemitem>chrony</systemitem> 服务可能会因配置错误或网络连接问题而无法启动。
      </para>
        <procedure xml:id="proc-debug-ntp-service">
          <title>解决 NTP 服务问题</title>
          <step>
            <para>
            检查 <systemitem>chrony</systemitem> 服务状态和日志：
          </para>
            <screen><prompt>&gt; </prompt><command>systemctl status chronyd.service</command></screen>
          </step>
          <step>
            <para>
            查看详细服务日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u chronyd.service -f</command></screen>
          </step>
          <step>
            <para>
            测试 <systemitem>chrony</systemitem> 配置：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>chronyd -Q</command></screen>
          </step>
          <step>
            <para>
            根据需要重启服务：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl restart chronyd.service</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-ntp-troubleshoot-sync">
        <title>时间同步失败</title>
        <para>
        时间同步可能会因网络问题或服务器配置错误而失败。
      </para>
        <procedure xml:id="proc-debug-ntp-sync">
          <title>诊断时间同步问题</title>
          <step>
            <para>
            查看当前同步状态：
          </para>
            <screen><prompt>&gt; </prompt><command>chronyc tracking</command></screen>
          </step>
          <step>
            <para>
            查看 NTP 源连接情况：
          </para>
            <screen><prompt>&gt; </prompt><command>chronyc sources -v</command></screen>
          </step>
          <step>
            <para>
            强制立即同步：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>chronyc makestep</command></screen>
          </step>
          <step>
            <para>
            检查系统时间与硬件时钟是否一致：
          </para>
            <screen><prompt>&gt; </prompt><command>timedatectl status</command></screen>
          </step>
          <step>
            <para>
            验证与 NTP 服务器的网络连接：
          </para>
            <screen><prompt>&gt; </prompt><command>chronyc activity</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-ntp-troubleshoot-firewall">
        <title>防火墙和网络问题</title>
        <para>
        防火墙规则可能会阻止 NTP 流量，导致时间同步失败。
      </para>
        <procedure xml:id="proc-debug-ntp-firewall">
          <title>解决 NTP 网络连接问题</title>
          <step>
            <para>
            检查防火墙中的 NTP 端口是否开放：
          </para>
            <screen><prompt>&gt; </prompt><command>firewall-cmd --list-services | grep ntp</command></screen>
          </step>
          <step>
            <para>
            根据需要将 NTP 服务添加到防火墙：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --permanent --add-service=ntp</command></screen>
          </step>
          <step>
            <para>
            重新加载防火墙配置：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>firewall-cmd --reload</command></screen>
          </step>
          <step>
            <para>
            手动测试 NTP 连接情况：
          </para>
            <screen><prompt>&gt; </prompt><command>ntpdate -q pool.ntp.org</command></screen>
          </step>
          <step>
            <para>
            检查 <systemitem>chrony</systemitem> 端口使用情况：
          </para>
            <screen><prompt>&gt; </prompt><command>ss -ulnp | grep :123</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-configure-ntp-next-steps">
      <title>后续步骤</title>
      <para>
      NTP 服务配置完毕后，PXE 服务器与客户端的时间将保持精准同步。这可确保在基于网络的安装过程中，能正常进行证书验证和系统操作协调。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-ipv6-router">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">配置 IPv6 路由器通告</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何配置 IPv6 路由器通告 (RA) 功能，以便为 PXE 客户端提供充足的路由器通告。在 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 安装过程中，IPv6 RA 可实现 IPv6 路由配置和有状态 DHCPv6 地址自动配置。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-ipv6-router-intro">
      <title>简介</title>
      <para>
      IPv6 路由器通告 (RA) 会向 PXE 客户端提供关键的网络配置信息，包括 IPv6 路由和 DHCPv6 地址自动配置设置。本章假设已完成 IPv6 路由器的配置 - 该路由器会发送充足的路由器通告，以完成以下两项任务：一是配置到目标网络的 IPv6 路由及默认路由；二是通过设置 <literal>AdvManagedFlag on</literal>，启用有状态 DHCPv6 地址自动配置功能。
    </para>
    </section>
    <section xml:id="sles-pxe-server-ipv6-router-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已安装 <package>radvd</package> 软件包
        </para>
        </listitem>
        <listitem>
          <para>
          服务器接口已完成 IPv6 网络配置
        </para>
        </listitem>
        <listitem>
          <para>
          具备配置路由器通告服务的管理员权限
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-ipv6-router-setup">
      <title>配置 <systemitem>radvd</systemitem> 以支持 IPv6 路由器通告</title>
      <para>
      <systemitem>radvd</systemitem> 服务通过 <filename>/etc/radvd.conf</filename> 中定义的配置提供 IPv6 路由器通告功能。
    </para>
      <procedure xml:id="proc-configure-radvd">
        <title>设置 <systemitem>radvd</systemitem> IPv6 路由器通告</title>
        <step>
          <para>
          配置 <systemitem>radvd</systemitem> 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/radvd.conf &lt;&lt; 'EOF'</command>
interface eno1
{
    # radvd options
    IgnoreIfMissing on;                 # Do not fail and exit when interface is missed
    AdvSendAdvert on;                   # Sending RAs on the interface is not disabled

    # Configuration settings

    AdvManagedFlag on;                  # Request IPv6 address and dns options via DHCPv6
    AdvOtherConfigFlag off;             # Request only dns info via DHCPv6, IP via SLAAC

    AdvDefaultLifetime 1800;            # Add default route via this router for 1800sec

    prefix 2001:db8:0:1::/64            # Add direct route for this local network/prefix
    {
        AdvAutonomous           off;    # Assign IPv6 address via SLAAC
        AdvValidLifetime        7200;
        AdvPreferredLifetime    3600;
    };
};
EOF
</screen>
        </step>
        <step>
          <para>
          启用并启动 <systemitem>radvd</systemitem> 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now radvd</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-ipv6-router-verify">
      <title>验证 IPv6 路由器通告</title>
      <para>
      测试 IPv6 RA 功能，确保其配置正确且运行正常。
    </para>
      <procedure xml:id="proc-verify-radvd">
        <title>测试 IPv6 路由器通告</title>
        <step>
          <para>
          检查 <systemitem>radvd</systemitem> 服务状态：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status radvd</command></screen>
        </step>
        <step>
          <para>
          使用 <command>ravdump</command> 查看并验证 IPv6 RA 设置
        </para>
          <screen><prompt>&gt; </prompt><command>radvdump</command></screen>
          <para>
          <command>radvdump</command> 实用程序会显示 IPv6 路由器每隔几分钟发送的 IPv6 RA 设置。
        </para>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-ipv6-router-forwarding">
      <title>为路由器功能配置 IP 转发</title>
      <para>
      如果 PXE 服务器同时作为路由器，则必须启用 IP 转发以使其具备路由器功能。
    </para>
      <procedure xml:id="proc-enable-ip-forwarding">
        <title>在 PXE 服务器上启用 IP 转发</title>
        <step>
          <para>
          创建网络配置文件：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/sysctl.d/90-network.conf &lt;&lt; 'EOF'</command>
# This machine is a router
net.ipv4.conf.all.forwarding = 1
net.ipv6.conf.all.forwarding = 1

# Accept host autoconf on router uplink
net.ipv6.conf.uplink.accept_ra = 2
EOF
</screen>
        </step>
        <step>
          <para>
          应用网络配置设置：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>sysctl -p /etc/sysctl.d/90-network.conf</command></screen>
        </step>
      </procedure>
      <note>
        <title>路由器配置注意事项</title>
        <para>
        默认情况下，路由器不会处理用于主机自动配置的 IPv6 RA。如果要在路由器上行接口上接受 IPv6 RA，需要指定 <literal>accept_ra = 2</literal> sysctl 设置。有关路由器配置的更多详细信息（包括防火墙调整和其他必要步骤），请参见《管理指南》中的“网络配置”章节。
      </para>
      </note>
    </section>
    <section xml:id="sles-pxe-server-ipv6-router-troubleshooting">
      <title>IPv6 路由器通告查错</title>
      <para>
      以下是为 PXE 环境配置 IPv6 路由器通告时常见的问题。
    </para>
      <section xml:id="sles-pxe-server-ipv6-troubleshoot-service">
        <title><systemitem>radvd</systemitem> 服务问题</title>
        <para>
        <systemitem>radvd</systemitem> 服务可能会因配置错误或接口问题而无法启动。
      </para>
        <procedure xml:id="proc-debug-radvd-service">
          <title>解决 <systemitem>radvd</systemitem> 服务问题</title>
          <step>
            <para>
            检查 <systemitem>radvd</systemitem> 服务状态和日志：
          </para>
            <screen><prompt>&gt; </prompt><command>systemctl status radvd</command></screen>
          </step>
          <step>
            <para>
            查看详细服务日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u radvd -f</command></screen>
          </step>
          <step>
            <para>
            测试 <systemitem>radvd</systemitem> 配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>radvd -C /etc/radvd.conf</command></screen>
          </step>
          <step>
            <para>
            检查指定接口是否存在：
          </para>
            <screen><prompt>&gt; </prompt><command>ip link show eno1</command></screen>
          </step>
          <step>
            <para>
            修复配置后重启服务：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl restart radvd</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-ipv6-troubleshoot-forwarding">
        <title>IP 转发配置问题</title>
        <para>
        不正确的 IP 转发设置会导致路由器功能无法正常工作。
      </para>
        <procedure xml:id="proc-debug-ip-forwarding">
          <title>诊断 IP 转发问题</title>
          <step>
            <para>
            检查当前 IP 转发状态：
          </para>
            <screen><prompt>&gt; </prompt><command>sysctl net.ipv4.conf.all.forwarding</command></screen>
          </step>
          <step>
            <para>
            检查 IPv6 转发状态：
          </para>
            <screen><prompt>&gt; </prompt><command>sysctl net.ipv6.conf.all.forwarding</command></screen>
          </step>
          <step>
            <para>
            验证 sysctl 配置文件：
          </para>
            <screen><prompt>&gt; </prompt><command>cat /etc/sysctl.d/90-network.conf</command></screen>
          </step>
          <step>
            <para>
            如果值不正确，则应用配置：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sysctl -p /etc/sysctl.d/90-network.conf</command></screen>
          </step>
          <step>
            <para>
            检查上行接口的 accept_ra 设置：
          </para>
            <screen><prompt>&gt; </prompt><command>sysctl net.ipv6.conf.uplink.accept_ra</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-ipv6-troubleshoot-ra">
        <title>路由器通告接收问题</title>
        <para>
        客户端可能无法正确接收或处理 IPv6 路由器通告。
      </para>
        <procedure xml:id="proc-debug-ra-reception">
          <title>排查 RA 接收问题</title>
          <step>
            <para>
            使用 <command>ravdump</command> 监控路由器通告：
          </para>
            <screen><prompt>&gt; </prompt><command>radvdump -d</command></screen>
          </step>
          <step>
            <para>
            检查客户端上的 IPv6 接口配置：
          </para>
            <screen><prompt>&gt; </prompt><command>ip -6 addr show</command></screen>
          </step>
          <step>
            <para>
            验证客户端上的 IPv6 路由表：
          </para>
            <screen><prompt>&gt; </prompt><command>ip -6 route show</command></screen>
          </step>
          <step>
            <para>
            测试与路由器的 IPv6 连接：
          </para>
            <screen><prompt>&gt; </prompt><command>ping6 2001:db8:0:1::1</command></screen>
          </step>
          <step>
            <para>
            检查防火墙的 ICMPv6 规则：
          </para>
            <screen><prompt>&gt; </prompt><command>firewall-cmd --list-protocols | grep ipv6-icmp</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-ipv6-router-next-steps">
      <title>后续步骤</title>
      <para>
      IPv6 路由器通告配置完毕后，PXE 客户端便可获取正确的 IPv6 网络配置。这一配置不仅能实现 DHCPv6 功能，还能为基于网络的安装提供 IPv6 连接能力。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-dhcp-dnsmasq">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">使用 dnsmasq 配置 DHCP 服务器</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何使用 dnsmasq 配置 DHCP 服务，以提供安装 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 时所需的网络配置和 PXE 引导信息。dnsmasq DHCP 服务器采用基于标签的配置，支持具备 UEFI 和 BIOS 引导能力的 IPv4 和 IPv6 PXE 客户端。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-dhcp-dnsmasq-intro">
      <title>简介</title>
      <para>
      dnsmasq DHCP 服务器通过基于标签的系统来匹配客户端类型和提供适当的引导加载程序，为 PXE 客户端提供网络配置和引导文件信息。此配置支持对 DHCPv4 和 DHCPv6 生效的 PXEClient 和 HTTPClient 匹配规则，可在多体系结构系统上实现 UEFI 和 BIOS 引导。
    </para>
      <important>
        <title>dnsmasq 中 HTTPClient 的局限性</title>
        <para>
        dnsmasq 2.90 及更早版本不支持向 DHCPv6 客户端返回用于 HTTPClient 配置的 6:16 供应商类别选项。如果需要完整的 HTTPClient 支持，建议使用 Kea 或 ISC DHCP 服务器。
      </para>
      </important>
    </section>
    <section xml:id="sles-pxe-server-dhcp-dnsmasq-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已安装 <package>dnsmasq</package> 软件包
        </para>
        </listitem>
        <listitem>
          <para>
          已在 <filename>/srv/tftpboot</filename> 下正确整理 PXE 引导文件
        </para>
        </listitem>
        <listitem>
          <para>
          已为 DHCP 服务配置网络接口
        </para>
        </listitem>
        <listitem>
          <para>
          具备配置 DHCP 服务的管理员权限
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-dhcp-dnsmasq-setup">
      <title>配置 dnsmasq DHCP 服务</title>
      <para>
      dnsmasq DHCP 配置包括客户端类型匹配、网络范围，以及为 IPv4 和 IPv6 网络分配引导文件。
    </para>
      <procedure xml:id="proc-configure-dnsmasq-dhcp">
        <title>设置 dnsmasq DHCP 服务器</title>
        <step>
          <para>
          为 dnsmasq 创建 DHCP 配置文件：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/dnsmasq.d/dhcp.conf &lt;&lt; 'EOF'</command>
# DHCP configuration file for dnsmasq

# Log DHCP processing
log-dhcp

# This is the only DHCP server, don't ignore unknown clients/send NAK
dhcp-authoritative

# Disable re-use of the DHCPv4 servername and filename fields as extra
# option space, which may confuse old or broken clients
dhcp-no-override

# IPv4 PXE/HTTP boot client matches (no enterprise number)
# Match client type in PXEClient:Arch and map to a tag
dhcp-vendorclass=set:tftp_bios_x86_pc,PXEClient:Arch:00000
dhcp-vendorclass=set:tftp_uefi_x86_64,PXEClient:Arch:00007
dhcp-vendorclass=set:tftp_ieee_ppc_64,PXEClient:Arch:0000e
dhcp-vendorclass=set:tftp_uefi_arm_64,PXEClient:Arch:00011
# Match client type in HTTPClient:Arch and map to a tag
dhcp-vendorclass=set:http_uefi_x86_64,HTTPClient:Arch:00016
dhcp-vendorclass=set:http_uefi_arm_64,HTTPClient:Arch:00019

# IPv6 PXE/HTTP boot client matches (enterprise:343 intel)
# Match client type in PXEClient:Arch and map to a tag
dhcp-vendorclass=set:tftp_bios_x86_pc,enterprise:343,PXEClient:Arch:00000
dhcp-vendorclass=set:tftp_uefi_x86_64,enterprise:343,PXEClient:Arch:00007
dhcp-vendorclass=set:tftp_ieee_ppc_64,enterprise:343,PXEClient:Arch:0000e
dhcp-vendorclass=set:tftp_uefi_arm_64,enterprise:343,PXEClient:Arch:00011
# Match client type in HTTPClient:Arch and map to a tag
dhcp-vendorclass=set:http_uefi_x86_64,enterprise:343,HTTPClient:Arch:00016
dhcp-vendorclass=set:http_uefi_arm_64,enterprise:343,HTTPClient:Arch:00019
EOF
</screen>
        </step>
        <step>
          <para>
          配置 IPv4 DHCP 范围和选项：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt;&gt; /etc/dnsmasq.d/dhcp.conf &lt;&lt; 'EOF'</command>

# IPv4 range and options
dhcp-range=set:net0v4,192.168.1.100,192.168.1.199,255.255.255.0,1h
dhcp-option=tag:net0v4,option:domain-search,example.net
dhcp-option=tag:net0v4,option:dns-server,192.168.1.200
dhcp-option=tag:net0v4,option:ntp-server,192.168.1.1
dhcp-option=tag:net0v4,option:router,192.168.1.1
EOF
</screen>
        </step>
        <step>
          <para>
          配置 IPv4 PXE 引导选项：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt;&gt; /etc/dnsmasq.d/dhcp.conf &lt;&lt; 'EOF'</command>

# IPv4 PXEClient boot
dhcp-boot=tag:net0v4,tag:tftp_bios_x86_pc,/boot/grub2/i386-pc/core.0,192.168.1.200
dhcp-boot=tag:net0v4,tag:tftp_uefi_x86_64,/boot/grub2/x86_64-efi/bootx64.efi,192.168.1.200
dhcp-boot=tag:net0v4,tag:tftp_ieee_ppc_64,/boot/grub2/powerpc-ieee1275/core.elf,192.168.1.200
dhcp-boot=tag:net0v4,tag:tftp_uefi_arm_64,/boot/grub2/arm64-efi/bootaa64.efi,192.168.1.200

# IPv4 HTTPClient boot
dhcp-option-force=tag:net0v4,tag:http_uefi_x86_64,option:vendor-class,HTTPClient
dhcp-boot=tag:net0v4,tag:http_uefi_x86_64,http://192.168.1.200/boot/grub2/x86_64-efi/bootx64.efi
dhcp-option-force=tag:net0v4,tag:http_uefi_arm_64,option:vendor-class,HTTPClient
dhcp-boot=tag:net0v4,tag:http_uefi_arm_64,http://192.168.1.200/boot/grub2/arm64-efi/bootaa64.efi
EOF
</screen>
        </step>
        <step>
          <para>
          配置 IPv6 DHCP 范围和选项：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt;&gt; /etc/dnsmasq.d/dhcp.conf &lt;&lt; 'EOF'</command>

# IPv6 range and options
dhcp-range=set:net0v6,2001:db8:0:1:d::,2001:db8:0:1:d::ffff,64,1h
dhcp-option=tag:net0v6,option6:domain-search,example.net
dhcp-option=tag:net0v6,option6:dns-server,[2001:db8:0:1::200]
dhcp-option=tag:net0v6,option6:sntp-server,[2001:db8:0:1::1]
EOF
</screen>
        </step>
        <step>
          <para>
          配置 IPv6 PXE 引导选项：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt;&gt; /etc/dnsmasq.d/dhcp.conf &lt;&lt; 'EOF'</command>

# IPv6 PXEClient boot
dhcp-option=tag:net0v6,tag:tftp_bios_x86_pc,option6:bootfile-url,tftp://[2001:db8:0:1::200]/boot/grub2/i386-pc/core.0
dhcp-option=tag:net0v6,tag:tftp_uefi_x86_64,option6:bootfile-url,tftp://[2001:db8:0:1::200]/boot/grub2/x86_64-efi/bootx64.efi
dhcp-option=tag:net0v6,tag:tftp_ieee_ppc_64,option6:bootfile-url,tftp://[2001:db8:0:1::200]/boot/grub2/powerpc-ieee1275/core.elf
dhcp-option=tag:net0v6,tag:tftp_uefi_arm_64,option6:bootfile-url,tftp://[2001:db8:0:1::200]/boot/grub2/arm64-efi/bootaa64.efi

# IPv6 HTTPClient boot
# Note: dnsmasq &lt;= 2.90 does not support sending vendor-class option6:16 back to client
EOF
</screen>
        </step>
        <step>
          <para>
          测试 dnsmasq 配置：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>dnsmasq --test</command></screen>
        </step>
        <step>
          <para>
          启用并启动 dnsmasq 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now dnsmasq</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-dhcp-dnsmasq-verify">
      <title>验证 DHCP 配置</title>
      <para>
      测试 DHCP 服务器功能，确保能向 PXE 客户端提供正确的网络配置和引导文件。
    </para>
      <procedure xml:id="proc-verify-dhcp-dnsmasq">
        <title>测试 dnsmasq DHCP 服务器</title>
        <step>
          <para>
          检查 dnsmasq 服务状态：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status dnsmasq</command></screen>
        </step>
        <step>
          <para>
          验证 DHCP 端口绑定：
        </para>
          <screen><prompt>&gt; </prompt><command>ss -ulnp | grep :67</command></screen>
        </step>
        <step>
          <para>
          监控 DHCP 租约分配：
        </para>
          <screen><prompt>&gt; </prompt><command>journalctl -u dnsmasq -f</command></screen>
        </step>
        <step>
          <para>
          查看有效的 DHCP 租约：
        </para>
          <screen><prompt>&gt; </prompt><command>cat /var/lib/dhcp/dhcpd.leases</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-dhcp-dnsmasq-troubleshooting">
      <title>dnsmasq DHCP 配置查错</title>
      <para>
      以下是为 PXE 环境配置 dnsmasq DHCP 服务时的常见问题。
    </para>
      <section xml:id="sles-pxe-server-dhcp-dnsmasq-troubleshoot-service">
        <title>服务启动和配置问题</title>
        <para>
        dnsmasq 可能会因配置错误或与其他 DHCP 服务发生端口冲突而无法启动。
      </para>
        <procedure xml:id="proc-debug-dnsmasq-dhcp-service">
          <title>解决 dnsmasq DHCP 服务问题</title>
          <step>
            <para>
            测试 dnsmasq 配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>dnsmasq --test</command></screen>
          </step>
          <step>
            <para>
            检查是否存在 DHCP 端口冲突：
          </para>
            <screen><prompt>&gt; </prompt><command>ss -ulnp | grep :67</command></screen>
          </step>
          <step>
            <para>
            停止冲突的 DHCP 服务：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl stop dhcpd</command></screen>
          </step>
          <step>
            <para>
            查看详细服务日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dnsmasq -f</command></screen>
          </step>
          <step>
            <para>
            解决冲突后重启 dnsmasq：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl restart dnsmasq</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dhcp-dnsmasq-troubleshoot-leases">
        <title>DHCP 租约分配问题</title>
        <para>
        客户端可能会因范围配置或网络连接问题而无法获取 IP 地址。
      </para>
        <procedure xml:id="proc-debug-dhcp-leases">
          <title>诊断 DHCP 租约问题</title>
          <step>
            <para>
            检查 DHCP 范围配置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep dhcp-range /etc/dnsmasq.d/dhcp.conf</command></screen>
          </step>
          <step>
            <para>
            实时监控 DHCP 请求：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dnsmasq -f | grep DHCP</command></screen>
          </step>
          <step>
            <para>
            检查网络接口状态：
          </para>
            <screen><prompt>&gt; </prompt><command>ip addr show</command></screen>
          </step>
          <step>
            <para>
            验证 DHCP 权威服务器设置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep dhcp-authoritative /etc/dnsmasq.d/dhcp.conf</command></screen>
          </step>
          <step>
            <para>
            使用 dhcping 测试 DHCP 响应：
          </para>
            <screen><prompt>&gt; </prompt><command>dhcping -s 192.168.1.200</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dhcp-dnsmasq-troubleshoot-pxe">
        <title>PXE 引导文件分发问题</title>
        <para>
        PXE 客户端能获取 IP 地址，但因引导文件配置错误或客户端类型匹配问题而无法引导。
      </para>
        <procedure xml:id="proc-debug-pxe-boot">
          <title>PXE 引导配置问题查错</title>
          <step>
            <para>
            检查客户端供应商类别匹配：
          </para>
            <screen><prompt>&gt; </prompt><command>grep dhcp-vendorclass /etc/dnsmasq.d/dhcp.conf</command></screen>
          </step>
          <step>
            <para>
            验证引导文件路径：
          </para>
            <screen><prompt>&gt; </prompt><command>grep dhcp-boot /etc/dnsmasq.d/dhcp.conf</command></screen>
          </step>
          <step>
            <para>
            测试能否通过 TFTP 访问引导文件：
          </para>
            <screen><prompt>&gt; </prompt><command>tftp 192.168.1.200 -c get /boot/grub2/x86_64-efi/bootx64.efi</command></screen>
          </step>
          <step>
            <para>
            监控与 PXE 相关的 DHCP 日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dnsmasq | grep -E "PXE|HTTP"</command></screen>
          </step>
          <step>
            <para>
            查看日志中的标签分配：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dnsmasq | grep "tags:"</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dhcp-dnsmasq-troubleshoot-ipv6">
        <title>IPv6 DHCP 配置问题</title>
        <para>
        IPv6 DHCP 客户端需要正确的路由器通告配置，且其地址配置要求可能与 IPv4 不同。
      </para>
        <procedure xml:id="proc-debug-ipv6-dhcp">
          <title>解决 IPv6 DHCP 问题</title>
          <step>
            <para>
            验证 IPv6 DHCP 范围配置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep "2001:db8" /etc/dnsmasq.d/dhcp.conf</command></screen>
          </step>
          <step>
            <para>
            检查 IPv6 路由器通告状态：
          </para>
            <screen><prompt>&gt; </prompt><command>systemctl status radvd</command></screen>
          </step>
          <step>
            <para>
            监控 DHCPv6 请求：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dnsmasq | grep "DHCPv6"</command></screen>
          </step>
          <step>
            <para>
            测试 IPv6 连接：
          </para>
            <screen><prompt>&gt; </prompt><command>ping6 2001:db8:0:1::200</command></screen>
          </step>
          <step>
            <para>
            检查 IPv6 选项配置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep option6 /etc/dnsmasq.d/dhcp.conf</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-dhcp-dnsmasq-next-steps">
      <title>后续步骤</title>
      <para>
      dnsmasq DHCP 服务配置完毕后，PXE 客户端在 IPv4 和 IPv6 环境下，均能获取网络配置和引导文件信息。基于标签的系统可根据客户端体系结构和引导方式要求，灵活分配引导文件。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-dhcp-kea">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">使用 Kea 配置 DHCP 服务器</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何使用 Kea 配置 DHCP 服务，以提供安装 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 时所需的网络配置和 PXE 引导信息。Kea 是一款现代化 DHCP 服务器，支持 IPv4 和 IPv6，并具备客户端类别匹配功能，可用于 PXE 和 HTTP 引导场景。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-dhcp-kea-intro">
      <title>简介</title>
      <para>
      Kea 是由 ISC 开发的现代化 DHCP 服务器，作为旧版 ISC DHCP 服务器的继任者。它对 DHCPv4 和 DHCPv6 均提供稳定支持，具备客户端分类能力，可根据客户端体系结构和引导方式提供合适的引导文件。Kea 采用基于 JSON 格式的配置文件，支持供应商类别识别等高级功能，适用于 HTTP 引导场景。
    </para>
    </section>
    <section xml:id="sles-pxe-server-dhcp-kea-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已安装 Kea DHCP 软件包：<package>kea-dhcp4</package> 和 <package>kea-dhcp6</package>
        </para>
        </listitem>
        <listitem>
          <para>
          已在 <filename>/srv/tftpboot</filename> 下正确整理 PXE 引导文件
        </para>
        </listitem>
        <listitem>
          <para>
          已为 DHCP 服务配置网络接口
        </para>
        </listitem>
        <listitem>
          <para>
          具备配置 DHCP 服务的管理员权限
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-dhcp-kea-dhcpv4">
      <title>配置 Kea DHCPv4 服务器</title>
      <para>
      Kea DHCPv4 配置使用客户端类别来匹配 PXE 和 HTTP 客户端类型，并针对不同体系结构提供适当的引导文件。
    </para>
      <procedure xml:id="proc-configure-kea-dhcpv4">
        <title>设置 Kea DHCPv4 服务器</title>
        <step>
          <para>
          配置 Kea DHCPv4 服务器：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/kea/kea-dhcp4.conf &lt;&lt; 'EOF'</command>
{
  "Dhcp4": {
    "interfaces-config": {
      "interfaces": [
        "eno1"
      ]
    },
    "control-socket": {
      "socket-type": "unix",
      "socket-name": "/tmp/kea4-ctrl-socket"
    },
    "lease-database": {
      "type": "memfile",
      "persist": true,
      "name": "/var/lib/kea/dhcp4.leases",
      "lfc-interval": 3600
    },
    "expired-leases-processing": {
      "reclaim-timer-wait-time": 10,
      "flush-reclaimed-timer-wait-time": 25,
      "hold-reclaimed-time": 3600,
      "max-reclaim-leases": 100,
      "max-reclaim-time": 250,
      "unwarned-reclaim-cycles": 5
    },
    "renew-timer": 1800,
    "rebind-timer": 3150,
    "valid-lifetime": 3600,
    "option-data": [],
    "client-classes": [
      {
        "name": "pxeclients#00000",
        "test": "substring(option[60].hex,0,20) == 'PXEClient:Arch:00000'",
        "next-server": "192.168.1.200",
        "boot-file-name": "/boot/grub2/i386-pc/core.0"
      },
      {
        "name": "pxeclients#00007",
        "test": "substring(option[60].hex,0,20) == 'PXEClient:Arch:00007'",
        "next-server": "192.168.1.200",
        "boot-file-name": "/boot/grub2/x86_64-efi/bootx64.efi"
      },
      {
        "name": "pxeclients#0000e",
        "test": "substring(option[60].hex,0,20) == 'PXEClient:Arch:0000e'",
        "next-server": "192.168.1.200",
        "boot-file-name": "/boot/grub2/powerpc-ieee1275/core.elf"
      },
      {
        "name": "pxeclients#00011",
        "test": "substring(option[60].hex,0,20) == 'PXEClient:Arch:00011'",
        "next-server": "192.168.1.200",
        "boot-file-name": "/boot/grub2/arm64-efi/bootaa64.efi"
      },
      {
        "name": "httpclients#00016",
        "test": "substring(option[60].hex,0,21) == 'HTTPClient:Arch:00016'",
        "boot-file-name": "http://192.168.1.200/boot/grub2/x86_64-efi/bootx64.efi",
        "option-data": [
          {
            "name": "vendor-class-identifier",
            "data": "HTTPClient"
          }
        ]
      },
      {
        "name": "httpclients#00019",
        "test": "substring(option[60].hex,0,21) == 'HTTPClient:Arch:00019'",
        "boot-file-name": "http://192.168.1.200/boot/grub2/arm64-efi/bootaa64.efi",
        "option-data": [
          {
            "name": "vendor-class-identifier",
            "data": "HTTPClient"
          }
        ]
      }
    ],
    "subnet4": [
      {
        "id": 1,
        "subnet": "192.168.1.0/24",
        "pools": [
          {
            "pool": "192.168.1.100 - 192.168.1.199"
          }
        ],
        "option-data": [
          {
            "name": "routers",
            "data": "192.168.1.1"
          },
          {
            "name": "ntp-servers",
            "data": "192.168.1.1"
          },
          {
            "name": "domain-name-servers",
            "data": "192.168.1.200"
          },
          {
            "name": "domain-search",
            "data": "example.net"
          }
        ],
        "reservations": []
      }
    ],
    "loggers": [
      {
        "name": "kea-dhcp4",
        "output-options": [
          {
            "output": "/var/log/kea/dhcp4.log"
          }
        ],
        "severity": "INFO",
        "debuglevel": 0
      }
    ]
  }
}
EOF
</screen>
        </step>
        <step>
          <para>
          创建 Kea 日志目录：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>mkdir -p /var/log/kea</command></screen>
        </step>
        <step>
          <para>
          测试 Kea DHCPv4 配置：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>kea-dhcp4 -t /etc/kea/kea-dhcp4.conf</command></screen>
        </step>
        <step>
          <para>
          启用并启动 Kea DHCPv4 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now kea-dhcp4</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-dhcp-kea-dhcpv6">
      <title>配置 Kea DHCPv6 服务器</title>
      <para>
      Kea DHCPv6 配置通过供应商类别匹配功能针对不同客户端体系结构提供 IPv6 地址分配和引导文件信息。
    </para>
      <procedure xml:id="proc-configure-kea-dhcpv6">
        <title>设置 Kea DHCPv6 服务器</title>
        <step>
          <para>
          配置 Kea DHCPv6 服务器：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/kea/kea-dhcp6.conf &lt;&lt; 'EOF'</command>
{
  "Dhcp6": {
    "interfaces-config": {
      "interfaces": [
        "eno1"
      ]
    },
    "control-socket": {
      "socket-type": "unix",
      "socket-name": "/tmp/kea6-ctrl-socket"
    },
    "lease-database": {
      "type": "memfile",
      "persist": true,
      "name": "/var/lib/kea/dhcp6.leases",
      "lfc-interval": 3600
    },
    "expired-leases-processing": {
      "reclaim-timer-wait-time": 10,
      "flush-reclaimed-timer-wait-time": 25,
      "hold-reclaimed-time": 3600,
      "max-reclaim-leases": 100,
      "max-reclaim-time": 250,
      "unwarned-reclaim-cycles": 5
    },
    "renew-timer": 1800,
    "rebind-timer": 2880,
    "preferred-lifetime": 3600,
    "valid-lifetime": 7200,
    "option-data": [],
    "option-def": [],
    "client-classes": [
      {
        "name": "pxeclients#00000",
        "test": "substring(option[16].hex,6,20) == 'PXEClient:Arch:00000'",
        "option-data": [
          {
            "name": "bootfile-url",
            "data": "tftp://[2001:db8:0:1::200]/boot/grub2/i386-pc/core.0"
          }
        ]
      },
      {
        "name": "pxeclients#00007",
        "test": "substring(option[16].hex,6,20) == 'PXEClient:Arch:00007'",
        "option-data": [
          {
            "name": "bootfile-url",
            "data": "tftp://[2001:db8:0:1::200]/boot/grub2/x86_64-efi/bootx64.efi"
          }
        ]
      },
      {
        "name": "pxeclients#0000e",
        "test": "substring(option[16].hex,6,20) == 'PXEClient:Arch:0000e'",
        "option-data": [
          {
            "name": "bootfile-url",
            "data": "tftp://[2001:db8:0:1::200]/boot/grub2/powerpc-ieee1275/core.elf"
          }
        ]
      },
      {
        "name": "pxeclients#00011",
        "test": "substring(option[16].hex,6,20) == 'PXEClient:Arch:00011'",
        "option-data": [
          {
            "name": "bootfile-url",
            "data": "tftp://[2001:db8:0:1::200]/boot/grub2/arm64-efi/bootaa64.efi"
          }
        ]
      }
    ],
    "subnet6": [
      {
        "id": 1,
        "subnet": "2001:db8:0:1::/64",
        "interface": "eno1",
        "pools": [
          {
            "pool": "2001:db8:0:1:d::/112"
          }
        ],
        "option-data": [
          {
            "name": "sntp-servers",
            "data": "2001:db8:0:1::1"
          },
          {
            "name": "dns-servers",
            "data": "2001:db8:0:1::200"
          },
          {
            "name": "domain-search",
            "data": "example.net"
          }
        ],
        "reservations": []
      }
    ],
    "loggers": [
      {
        "name": "kea-dhcp6",
        "output-options": [
          {
            "output": "/var/log/kea/dhcp6.log"
          }
        ],
        "severity": "INFO",
        "debuglevel": 0
      }
    ]
  }
}
EOF
</screen>
        </step>
        <step>
          <para>
          测试 Kea DHCPv6 配置：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>kea-dhcp6 -t /etc/kea/kea-dhcp6.conf</command></screen>
        </step>
        <step>
          <para>
          启用并启动 Kea DHCPv6 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now kea-dhcp6</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-dhcp-kea-verify">
      <title>验证 Kea DHCP 配置</title>
      <para>
      测试 Kea DHCP 服务器功能，确保能向 PXE 客户端提供正确的网络配置和引导文件。
    </para>
      <procedure xml:id="proc-verify-dhcp-kea">
        <title>测试 Kea DHCP 服务器</title>
        <step>
          <para>
          检查 Kea DHCPv4 服务状态：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status kea-dhcp4</command></screen>
        </step>
        <step>
          <para>
          检查 Kea DHCPv6 服务状态：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status kea-dhcp6</command></screen>
        </step>
        <step>
          <para>
          验证 DHCP 端口绑定：
        </para>
          <screen><prompt>&gt; </prompt><command>ss -ulnp | grep -E ":67|:547"</command></screen>
        </step>
        <step>
          <para>
          监控 DHCPv4 日志：
        </para>
          <screen><prompt>&gt; </prompt><command>tail -f /var/log/kea/dhcp4.log</command></screen>
        </step>
        <step>
          <para>
          监控 DHCPv6 日志：
        </para>
          <screen><prompt>&gt; </prompt><command>tail -f /var/log/kea/dhcp6.log</command></screen>
        </step>
        <step>
          <para>
          查看有效的 DHCP 租约：
        </para>
          <screen><prompt>&gt; </prompt><command>cat /var/lib/kea/dhcp4.leases</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-dhcp-kea-troubleshooting">
      <title>Kea DHCP 配置查错</title>
      <para>
      以下是为 PXE 引导环境配置 Kea DHCP 服务器时常见的问题。
    </para>
      <section xml:id="sles-pxe-server-dhcp-kea-troubleshoot-config">
        <title>配置和服务问题</title>
        <para>
        Kea 服务可能会因 JSON 配置错误或网络接口问题而无法启动。
      </para>
        <procedure xml:id="proc-debug-kea-config">
          <title>解决 Kea 配置问题</title>
          <step>
            <para>
            测试 DHCPv4 配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>kea-dhcp4 -t /etc/kea/kea-dhcp4.conf</command></screen>
          </step>
          <step>
            <para>
            测试 DHCPv6 配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>kea-dhcp6 -t /etc/kea/kea-dhcp6.conf</command></screen>
          </step>
          <step>
            <para>
            检查是否存在 JSON 语法错误：
          </para>
            <screen><prompt>&gt; </prompt><command>python3 -m json.tool /etc/kea/kea-dhcp4.conf</command></screen>
          </step>
          <step>
            <para>
            验证网络接口配置：
          </para>
            <screen><prompt>&gt; </prompt><command>ip addr show eno1</command></screen>
          </step>
          <step>
            <para>
            查看 Kea 服务日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u kea-dhcp4 -f</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dhcp-kea-troubleshoot-leases">
        <title>DHCP 租约分配问题</title>
        <para>
        客户端可能会因子网配置或地址池耗尽问题而无法获取 IP 地址。
      </para>
        <procedure xml:id="proc-debug-kea-leases">
          <title>诊断 Kea 租约问题</title>
          <step>
            <para>
            检查子网和地址池配置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -A 10 "subnet4\|pools" /etc/kea/kea-dhcp4.conf</command></screen>
          </step>
          <step>
            <para>
            实时监控租约分配：
          </para>
            <screen><prompt>&gt; </prompt><command>tail -f /var/log/kea/dhcp4.log | grep -E "ALLOC|DISCOVER"</command></screen>
          </step>
          <step>
            <para>
            检查租约数据库是否存在冲突：
          </para>
            <screen><prompt>&gt; </prompt><command>cat /var/lib/kea/dhcp4.leases | tail -20</command></screen>
          </step>
          <step>
            <para>
            验证接口绑定：
          </para>
            <screen><prompt>&gt; </prompt><command>grep interfaces /etc/kea/kea-dhcp4.conf</command></screen>
          </step>
          <step>
            <para>
            根据需要清理租约数据库：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl stop kea-dhcp4</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>mv /var/lib/kea/dhcp4.leases /var/lib/kea/dhcp4.leases.backup</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl start kea-dhcp4</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dhcp-kea-troubleshoot-pxe">
        <title>PXE 客户端类别匹配问题</title>
        <para>
        PXE 客户端能获取 IP 地址，但因客户端类别配置问题而无法获取正确的引导文件。
      </para>
        <procedure xml:id="proc-debug-kea-pxe">
          <title>Kea 客户端分类查错</title>
          <step>
            <para>
            检查客户端类别定义：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -A 5 "client-classes" /etc/kea/kea-dhcp4.conf</command></screen>
          </step>
          <step>
            <para>
            监控日志中的客户端类别匹配：
          </para>
            <screen><prompt>&gt; </prompt><command>tail -f /var/log/kea/dhcp4.log | grep -i class</command></screen>
          </step>
          <step>
            <para>
            验证供应商类别标识符模式：
          </para>
            <screen><prompt>&gt; </prompt><command>grep "PXEClient\|HTTPClient" /etc/kea/kea-dhcp4.conf</command></screen>
          </step>
          <step>
            <para>
            测试引导文件可访问性：
          </para>
            <screen><prompt>&gt; </prompt><command>curl -I http://192.168.1.200/boot/grub2/x86_64-efi/bootx64.efi</command></screen>
          </step>
          <step>
            <para>
            启用调试日志记录以获取详细的客户端分析信息：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i 's/"debuglevel": 0/"debuglevel": 99/' /etc/kea/kea-dhcp4.conf</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl restart kea-dhcp4</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dhcp-kea-troubleshoot-ipv6">
        <title>DHCPv6 特有的问题</title>
        <para>
        IPv6 DHCP 客户端需要正确的路由器通告配置，且其供应商类别选项处理方式与 IPv4 不同。
      </para>
        <procedure xml:id="proc-debug-kea-ipv6">
          <title>解决 Kea DHCPv6 问题</title>
          <step>
            <para>
            检查 DHCPv6 子网配置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -A 10 "subnet6" /etc/kea/kea-dhcp6.conf</command></screen>
          </step>
          <step>
            <para>
            验证 IPv6 路由器通告状态：
          </para>
            <screen><prompt>&gt; </prompt><command>systemctl status radvd</command></screen>
          </step>
          <step>
            <para>
            监控 DHCPv6 供应商类别匹配：
          </para>
            <screen><prompt>&gt; </prompt><command>tail -f /var/log/kea/dhcp6.log | grep "option\[16\]"</command></screen>
          </step>
          <step>
            <para>
            检查 IPv6 bootfile-url 选项格式：
          </para>
            <screen><prompt>&gt; </prompt><command>grep "bootfile-url" /etc/kea/kea-dhcp6.conf</command></screen>
          </step>
          <step>
            <para>
            测试与引导服务器的 IPv6 连接：
          </para>
            <screen><prompt>&gt; </prompt><command>ping6 2001:db8:0:1::200</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-dhcp-kea-next-steps">
      <title>后续步骤</title>
      <para>
      Kea DHCP 服务配置完毕后，PXE 客户端在 IPv4 和 IPv6 环境下，均能获取全面的网络配置和引导文件信息。客户端分类系统可根据客户端体系结构精准分配引导文件，同时支持传统 PXE 引导和现代化 HTTP 引导方式。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-dhcp-isc">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">使用 ISC DHCP 配置 DHCP 服务器</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何配置 ISC DHCP 服务器，以提供安装 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> 15 时所需的网络配置和 PXE 引导信息。<phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 不再提供 ISC dhcp-server 软件包。ISC DHCP 使用类别和子类匹配来支持多客户端体系结构的 PXE 引导和 HTTP 引导场景。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-dhcp-isc-intro">
      <title>简介</title>
      <para>
      ISC DHCP 是传统的 DHCP 服务器，通过类别和子类系统为 PXE 客户端提供网络配置和引导文件信息。尽管 ISC 已于 2022 年宣布该服务器已终止服务，但它在现有部署中仍被广泛使用，且能通过供应商类别识别功能稳定支持 PXE 和 HTTP 引导场景。
    </para>
      <important>
        <title>ISC DHCP 终止服务状态</title>
        <para>
        ISC 已于 2022 年宣布 ISC DHCP 已终止服务。对于新部署，建议改用 Kea 或 dnsmasq。本文提供此配置仅为适配现有 ISC DHCP 安装环境。
      </para>
      </important>
    </section>
    <section xml:id="sles-pxe-server-dhcp-isc-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          已安装 ISC DHCP 软件包：<package>dhcp-server</package>
        </para>
        </listitem>
        <listitem>
          <para>
          已在 <filename>/srv/tftpboot</filename> 下正确整理 PXE 引导文件
        </para>
        </listitem>
        <listitem>
          <para>
          已为 DHCP 服务配置网络接口
        </para>
        </listitem>
        <listitem>
          <para>
          具备配置 DHCP 服务的管理员权限
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-dhcp-isc-dhcpv4">
      <title>配置 ISC DHCPv4 服务器</title>
      <para>
      ISC DHCPv4 配置使用类别和子类声明来匹配 PXE 和 HTTP 客户端类型，并针对不同体系结构提供适当的引导文件。
    </para>
      <procedure xml:id="proc-configure-isc-dhcpv4">
        <title>设置 ISC DHCPv4 服务器</title>
        <step>
          <para>
          配置 ISC DHCPv4 服务器：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/dhcpd.conf &lt;&lt; 'EOF'</command>
# /etc/dhcpd.conf
#
# Sample configuration file for ISC dhcpd
#
# *** PLEASE CONFIGURE IT FIRST ***
#
# Don't forget to set the DHCPD_INTERFACE in the
# /etc/sysconfig/dhcpd file.
#

# if you want to use dynamical DNS updates, you should first read
# read /usr/share/doc/packages/dhcp-server/DDNS-howto.txt
#
ddns-updates off;

# Use this to enable / disable dynamic dns updates globally.
ddns-update-style none;

# default lease time
default-lease-time              3600;
max-lease-time                  7200;

##
## PXE / HTTP boot option declarations
##
class "pxeclients" {
        # PXEClient:Arch:00000:UNDI:002001
        match substring (option vendor-class-identifier, 0, 20);
}
class "httpclients" {
        # HTTPClient:Arch:00016:UNDI:003001
        match substring (option vendor-class-identifier, 0, 21);
}

##
## PXE / HTTP boot subclass request matches
##
subclass "pxeclients"   "PXEClient:Arch:00000" {
        next-server     192.168.1.200;
        filename        "/boot/grub2/i386-pc/core.0";
}
subclass "pxeclients"   "PXEClient:Arch:00007" {
        next-server     192.168.1.200;
        filename        "/boot/grub2/x86_64-efi/bootx64.efi";
}
subclass "pxeclients"   "PXEClient:Arch:0000e" {
        next-server     192.168.1.200;
        filename        "/boot/grub2/powerpc-ieee1275/core.elf";
}
subclass "pxeclients"   "PXEClient:Arch:00011" {
        next-server     192.168.1.200;
        filename        "/boot/grub2/arm64-efi/bootaa64.efi";
}

subclass "httpclients"  "HTTPClient:Arch:00016" {
        option vendor-class-identifier "HTTPClient";
        filename        "http://192.168.1.200/boot/grub2/x86_64-efi/bootx64.efi";
}
subclass "httpclients"  "HTTPClient:Arch:00019" {
        option vendor-class-identifier "HTTPClient";
        filename        "http://192.168.1.200/boot/grub2/arm64-efi/bootaa64.efi";
}

##
## Subnet declaration for the pxe network
##
subnet 192.168.1.0 netmask 255.255.255.0 {
        authoritative;

        range  dynamic-bootp            192.168.1.100 192.168.1.199;

        option subnet-mask              255.255.255.0;

        option routers                  192.168.1.1;
        option ntp-servers              192.168.1.1;
        option domain-name-servers      192.168.1.200;
        option domain-name              "example.net";
        option domain-search            "example.net";
}
EOF
</screen>
        </step>
        <step>
          <para>
          在 sysconfig 中配置 DHCP 接口：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>echo 'DHCPD_INTERFACE="eno1"' &gt; /etc/sysconfig/dhcpd</command></screen>
        </step>
        <step>
          <para>
          测试 DHCPv4 配置：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>dhcpd -t -cf /etc/dhcpd.conf</command></screen>
        </step>
        <step>
          <para>
          启用并启动 ISC DHCPv4 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now dhcpd</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-dhcp-isc-dhcpv6">
      <title>配置 ISC DHCPv6 服务器</title>
      <para>
      ISC DHCPv6 配置通过供应商类别匹配和正确处理 DHCPv6 选项，提供 IPv6 地址分配和引导文件信息。
    </para>
      <procedure xml:id="proc-configure-isc-dhcpv6">
        <title>设置 ISC DHCPv6 服务器</title>
        <step>
          <para>
          配置 ISC DHCPv6 服务器：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>cat &gt; /etc/dhcpd6.conf &lt;&lt; 'EOF'</command>
# /etc/dhcpd6.conf
#
# Sample DHCPv6 configuration file for ISC dhcpd
#
# *** PLEASE CONFIGURE IT FIRST ***
#
# Don't forget to set the DHCPD6_INTERFACE in the
# /etc/sysconfig/dhcpd file.
#

# if you want to use dynamical DNS updates, you should first
# read /usr/share/doc/packages/dhcp-server/DDNS-howto.txt
ddns-updates off;

# Use this to enable / disable dynamic dns updates globally.
ddns-update-style none;

# IPv6 address valid lifetime
#  (at the end the address is no longer usable by the client)
#  (set to 30 days, the usual IPv6 default)
default-lease-time 7200;

# IPv6 address preferred lifetime
#  (at the end the address is deprecated, i.e., the client should use
#   other addresses for new connections)
#  (set to 7 days, the	usual IPv6 default)
preferred-lifetime 3600;

##
## PXE / HTTP boot option declarations
##

# The dhcp6 option 16 is in fact an:
#   { uint32 enterprise-number, array of { uint16 len, string tag} vendor-class-data }
# this declaration is using the whole option data as string for substring match:
option dhcp6.vendor-class-as-string code 16 = string;

# this declaration is using the enterprise-number with 1st tag length and string:
option dhcp6.vendor-class-en-len-tag code 16 = {integer 32, integer 16, string};

class "pxeclients" {
        # PXEClient:Arch:00000:UNDI:002001
        # note: +6 to skip the enterprise-number+len until the PXEClient string
        match substring (option dhcp6.vendor-class-as-string, 6, 20);
}
class "httpclients" {
        # HTTPClient:Arch:00016:UNDI:003001
        # note: +6 to skip the enterprise-number+len until the HTTPClient string
        match substring (option dhcp6.vendor-class-as-string, 6, 21);
}

##
## PXE / HTTP boot subclass request matches
##
subclass "pxeclients"   "PXEClient:Arch:00000" {
        option dhcp6.bootfile-url "tftp://[2001:db8:0:1::200]/boot/grub2/i386-pc/core.0";
}
subclass "pxeclients"   "PXEClient:Arch:00007" {
        option dhcp6.bootfile-url "tftp://[2001:db8:0:1::200]/boot/grub2/x86_64-efi/bootx64.efi";
}
subclass "pxeclients"   "PXEClient:Arch:0000e" {
        option dhcp6.bootfile-url "tftp://[2001:db8:0:1::200]/boot/grub2/powerpc-ieee1275/core.elf";
}
subclass "pxeclients"   "PXEClient:Arch:00011" {
        option dhcp6.bootfile-url "tftp://[2001:db8:0:1::200]/boot/grub2/arm64-efi/bootaa64.efi";
}

subclass "httpclients"  "HTTPClient:Arch:00016" {
        option dhcp6.vendor-class-en-len-tag 343 10 "HTTPClient";
        option dhcp6.bootfile-url "http://[2001:db8:0:1::200]/boot/grub2/x86_64-efi/bootx64.efi";
}
subclass "httpclients"  "HTTPClient:Arch:00019" {
        option dhcp6.vendor-class-en-len-tag 343 10 "HTTPClient";
        option dhcp6.bootfile-url "http://[2001:db8:0:1::200]/boot/grub2/arm64-efi/bootaa64.efi";
}

##
## Subnet declaration for the pxe network
##
subnet6 2001:db8:0:1::/64 {
       authoritative;

       range6  2001:db8:0:1:d:: 2001:db8:0:1:d::ffff;

       option dhcp6.sntp-servers       2001:db8:0:1::1;
       option dhcp6.name-servers       2001:db8:0:1::200;
       option dhcp6.domain-search      "example.net";
}
EOF
</screen>
        </step>
        <step>
          <para>
          在 sysconfig 中配置 DHCPv6 接口：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>echo 'DHCPD6_INTERFACE="eno1"' &gt;&gt; /etc/sysconfig/dhcpd</command></screen>
        </step>
        <step>
          <para>
          测试 DHCPv6 配置：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>dhcpd -6 -t -cf /etc/dhcpd6.conf</command></screen>
        </step>
        <step>
          <para>
          启用并启动 ISC DHCPv6 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl enable --now dhcpd6</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-dhcp-isc-verify">
      <title>验证 ISC DHCP 配置</title>
      <para>
      测试 ISC DHCP 服务器功能，确保能向 PXE 客户端提供正确的网络配置和引导文件。
    </para>
      <procedure xml:id="proc-verify-dhcp-isc">
        <title>测试 ISC DHCP 服务器</title>
        <step>
          <para>
          检查 ISC DHCPv4 服务状态：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status dhcpd</command></screen>
        </step>
        <step>
          <para>
          检查 ISC DHCPv6 服务状态：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status dhcpd6</command></screen>
        </step>
        <step>
          <para>
          验证 DHCP 端口绑定：
        </para>
          <screen><prompt>&gt; </prompt><command>ss -ulnp | grep -E ":67|:547"</command></screen>
        </step>
        <step>
          <para>
          监控 DHCP 日志：
        </para>
          <screen><prompt>&gt; </prompt><command>journalctl -u dhcpd -f</command></screen>
        </step>
        <step>
          <para>
          查看有效的 DHCP 租约：
        </para>
          <screen><prompt>&gt; </prompt><command>cat /var/lib/dhcp/dhcpd.leases</command></screen>
        </step>
        <step>
          <para>
          监控 DHCPv6 活动：
        </para>
          <screen><prompt>&gt; </prompt><command>journalctl -u dhcpd6 -f</command></screen>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-dhcp-isc-troubleshooting">
      <title>ISC DHCP 配置查错</title>
      <para>
      以下是为 PXE 引导环境配置 ISC DHCP 服务器时常见的问题。
    </para>
      <section xml:id="sles-pxe-server-dhcp-isc-troubleshoot-config">
        <title>配置和服务问题</title>
        <para>
        ISC DHCP 服务会可能因配置语法错误或接口绑定问题而无法启动。
      </para>
        <procedure xml:id="proc-debug-isc-config">
          <title>解决 ISC DHCP 配置问题</title>
          <step>
            <para>
            测试 DHCPv4 配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>dhcpd -t -cf /etc/dhcpd.conf</command></screen>
          </step>
          <step>
            <para>
            测试 DHCPv6 配置语法：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>dhcpd -6 -t -cf /etc/dhcpd6.conf</command></screen>
          </step>
          <step>
            <para>
            检查接口配置：
          </para>
            <screen><prompt>&gt; </prompt><command>cat /etc/sysconfig/dhcpd</command></screen>
          </step>
          <step>
            <para>
            验证网络接口状态：
          </para>
            <screen><prompt>&gt; </prompt><command>ip addr show eno1</command></screen>
          </step>
          <step>
            <para>
            检查是否存在端口冲突：
          </para>
            <screen><prompt>&gt; </prompt><command>ss -ulnp | grep :67</command></screen>
          </step>
          <step>
            <para>
            查看详细服务日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dhcpd -xe</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dhcp-isc-troubleshoot-leases">
        <title>DHCP 租约分配问题</title>
        <para>
        客户端可能会因子网配置或授权问题而无法获取 IP 地址。
      </para>
        <procedure xml:id="proc-debug-isc-leases">
          <title>诊断 ISC DHCP 租约问题</title>
          <step>
            <para>
            检查子网和地址范围配置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -A 10 "subnet\|range" /etc/dhcpd.conf</command></screen>
          </step>
          <step>
            <para>
            验证权威服务器设置：
          </para>
            <screen><prompt>&gt; </prompt><command>grep authoritative /etc/dhcpd.conf</command></screen>
          </step>
          <step>
            <para>
            实时监控租约分配：
          </para>
            <screen><prompt>&gt; </prompt><command>tail -f /var/log/messages | grep dhcpd</command></screen>
          </step>
          <step>
            <para>
            检查租约数据库是否存在错误：
          </para>
            <screen><prompt>&gt; </prompt><command>tail -20 /var/lib/dhcp/dhcpd.leases</command></screen>
          </step>
          <step>
            <para>
            手动测试 DHCP 响应：
          </para>
            <screen><prompt>&gt; </prompt><command>dhcping -s 192.168.1.200 -h aa:bb:cc:dd:ee:ff</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dhcp-isc-troubleshoot-classes">
        <title>类别和子类匹配问题</title>
        <para>
        PXE 客户端能获取 IP 地址，但因类别匹配配置问题而无法获取正确的引导文件。
      </para>
        <procedure xml:id="proc-debug-isc-classes">
          <title>ISC DHCP 类别匹配查错</title>
          <step>
            <para>
            检查类别定义：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -A 3 "class.*clients" /etc/dhcpd.conf</command></screen>
          </step>
          <step>
            <para>
            验证子类条目：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -A 5 "subclass" /etc/dhcpd.conf</command></screen>
          </step>
          <step>
            <para>
            监控供应商类别识别：
          </para>
            <screen><prompt>&gt; </prompt><command>tail -f /var/log/messages | grep -E "PXEClient|HTTPClient"</command></screen>
          </step>
          <step>
            <para>
            测试引导文件可访问性：
          </para>
            <screen><prompt>&gt; </prompt><command>tftp 192.168.1.200 -c get /boot/grub2/x86_64-efi/bootx64.efi</command></screen>
          </step>
          <step>
            <para>
            启用详细日志记录：
          </para>
            <screen><prompt>&gt; </prompt><command>sudo</command><command>sed -i '1i\log-facility local7;' /etc/dhcpd.conf</command></screen> <screen><prompt>&gt; </prompt><command>sudo</command><command>systemctl restart dhcpd</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-dhcp-isc-troubleshoot-ipv6">
        <title>DHCPv6 供应商类别选项问题</title>
        <para>
        IPv6 DHCP 客户端的供应商类别选项处理过程较为复杂，需要特定配置才能支持 PXE 引导。
      </para>
        <procedure xml:id="proc-debug-isc-ipv6">
          <title>解决 ISC DHCPv6 问题</title>
          <step>
            <para>
            检查 DHCPv6 选项定义：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -A 3 "option dhcp6" /etc/dhcpd6.conf</command></screen>
          </step>
          <step>
            <para>
            验证供应商类别字符串解析：
          </para>
            <screen><prompt>&gt; </prompt><command>grep "substring.*6.*20\|21" /etc/dhcpd6.conf</command></screen>
          </step>
          <step>
            <para>
            监控 DHCPv6 供应商类别匹配：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dhcpd6 | grep -i vendor</command></screen>
          </step>
          <step>
            <para>
            检查 IPv6 bootfile-url 格式：
          </para>
            <screen><prompt>&gt; </prompt><command>grep "bootfile-url" /etc/dhcpd6.conf</command></screen>
          </step>
          <step>
            <para>
            验证路由器通告的依赖服务：
          </para>
            <screen><prompt>&gt; </prompt><command>systemctl status radvd</command></screen>
          </step>
          <step>
            <para>
            测试 IPv6 连接：
          </para>
            <screen><prompt>&gt; </prompt><command>ping6 2001:db8:0:1::200</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-dhcp-isc-next-steps">
      <title>后续步骤</title>
      <para>
      ISC DHCP 服务配置完毕后，PXE 客户端便可通过传统的类别和子类系统获取网络配置和引导文件信息。尽管 ISC DHCP 已终止服务，但此配置仍能为需要 PXE 和 HTTP 引导功能的现有多客户端体系结构部署提供兼容性支持。
    </para>
    </section>
  </section>
  <section role="task" xml:lang="zh-cn" version="5.2" xml:id="sles-pxe-server-validate">
    <info>
      <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">验证 PXE 服务器设置</title>
      <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
        本章介绍如何验证和测试完整的 PXE 服务器设置，确保所有组件均能正常工作，以支持 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 的网络安装。内容涵盖服务验证、网络连接测试及端到端 PXE 引导验证。
      </para>
      </abstract>
    </info>
    <section xml:id="sles-pxe-server-validate-intro">
      <title>简介</title>
      <para>
      当包括 TFTP、HTTP、DNS、DHCP 和 GRUB 2 引导加载程序服务在内的所有 PXE 服务器组件均配置完毕后，必须验证整个系统是否能正常运行。此验证过程可确保 PXE 客户端能成功引导至 Agama 安装程序，并可通过网络执行 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 安装。
    </para>
    </section>
    <section xml:id="sles-pxe-server-validate-reqs">
      <title>要求</title>
      <itemizedlist>
        <listitem>
          <para>
          所有 PXE 服务器组件均已配置且处于运行状态
        </para>
        </listitem>
        <listitem>
          <para>
          具备 PXE 引导能力的测试客户端系统
        </para>
        </listitem>
        <listitem>
          <para>
          PXE 服务器与客户端之间的网络连通
        </para>
        </listitem>
        <listitem>
          <para>
          具备监控服务器服务的管理员权限
        </para>
        </listitem>
      </itemizedlist>
    </section>
    <section xml:id="sles-pxe-server-validate-services">
      <title>验证 PXE 服务器服务</title>
      <para>
      在使用 PXE 客户端测试前，先验证所有必要的 PXE 服务器服务是否正常运行且配置正确。
    </para>
      <procedure xml:id="proc-validate-services">
        <title>检查 PXE 服务器服务状态</title>
        <step>
          <para>
          验证 TFTP 服务状态：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status tftp.socket</command></screen>
          <para>
          预期结果：服务处于活跃状态，且在 69 端口侦听。
        </para>
        </step>
        <step>
          <para>
          检查 nginx HTTP 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status nginx</command></screen>
          <para>
          预期结果：服务处于活跃状态，且在 80 端口侦听。
        </para>
        </step>
        <step>
          <para>
          验证 DNS 服务（如果使用 dnsmasq）：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status dnsmasq</command></screen>
          <para>
          预期结果：服务处于活跃状态，且在 53 端口侦听。
        </para>
        </step>
        <step>
          <para>
          检查 DHCP 服务状态（选择相应的服务）：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status dhcpd</command></screen>
          <para>
          如果使用 dnsmasq DHCP：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status dnsmasq</command></screen>
          <para>
          如果使用 Kea DHCP：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status kea-dhcp4 kea-dhcp6</command></screen>
          <para>
          预期结果：DHCP 服务处于活跃状态，且在适当的端口侦听。
        </para>
        </step>
        <step>
          <para>
          验证 IPv6 路由器通告（如果已配置）：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status radvd</command></screen>
          <para>
          预期结果：服务处于活跃状态（适用于 IPv6 环境）。
        </para>
        </step>
        <step>
          <para>
          检查 NTP 服务：
        </para>
          <screen><prompt>&gt; </prompt><command>systemctl status chronyd</command></screen>
          <para>
          预期结果：服务处于活跃状态且已完成时间同步。
        </para>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-validate-network">
      <title>测试网络连接和文件访问</title>
      <para>
      验证 PXE 客户端能否通过 TFTP 和 HTTP 两种协议访问网络中的引导文件和安装内容。
    </para>
      <procedure xml:id="proc-validate-network">
        <title>测试网络文件访问</title>
        <step>
          <para>
          测试能否通过 TFTP 访问引导加载程序文件：
        </para>
          <screen><prompt>&gt; </prompt><command>tftp localhost -c get /boot/grub2/x86_64-efi/bootx64.efi /tmp/test-bootx64.efi</command></screen>
          <para>
          验证是否成功检索了文件：
        </para>
          <screen><prompt>&gt; </prompt><command>file /tmp/test-bootx64.efi</command></screen>
          <para>
          清理测试文件：
        </para>
          <screen><prompt>&gt; </prompt><command>rm /tmp/test-bootx64.efi</command></screen>
        </step>
        <step>
          <para>
          测试能否通过 HTTP 访问 GRUB 2 配置：
        </para>
          <screen><prompt>&gt; </prompt><command>curl -I http://localhost/boot/grub2/grub.cfg</command></screen>
          <para>
          预期结果：返回 HTTP 200 OK 响应。
        </para>
        </step>
        <step>
          <para>
          验证能否通过 HTTP 访问安装程序文件：
        </para>
          <screen><prompt>&gt; </prompt><command>curl -I http://localhost/boot/images/SLES-16.0/x86_64/liveiso/LiveOS/squashfs.img</command></screen>
          <para>
          预期结果：返回 HTTP 200 OK 响应，并包含正确的内容长度。
        </para>
        </step>
        <step>
          <para>
          测试 DNS 解析（如果配置了本地 DNS）：
        </para>
          <screen><prompt>&gt; </prompt><command>nslookup pxe.example.net localhost</command></screen>
          <para>
          预期结果：能正确解析出 A 记录和 AAAA 记录。
        </para>
        </step>
        <step>
          <para>
          验证自动索引目录的浏览功能：
        </para>
          <screen><prompt>&gt; </prompt><command>curl http://localhost/boot/</command></screen>
          <para>
          预期结果：显示目录列表，包含引导文件。
        </para>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-validate-dhcp">
      <title>验证 DHCP 功能</title>
      <para>
      测试 DHCP 服务器的响应，确认其能为不同类型的客户端提供正确的引导信息。
    </para>
      <procedure xml:id="proc-validate-dhcp">
        <title>测试 DHCP 服务器响应</title>
        <step>
          <para>
          检查 DHCP 端口绑定：
        </para>
          <screen><prompt>&gt; </prompt><command>ss -ulnp | grep -E ":67|:547"</command></screen>
          <para>
          预期结果：DHCP 服务在 67 端口 (IPv4) 和 547 端口 (IPv6) 侦听。
        </para>
        </step>
        <step>
          <para>
          实时监控 DHCP 请求：
        </para>
          <screen><prompt>&gt; </prompt><command>journalctl -u dhcpd -f</command></screen>
          <para>
          如果使用 dnsmasq：
        </para>
          <screen><prompt>&gt; </prompt><command>journalctl -u dnsmasq -f</command></screen>
          <para>
          使此命令保持运行状态，以便在测试期间观察 DHCP 活动。
        </para>
        </step>
        <step>
          <para>
          使用 dhcping（如果可用）测试 DHCP 响应：
        </para>
          <screen><prompt>&gt; </prompt><command>dhcping -s 192.168.1.200</command></screen>
          <para>
          预期结果：从服务器收到成功的 DHCP 响应。
        </para>
        </step>
        <step>
          <para>
          查看有效的 DHCP 租约：
        </para>
          <screen><prompt>&gt; </prompt><command>cat /var/lib/dhcp/dhcpd.leases</command></screen>
          <para>
          如果使用 Kea：
        </para>
          <screen><prompt>&gt; </prompt><command>cat /var/lib/kea/dhcp4.leases</command></screen>
          <para>
          预期结果：测试客户端的租约条目存在。
        </para>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-validate-pxe-boot">
      <title>端到端 PXE 引导测试</title>
      <para>
      使用实际客户端系统执行完整的 PXE 引导测试，验证从 DHCP 地址获取到 Agama 安装程序启动的整个流程。
    </para>
      <procedure xml:id="proc-validate-pxe-boot">
        <title>测试完整的 PXE 引导流程</title>
        <step>
          <para>
          准备测试客户端系统：
        </para>
          <itemizedlist>
            <listitem>
              <para>
              配置 BIOS/UEFI 以启用网络引导功能
            </para>
            </listitem>
            <listitem>
              <para>
              将网络引导设置为第一引导优先级
            </para>
            </listitem>
            <listitem>
              <para>
              将客户端连接到 PXE 服务器所在的同一网络
            </para>
            </listitem>
          </itemizedlist>
        </step>
        <step>
          <para>
          在客户端引导期间监控 PXE 服务器日志：
        </para>
          <screen><prompt>&gt; </prompt><command>journalctl -f | grep -E "dhcp|tftp|nginx"</command></screen>
        </step>
        <step>
          <para>
          引导测试客户端，并观察以下流程是否正常：
        </para>
          <orderedlist>
            <listitem>
              <para>
              客户端通过 DHCP 获取 IP 地址
            </para>
            </listitem>
            <listitem>
              <para>
              客户端通过 TFTP 下载引导加载程序
            </para>
            </listitem>
            <listitem>
              <para>
              显示包含安装选项的 GRUB 2 菜单
            </para>
            </listitem>
            <listitem>
              <para>
              通过 HTTP 加载内核和 initrd
            </para>
            </listitem>
            <listitem>
              <para>
              Agama 安装程序成功启动
            </para>
            </listitem>
          </orderedlist>
        </step>
        <step>
          <para>
          通过测试不同类型的客户端，验证客户端体系结构检测功能：
        </para>
          <itemizedlist>
            <listitem>
              <para>
              传统 BIOS x86_64 系统（应获取 core.0）
            </para>
            </listitem>
            <listitem>
              <para>
              UEFI x86_64 系统（应获取 bootx64.efi）
            </para>
            </listitem>
            <listitem>
              <para>
              UEFI aarch64 系统（应获取 bootaa64.efi）
            </para>
            </listitem>
          </itemizedlist>
        </step>
        <step>
          <para>
          测试 IPv6 PXE 引导（如果已配置 IPv6）：
        </para>
          <itemizedlist>
            <listitem>
              <para>
              在测试客户端上启用仅限 IPv6 的网络配置
            </para>
            </listitem>
            <listitem>
              <para>
              验证 DHCPv6 地址分配
            </para>
            </listitem>
            <listitem>
              <para>
              确认 IPv6 bootfile-url 已正确分发
            </para>
            </listitem>
          </itemizedlist>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-validate-installation">
      <title>验证 Agama 安装程序功能</title>
      <para>
      验证 Agama 安装程序能否正常启动，且能访问安装源以完成 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 安装。
    </para>
      <procedure xml:id="proc-validate-agama">
        <title>测试 Agama 安装程序的启动</title>
        <step>
          <para>
          验证 Agama Web 界面的可访问性：
        </para>
          <para>
          在客户端引导过程中，记录分配到的 IP 地址，通过以下方式访问：
        </para>
          <screen>http://<replaceable>CLIENT_IP_ADDRESS</replaceable></screen>
          <para>
          预期结果：Agama Web 界面能成功加载。
        </para>
        </step>
        <step>
          <para>
          在客户端上检查 Agama 安装程序日志：
        </para>
          <para>
          切换到控制台（按 Alt+F2），运行以下命令：
        </para>
          <screen><prompt role="root"># </prompt><command>journalctl -u agama-web-server -f</command></screen>
          <para>
          预期结果：Agama 启动过程中无严重错误。
        </para>
        </step>
        <step>
          <para>
          验证安装源的可访问性：
        </para>
          <para>
          对于完整 ISO 安装，检查储存库的访问情况：
        </para>
          <screen><prompt role="root"># </prompt><command>curl -I http://192.168.1.200/install/SLES-16.0/x86_64/</command></screen>
          <para>
          预期结果：返回 HTTP 200 OK 响应，并显示目录列表。
        </para>
        </step>
        <step>
          <para>
          测试软件包安装能力：
        </para>
          <para>
          在 Agama 界面中，验证以下功能：
        </para>
          <itemizedlist>
            <listitem>
              <para>
              系统能检测到可用磁盘
            </para>
            </listitem>
            <listitem>
              <para>
              网络配置保持正常
            </para>
            </listitem>
            <listitem>
              <para>
              软件包储存库可访问
            </para>
            </listitem>
            <listitem>
              <para>
              安装流程能正常执行至完成
            </para>
            </listitem>
          </itemizedlist>
        </step>
      </procedure>
    </section>
    <section xml:id="sles-pxe-server-validate-troubleshooting">
      <title>排查验证失败问题</title>
      <para>
      以下是 PXE 服务器验证过程中常见的问题及其解决步骤。
    </para>
      <section xml:id="sles-pxe-server-validate-troubleshoot-dhcp">
        <title>DHCP 分配失败</title>
        <para>
        客户端在 PXE 引导过程中无法获取 IP 地址。
      </para>
        <procedure xml:id="proc-troubleshoot-dhcp-validation">
          <title>解决 DHCP 验证问题</title>
          <step>
            <para>
            检查 DHCP 服务冲突：
          </para>
            <screen><prompt>&gt; </prompt><command>ss -ulnp | grep :67</command></screen>
          </step>
          <step>
            <para>
            验证网络接口是否已启用：
          </para>
            <screen><prompt>&gt; </prompt><command>ip addr show eno1</command></screen>
          </step>
          <step>
            <para>
            检查 DHCP 地址范围可用性：
          </para>
            <screen><prompt>&gt; </prompt><command>nmap -sn 192.168.1.100-199</command></screen>
          </step>
          <step>
            <para>
            监控 DHCP 日志中的错误：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u dhcpd | tail -50</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-validate-troubleshoot-boot">
        <title>引导文件分发失败</title>
        <para>
        客户端能获取 IP 地址，但无法下载引导文件。
      </para>
        <procedure xml:id="proc-troubleshoot-boot-validation">
          <title>解决引导文件问题</title>
          <step>
            <para>
            验证 TFTP 服务可访问性：
          </para>
            <screen><prompt>&gt; </prompt><command>tftp 192.168.1.200 -c get /boot/grub2/x86_64-efi/bootx64.efi</command></screen>
          </step>
          <step>
            <para>
            检查文件权限：
          </para>
            <screen><prompt>&gt; </prompt><command>ls -la /srv/tftpboot/boot/grub2/x86_64-efi/</command></screen>
          </step>
          <step>
            <para>
            监控 TFTP 访问日志：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -u tftp.socket -f</command></screen>
          </step>
          <step>
            <para>
            验证客户端体系结构检测：
          </para>
            <screen><prompt>&gt; </prompt><command>grep -E "PXEClient|HTTPClient" /var/log/messages</command></screen>
          </step>
        </procedure>
      </section>
      <section xml:id="sles-pxe-server-validate-troubleshoot-installer">
        <title>Agama 安装程序启动失败</title>
        <para>
        引导文件已成功加载，但 Agama 安装程序无法启动。
      </para>
        <procedure xml:id="proc-troubleshoot-installer-validation">
          <title>解决 Agama 启动问题</title>
          <step>
            <para>
            检查能否通过 HTTP 访问安装程序文件：
          </para>
            <screen><prompt>&gt; </prompt><command>curl -I http://192.168.1.200/boot/images/SLES-16.0/x86_64/liveiso/LiveOS/squashfs.img</command></screen>
          </step>
          <step>
            <para>
            验证 GRUB 2 配置中的内核参数语法：
          </para>
            <screen><prompt>&gt; </prompt><command>grep "root=live:" /srv/tftpboot/boot/grub2/menu.cfg</command></screen>
          </step>
          <step>
            <para>
            监控客户端引导过程：
          </para>
            <screen><prompt>&gt; </prompt><command>journalctl -f | grep -E "kernel|initrd|agama"</command></screen>
          </step>
          <step>
            <para>
            检查网络配置持久性：
          </para>
            <screen><prompt role="root"># </prompt><command>ip addr show</command></screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="sles-pxe-server-validate-checklist">
      <title>PXE 服务器验证清单</title>
      <para>
      使用以下清单系统性地验证 PXE 服务器配置的所有方面。
    </para>
      <table xml:id="table-pxe-validation-checklist">
        <title>PXE 服务器验证清单</title>
        <tgroup cols="3">
          <colspec colnum="1" colname="col1" colwidth="30*"/>
          <colspec colnum="2" colname="col2" colwidth="50*"/>
          <colspec colnum="3" colname="col3" colwidth="20*"/>
          <thead>
            <row>
              <entry>组件</entry>
              <entry>验证步骤</entry>
              <entry>状态</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>TFTP 服务</entry>
              <entry>服务处于活跃状态、在 69 端口侦听、文件可访问</entry>
              <entry>☐</entry>
            </row>
            <row>
              <entry>HTTP 服务</entry>
              <entry>nginx 处于活跃状态、在 80 端口侦听、安装程序文件可访问</entry>
              <entry>☐</entry>
            </row>
            <row>
              <entry>DNS 服务</entry>
              <entry>主机名解析正常、在 53 端口侦听</entry>
              <entry>☐</entry>
            </row>
            <row>
              <entry>DHCP 服务</entry>
              <entry>IP 分配正常、引导选项已传递</entry>
              <entry>☐</entry>
            </row>
            <row>
              <entry>GRUB 2 配置</entry>
              <entry>菜单加载正常、体系结构检测正常</entry>
              <entry>☐</entry>
            </row>
            <row>
              <entry>IPv6 支持</entry>
              <entry>路由器通告处于活跃状态、DHCPv6 功能正常</entry>
              <entry>☐</entry>
            </row>
            <row>
              <entry>PXE 引导</entry>
              <entry>客户端成功引导、获取了正确的引导加载程序</entry>
              <entry>☐</entry>
            </row>
            <row>
              <entry>Agama 安装程序</entry>
              <entry>安装程序启动、Web 界面可访问</entry>
              <entry>☐</entry>
            </row>
            <row>
              <entry>安装源</entry>
              <entry>储存库可访问、软件包可安装</entry>
              <entry>☐</entry>
            </row>
            <row>
              <entry>网络持久性</entry>
              <entry>安装过程中网络配置保持正常</entry>
              <entry>☐</entry>
            </row>
          </tbody>
        </tgroup>
      </table>
    </section>
    <section xml:id="sles-pxe-server-validate-conclusion">
      <title>验证总结</title>
      <para>
      经过正确验证的 PXE 服务器应能展现完整的端到端功能 - 从客户端网络引导到 Agama 安装程序启动的整个流程均可成功完成。所有服务需无错误运行，且客户端应能通过网络完成 <phrase><phrase os="sles;sles_ai">SUSE Linux Enterprise Server</phrase></phrase> <phrase><phrase os="sles">16.0</phrase></phrase> 安装。定期执行验证测试可确保 PXE 基础架构在自动化部署场景中持续可靠运行。
    </para>
    </section>
  </section>
  <section version="5.2" xml:id="legal-disclaimer">
    <info>
      <title xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink">法律声明</title>
    </info>
    <para> 版权所有© 2006–<?dbtimestamp format="Y"?> SUSE LLC 和撰稿人。保留所有权利。</para>
    <para>
    根据 GNU 自由文档许可证 (GNU Free Documentation License) 版本 1.2 或（根据您的选择）版本 1.3 中的条款，在此授予您复制、分发和/或修改本文档的权限；本版权声明和许可证附带不可变部分。许可版本 1.2 的副本包含在<quote>GNU Free Documentation License</quote>部分。
  </para>
    <para>
    有关 SUSE 商标，请参见 <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://www.suse.com/company/legal/"/>。所有其他第三方商标分别为相应所有者的财产。商标符号（®、™ 等）代表 SUSE 及其关联公司的商标。星号 (*) 代表第三方商标。
  </para>
    <para>
    本指南力求涵盖所有细节，但这不能确保本指南准确无误。SUSE LLC 及其关联公司、作者和译者对于可能出现的错误或由此造成的后果皆不承担责任。
  </para>
  </section>
  <appendix xmlns:its="http://www.w3.org/2005/11/its" version="5.2" role="legal" its:translate="no" xml:id="doc-gfdl-license">
    <info>
      <title xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink">GNU Free Documentation License</title>
    </info>
    <para>
  Copyright (C) 2000, 2001, 2002 Free Software Foundation, Inc. 51 Franklin St,
  Fifth Floor, Boston, MA 02110-1301 USA. Everyone is permitted to copy and
  distribute verbatim copies of this license document, but changing it is not
  allowed.
 </para>
    <bridgehead renderas="sect4">
    0. PREAMBLE
  </bridgehead>
    <para>
  The purpose of this License is to make a manual, textbook, or other
  functional and useful document "free" in the sense of freedom: to assure
  everyone the effective freedom to copy and redistribute it, with or without
  modifying it, either commercially or non-commercially. Secondarily, this
  License preserves for the author and publisher a way to get credit for their
  work, while not being considered responsible for modifications made by
  others.
 </para>
    <para>
  This License is a kind of "copyleft", which means that derivative works of
  the document must themselves be free in the same sense. It complements the
  GNU General Public License, which is a copyleft license designed for free
  software.
 </para>
    <para>
  We have designed this License to use it for manuals for free software,
  because free software needs free documentation: a free program should come
  with manuals providing the same freedoms that the software does. But this
  License is not limited to software manuals; it can be used for any textual
  work, regardless of subject matter or whether it is published as a printed
  book. We recommend this License principally for works whose purpose is
  instruction or reference.
 </para>
    <bridgehead renderas="sect4">
    1. APPLICABILITY AND DEFINITIONS
  </bridgehead>
    <para>
  This License applies to any manual or other work, in any medium, that
  contains a notice placed by the copyright holder saying it can be distributed
  under the terms of this License. Such a notice grants a world-wide,
  royalty-free license, unlimited in duration, to use that work under the
  conditions stated herein. The "Document", below, refers to any such manual or
  work. Any member of the public is a licensee, and is addressed as "you". You
  accept the license if you copy, modify or distribute the work in a way
  requiring permission under copyright law.
 </para>
    <para>
  A "Modified Version" of the Document means any work containing the Document
  or a portion of it, either copied verbatim, or with modifications and/or
  translated into another language.
 </para>
    <para>
  A "Secondary Section" is a named appendix or a front-matter section of the
  Document that deals exclusively with the relationship of the publishers or
  authors of the Document to the Document's overall subject (or to related
  matters) and contains nothing that could fall directly within that overall
  subject. (Thus, if the Document is in part a textbook of mathematics, a
  Secondary Section may not explain any mathematics.) The relationship could be
  a matter of historical connection with the subject or with related matters,
  or of legal, commercial, philosophical, ethical or political position
  regarding them.
 </para>
    <para>
  The "Invariant Sections" are certain Secondary Sections whose titles are
  designated, as being those of Invariant Sections, in the notice that says
  that the Document is released under this License. If a section does not fit
  the above definition of Secondary then it is not allowed to be designated as
  Invariant. The Document may contain zero Invariant Sections. If the Document
  does not identify any Invariant Sections then there are none.
 </para>
    <para>
  The "Cover Texts" are certain short passages of text that are listed, as
  Front-Cover Texts or Back-Cover Texts, in the notice that says that the
  Document is released under this License. A Front-Cover Text may be at most 5
  words, and a Back-Cover Text may be at most 25 words.
 </para>
    <para>
  A "Transparent" copy of the Document means a machine-readable copy,
  represented in a format whose specification is available to the general
  public, that is suitable for revising the document straightforwardly with
  generic text editors or (for images composed of pixels) generic paint
  programs or (for drawings) some widely available drawing editor, and that is
  suitable for input to text formatters or for automatic translation to a
  variety of formats suitable for input to text formatters. A copy made in an
  otherwise Transparent file format whose markup, or absence of markup, has
  been arranged to thwart or discourage subsequent modification by readers is
  not Transparent. An image format is not Transparent if used for any
  substantial amount of text. A copy that is not "Transparent" is called
  "Opaque".
 </para>
    <para>
  Examples of suitable formats for Transparent copies include plain ASCII
  without markup, Texinfo input format, LaTeX input format, SGML or XML using a
  publicly available DTD, and standard-conforming simple HTML, PostScript or
  PDF designed for human modification. Examples of transparent image formats
  include PNG, XCF and JPG. Opaque formats include proprietary formats that can
  be read and edited only by proprietary word processors, SGML or XML for which
  the DTD and/or processing tools are not generally available, and the
  machine-generated HTML, PostScript or PDF produced by some word processors
  for output purposes only.
 </para>
    <para>
  The "Title Page" means, for a printed book, the title page itself, plus such
  following pages as are needed to hold, legibly, the material this License
  requires to appear in the title page. For works in formats which do not have
  any title page as such, "Title Page" means the text near the most prominent
  appearance of the work's title, preceding the beginning of the body of the
  text.
 </para>
    <para>
  A section "Entitled XYZ" means a named subunit of the Document whose title
  either is precisely XYZ or contains XYZ in parentheses following text that
  translates XYZ in another language. (Here XYZ stands for a specific section
  name mentioned below, such as "Acknowledgements", "Dedications",
  "Endorsements", or "History".) To "Preserve the Title" of such a section when
  you modify the Document means that it remains a section "Entitled XYZ"
  according to this definition.
 </para>
    <para>
  The Document may include Warranty Disclaimers next to the notice which states
  that this License applies to the Document. These Warranty Disclaimers are
  considered to be included by reference in this License, but only as regards
  disclaiming warranties: any other implication that these Warranty Disclaimers
  may have is void and has no effect on the meaning of this License.
 </para>
    <bridgehead renderas="sect4">
    2. VERBATIM COPYING
  </bridgehead>
    <para>
  You may copy and distribute the Document in any medium, either commercially
  or non-commercially, provided that this License, the copyright notices, and
  the license notice saying this License applies to the Document are reproduced
  in all copies, and that you add no other conditions whatsoever to those of
  this License. You may not use technical measures to obstruct or control the
  reading or further copying of the copies you make or distribute. However, you
  may accept compensation in exchange for copies. If you distribute a large
  enough number of copies you must also follow the conditions in section 3.
 </para>
    <para>
  You may also lend copies, under the same conditions stated above, and you may
  publicly display copies.
 </para>
    <bridgehead renderas="sect4">
    3. COPYING IN QUANTITY
  </bridgehead>
    <para>
  If you publish printed copies (or copies in media that commonly have printed
  covers) of the Document, numbering more than 100, and the Document's license
  notice requires Cover Texts, you must enclose the copies in covers that
  carry, clearly and legibly, all these Cover Texts: Front-Cover Texts on the
  front cover, and Back-Cover Texts on the back cover. Both covers must also
  clearly and legibly identify you as the publisher of these copies. The front
  cover must present the full title with all words of the title equally
  prominent and visible. You may add other material on the covers in addition.
  Copying with changes limited to the covers, as long as they preserve the
  title of the Document and satisfy these conditions, can be treated as
  verbatim copying in other respects.
 </para>
    <para>
  If the required texts for either cover are too voluminous to fit legibly, you
  should put the first ones listed (as many as fit reasonably) on the actual
  cover, and continue the rest onto adjacent pages.
 </para>
    <para>
  If you publish or distribute Opaque copies of the Document numbering more
  than 100, you must either include a machine-readable Transparent copy along
  with each Opaque copy, or state in or with each Opaque copy a
  computer-network location from which the general network-using public has
  access to download using public-standard network protocols a complete
  Transparent copy of the Document, free of added material. If you use the
  latter option, you must take reasonably prudent steps, when you begin
  distribution of Opaque copies in quantity, to ensure that this Transparent
  copy will remain thus accessible at the stated location until at least one
  year after the last time you distribute an Opaque copy (directly or through
  your agents or retailers) of that edition to the public.
 </para>
    <para>
  It is requested, but not required, that you contact the authors of the
  Document well before redistributing any large number of copies, to give them
  a chance to provide you with an updated version of the Document.
 </para>
    <bridgehead renderas="sect4">
    4. MODIFICATIONS
  </bridgehead>
    <para>
  You may copy and distribute a Modified Version of the Document under the
  conditions of sections 2 and 3 above, provided that you release the Modified
  Version under precisely this License, with the Modified Version filling the
  role of the Document, thus licensing distribution and modification of the
  Modified Version to whoever possesses a copy of it. In addition, you must do
  these things in the Modified Version:
 </para>
    <orderedlist numeration="upperalpha" spacing="normal">
      <listitem>
        <para>
    Use in the Title Page (and on the covers, if any) a title distinct from
    that of the Document, and from those of previous versions (which should, if
    there were any, be listed in the History section of the Document). You may
    use the same title as a previous version if the original publisher of that
    version gives permission.
   </para>
      </listitem>
      <listitem>
        <para>
    List on the Title Page, as authors, one or more persons or entities
    responsible for authorship of the modifications in the Modified Version,
    together with at least five of the principal authors of the Document (all
    of its principal authors, if it has fewer than five), unless they release
    you from this requirement.
   </para>
      </listitem>
      <listitem>
        <para>
    State on the Title page the name of the publisher of the Modified Version,
    as the publisher.
   </para>
      </listitem>
      <listitem>
        <para>
    Preserve all the copyright notices of the Document.
   </para>
      </listitem>
      <listitem>
        <para>
    Add an appropriate copyright notice for your modifications adjacent to the
    other copyright notices.
   </para>
      </listitem>
      <listitem>
        <para>
    Include, immediately after the copyright notices, a license notice giving
    the public permission to use the Modified Version under the terms of this
    License, in the form shown in the Addendum below.
   </para>
      </listitem>
      <listitem>
        <para>
    Preserve in that license notice the full lists of Invariant Sections and
    required Cover Texts given in the Document's license notice.
   </para>
      </listitem>
      <listitem>
        <para>
    Include an unaltered copy of this License.
   </para>
      </listitem>
      <listitem>
        <para>
    Preserve the section Entitled "History", Preserve its Title, and add to it
    an item stating at least the title, year, new authors, and publisher of the
    Modified Version as given on the Title Page. If there is no section
    Entitled "History" in the Document, create one stating the title, year,
    authors, and publisher of the Document as given on its Title Page, then add
    an item describing the Modified Version as stated in the previous sentence.
   </para>
      </listitem>
      <listitem>
        <para>
    Preserve the network location, if any, given in the Document for public
    access to a Transparent copy of the Document, and likewise the network
    locations given in the Document for previous versions it was based on.
    These may be placed in the "History" section. You may omit a network
    location for a work that was published at least four years before the
    Document itself, or if the original publisher of the version it refers to
    gives permission.
   </para>
      </listitem>
      <listitem>
        <para>
    For any section Entitled "Acknowledgements" or "Dedications", Preserve the
    Title of the section, and preserve in the section all the substance and
    tone of each of the contributor acknowledgements and/or dedications given
    therein.
   </para>
      </listitem>
      <listitem>
        <para>
    Preserve all the Invariant Sections of the Document, unaltered in their
    text and in their titles. Section numbers or the equivalent are not
    considered part of the section titles.
   </para>
      </listitem>
      <listitem>
        <para>
    Delete any section Entitled "Endorsements". Such a section may not be
    included in the Modified Version.
   </para>
      </listitem>
      <listitem>
        <para>
    Do not retitle any existing section to be Entitled "Endorsements" or to
    conflict in title with any Invariant Section.
   </para>
      </listitem>
      <listitem>
        <para>
    Preserve any Warranty Disclaimers.
   </para>
      </listitem>
    </orderedlist>
    <para>
  If the Modified Version includes new front-matter sections or appendices that
  qualify as Secondary Sections and contain no material copied from the
  Document, you may at your option designate some or all of these sections as
  invariant. To do this, add their titles to the list of Invariant Sections in
  the Modified Version's license notice. These titles must be distinct from any
  other section titles.
 </para>
    <para>
  You may add a section Entitled "Endorsements", provided it contains nothing
  but endorsements of your Modified Version by various parties--for example,
  statements of peer review or that the text has been approved by an
  organization as the authoritative definition of a standard.
 </para>
    <para>
  You may add a passage of up to five words as a Front-Cover Text, and a
  passage of up to 25 words as a Back-Cover Text, to the end of the list of
  Cover Texts in the Modified Version. Only one passage of Front-Cover Text and
  one of Back-Cover Text may be added by (or through arrangements made by) any
  one entity. If the Document already includes a cover text for the same cover,
  previously added by you or by arrangement made by the same entity you are
  acting on behalf of, you may not add another; but you may replace the old
  one, on explicit permission from the previous publisher that added the old
  one.
 </para>
    <para>
  The author(s) and publisher(s) of the Document do not by this License give
  permission to use their names for publicity for or to assert or imply
  endorsement of any Modified Version.
 </para>
    <bridgehead renderas="sect4">
    5. COMBINING DOCUMENTS
  </bridgehead>
    <para>
  You may combine the Document with other documents released under this
  License, under the terms defined in section 4 above for modified versions,
  provided that you include in the combination all of the Invariant Sections of
  all of the original documents, unmodified, and list them all as Invariant
  Sections of your combined work in its license notice, and that you preserve
  all their Warranty Disclaimers.
 </para>
    <para>
  The combined work need only contain one copy of this License, and multiple
  identical Invariant Sections may be replaced with a single copy. If there are
  multiple Invariant Sections with the same name but different contents, make
  the title of each such section unique by adding at the end of it, in
  parentheses, the name of the original author or publisher of that section if
  known, or else a unique number. Make the same adjustment to the section
  titles in the list of Invariant Sections in the license notice of the
  combined work.
 </para>
    <para>
  In the combination, you must combine any sections Entitled "History" in the
  various original documents, forming one section Entitled "History"; likewise
  combine any sections Entitled "Acknowledgements", and any sections Entitled
  "Dedications". You must delete all sections Entitled "Endorsements".
 </para>
    <bridgehead renderas="sect4">
    6. COLLECTIONS OF DOCUMENTS
  </bridgehead>
    <para>
  You may make a collection consisting of the Document and other documents
  released under this License, and replace the individual copies of this
  License in the various documents with a single copy that is included in the
  collection, provided that you follow the rules of this License for verbatim
  copying of each of the documents in all other respects.
 </para>
    <para>
  You may extract a single document from such a collection, and distribute it
  individually under this License, provided you insert a copy of this License
  into the extracted document, and follow this License in all other respects
  regarding verbatim copying of that document.
 </para>
    <bridgehead renderas="sect4">
    7. AGGREGATION WITH INDEPENDENT WORKS
  </bridgehead>
    <para>
  A compilation of the Document or its derivatives with other separate and
  independent documents or works, in or on a volume of a storage or
  distribution medium, is called an "aggregate" if the copyright resulting from
  the compilation is not used to limit the legal rights of the compilation's
  users beyond what the individual works permit. When the Document is included
  in an aggregate, this License does not apply to the other works in the
  aggregate which are not themselves derivative works of the Document.
 </para>
    <para>
  If the Cover Text requirement of section 3 is applicable to these copies of
  the Document, then if the Document is less than one half of the entire
  aggregate, the Document's Cover Texts may be placed on covers that bracket
  the Document within the aggregate, or the electronic equivalent of covers if
  the Document is in electronic form. Otherwise they must appear on printed
  covers that bracket the whole aggregate.
 </para>
    <bridgehead renderas="sect4">
    8. TRANSLATION
  </bridgehead>
    <para>
  Translation is considered a kind of modification, so you may distribute
  translations of the Document under the terms of section 4. Replacing
  Invariant Sections with translations requires special permission from their
  copyright holders, but you may include translations of some or all Invariant
  Sections in addition to the original versions of these Invariant Sections.
  You may include a translation of this License, and all the license notices in
  the Document, and any Warranty Disclaimers, provided that you also include
  the original English version of this License and the original versions of
  those notices and disclaimers. In case of a disagreement between the
  translation and the original version of this License or a notice or
  disclaimer, the original version will prevail.
 </para>
    <para>
  If a section in the Document is Entitled "Acknowledgements", "Dedications",
  or "History", the requirement (section 4) to Preserve its Title (section 1)
  will typically require changing the actual title.
 </para>
    <bridgehead renderas="sect4">
    9. TERMINATION
  </bridgehead>
    <para>
  You may not copy, modify, sublicense, or distribute the Document except as
  expressly provided for under this License. Any other attempt to copy, modify,
  sublicense or distribute the Document is void, and will automatically
  terminate your rights under this License. However, parties who have received
  copies, or rights, from you under this License will not have their licenses
  terminated so long as such parties remain in full compliance.
 </para>
    <bridgehead renderas="sect4">
    10. FUTURE REVISIONS OF THIS LICENSE
  </bridgehead>
    <para>
  The Free Software Foundation may publish new, revised versions of the GNU
  Free Documentation License from time to time. Such new versions will be
  similar in spirit to the present version, but may differ in detail to address
  new problems or concerns. See
  <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://www.gnu.org/copyleft/"/>.
 </para>
    <para>
  Each version of the License is given a distinguishing version number. If the
  Document specifies that a particular numbered version of this License "or any
  later version" applies to it, you have the option of following the terms and
  conditions either of that specified version or of any later version that has
  been published (not as a draft) by the Free Software Foundation. If the
  Document does not specify a version number of this License, you may choose
  any version ever published (not as a draft) by the Free Software Foundation.
 </para>
    <bridgehead renderas="sect4">
    ADDENDUM: How to use this License for your documents
  </bridgehead>
    <screen>Copyright (c) YEAR YOUR NAME.
Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.2
or any later version published by the Free Software Foundation;
with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
A copy of the license is included in the section entitled “GNU
Free Documentation License”.</screen>
    <para>
  If you have Invariant Sections, Front-Cover Texts and Back-Cover Texts,
  replace the “with...Texts.” line with this:
 </para>
    <screen>with the Invariant Sections being LIST THEIR TITLES, with the
Front-Cover Texts being LIST, and with the Back-Cover Texts being LIST.</screen>
    <para>
  If you have Invariant Sections without Cover Texts, or some other combination
  of the three, merge those two alternatives to suit the situation.
 </para>
    <para>
  If your document contains nontrivial examples of program code, we recommend
  releasing these examples in parallel under your choice of free software
  license, such as the GNU General Public License, to permit their use in free
  software.
</para>
  </appendix>
</article>