<?xml version="1.0" encoding="UTF-8"?>
<!-- This file originates from the project https://github.com/openSUSE/doc-kit -->
<!-- This file can be edited downstream. -->
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<!-- refers to legacy doc: <add github link to legacy doc piece, if applicable> -->
<!-- point back to this document with a similar comment added to your legacy doc piece -->
<!-- refer to README.md for file and id naming conventions -->
<!-- metadata is dealt with on the assembly level -->
<topic xml:id="deployment-combustion-example-script"
 role="reference" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
   <title>A complete example of the <filename>script</filename> file</title><!-- can be changed via merge in the assembly -->
    <!--add author's email address-->
    <meta name="maintainer" content="jsindelarova@suse.com" its:translate="no"/>
    <abstract><!-- can be changed via merge in the assembly -->
      <para>
       The reference covers a real life example of <filename>script</filename>.
      </para>
    </abstract>
  </info>
 <para>
  The following <filename>script</filename> provides complete settings that may serve you as a
  guide how to write your own &combustion; configuration. The example does not require any futher
  &ignition; configuration.
 </para>
 <screen>
#!/bin/bash
# combustion: network prepare


set -euxo pipefail

## The OSA subchannels to enable
ZNET_SUBCHANNELS=0.0.1000,0.0.1001,0.0.1002

## Network information to configure
IPADDRESS="10.144.64.155/24" ## Formet is ipaddress/cidr
GATEWAY="10.144.64.254"
NAMESERVERS="10.144.53.53;10.144.53.54" ## Semicolon separated list of nameservers

## Hostname information
NODE_HOSTNAME="slemicro6"

## Add password for root user
## Use either openssl passwd -6 or mkpasswd --method=sha-512 to encrypt the password.
ROOT_USER_PASSWORD='$6$NWOL.CUVsuDtWZhb$rs8JeaNfx/ZL.OvQPYugAbXAUA67va.geqLa96zNo8no/PqxvFDICB.Gb2BFlIZoTx095qHSkRevKIyy1/AKj.'
SSH_ROOT_PUBLIC_KEY=ssh_key.pub

## Add a regular user
CREATE_NORMAL_USER=user ## Add the username here to create a regular user.
NORMAL_USER_PASSWORD='$6$NWOL.CUVsuDtWZhb$rs8JeaNfx/ZL.OvQPYugAbXAUA67va.geqLa96zNo8no/PqxvFDICB.Gb2BFlIZoTx095qHSkRevKIyy1/AKj.'
SSH_USER_PUBLIC_KEY=ssh_key.pub

## Register to SUSE Customer Center and install additional packages
REG_EMAIL='tux@suse.com' ## Email address for product registration
SLEMICRO_REGCODE='INTERNAL-USE-ONLY-xxxx-xxxx' ## A registration code required to install additional packages
ADDITIONAL_PACKAGES='' ## A space separated list of additional packages to install


nm_config() {
  umask 077 # Required for NM config
  mkdir -p /etc/NetworkManager/system-connections/
  cat >'/etc/NetworkManager/system-connections/Wired connection 1.nmconnection' <<EOF
  [connection]
  id=static
  type=ethernet
  autoconnect=true

  [ipv4]
  method=manual
  address1=$IPADDRESS
  gateway=$GATEWAY
  dns=$NAMESERVERS
EOF
}

if [ "${1-}" = "--prepare" ]; then
  # Configure NM in the initrd
  nm_config
  # Enable OSA network devices
  chzdev qeth $ZNET_SUBCHANNELS -ep
  chzdev qeth $ZNET_SUBCHANNELS -e    
  exit 0
fi



## Post output on stdout
exec > >(exec tee -a /dev/ttyS0) 2>&1

## Set hostname
echo $NODE_HOSTNAME > /etc/hostname

## Set root password
echo root:$ROOT_USER_PASSWORD | chpasswd -e
## Add ssh public key as authorized key for the root user
mkdir -pm700 /root/.ssh/
cat $SSH_ROOT_PUBLIC_KEY >> /root/.ssh/authorized_keys

## Mount /var and /home so user can be created smoothly
if [ "$CREATE_NORMAL_USER" ]
then
  mount /var && mount /home
fi
## User creation
if [ "$CREATE_NORMAL_USER" ]
then
  echo "User creation is requested, creating user."
  useradd -m $CREATE_NORMAL_USER -s /bin/bash -g users
  echo $CREATE_NORMAL_USER:$NORMAL_USER_PASSWORD | chpasswd -e
  echo $CREATE_NORMAL_USER "ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/adminusers
  mkdir -pm700 /home/$CREATE_NORMAL_USER/.ssh/
  chown -R $CREATE_NORMAL_USER:users /home/$CREATE_NORMAL_USER/.ssh/
  cat $SSH_USER_PUBLIC_KEY >> /home/$CREATE_NORMAL_USER/.ssh/authorized_keys
  echo "Requested user has been created, requested password has been set."
else
  echo "No user will be created"
fi

# Configure NM in the system
nm_config
# Enable OSA network device
chzdev qeth $ZNET_SUBCHANNELS -ep
chzdev qeth $ZNET_SUBCHANNELS -e

## Enable services
echo "Enabling services."
systemctl enable cockpit.socket
systemctl enable sshd

## Unmount var and home
if [ "$CREATE_NORMAL_USER" ]
then
  umount /var && umount /home
fi

## Set dasd_mod.dasd to ipldev because ignition/combustion config drive is no longer needed
echo "Setting dasd_mod.dasd to ipldev."
sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="dasd_mod.dasd=ipldev /' /etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg

echo "Configured with Combustion at $(date)" > /etc/issue.d/combustion
 </screen>
</topic>
