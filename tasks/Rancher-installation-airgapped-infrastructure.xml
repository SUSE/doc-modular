<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<!-- https://github.com/rancher/rancher-product-docs/blob/main/versions/latest/modules/en/pages/installation-and-upgrade/other-installation-methods/air-gapped/infrastructure-private-registry.adoc -->
<topic xml:id="rancher-installation-airgapped-infrastructure-private-registry"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Installing &ranchermanager; in air-gapped environments: set up infrastructure and private registry</title>
    <meta name="maintainer" content="tbazant@suse.com" its:translate="no"/>
    <abstract>
      <para>
        In this section, you will provision the underlying infrastructure for
        your &ranchera; management server in an air-gapped environment. You will
        also set up the private container image registry that must be available
        to your &ranchera; node(s). The procedures below focus on installing
        &ranchera; in the &rke2a; cluster.
      </para>
    </abstract>
  </info>
  <para>
    To install the &ranchera; management server on a high-availability &rke2;
    cluster, we recommend setting up the following infrastructure:
  </para>
  <itemizedlist>
    <listitem>
      <para>
        <emphasis role="bold">Three Linux nodes,</emphasis> typically virtual
        machines, in an infrastructure provider such as Amazon's EC2, Google
        Compute Engine or vSphere.
      </para>
    </listitem>
    <listitem>
      <para>
        <emphasis role="bold">A load balancer</emphasis> to direct front-end
        traffic to the three nodes.
      </para>
    </listitem>
    <listitem>
      <para>
        <emphasis role="bold">A DNS record</emphasis> to map a URL to the load
        balancer. This will become the &ranchera; server URL, and downstream &k8s;
        clusters will need to reach it.
      </para>
    </listitem>
    <listitem>
      <para>
        <emphasis role="bold">A private image registry</emphasis> to distribute
        container images to your machines.
      </para>
    </listitem>
  </itemizedlist>
  <para>
    These nodes must be in the same region or data center. You may place these
    servers in separate availability zones.
  </para>
  <section xml:id="rancher-airgap-rke-why-three-nodes">
    <title>Why three nodes?</title>
    <para>
      In an &rke2a; cluster, &ranchera; server data is stored on &etcd;. This
      &etcd; database runs on all three nodes.
    </para>
    <para>
      The &etcd; database requires an odd number of nodes so that it can always
      elect a leader with a majority of the &etcd; cluster. If the &etcd;
      database cannot elect a leader, &etcd; can suffer from
      <link xlink:href="https://www.quora.com/What-is-split-brain-in-distributed-systems">split
      brain</link>, requiring the cluster to be restored from backup. If one of
      the three &etcd; nodes fails, the two remaining nodes can elect a leader
      because they have the majority of the total number of &etcd; nodes.
    </para>
  </section>
  <section xml:id="rancher-airgap-rke-setup-linux-nodes">
    <title>Set up Linux nodes</title>
    <para>
      These hosts will be disconnected from the internet, but require being able
      to connect with your private registry.
    </para>
    <para>
      Make sure that your nodes fulfill the general installation requirements
      for
      <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/requirements/">OS,
      container runtime, hardware and networking</link>.
    </para>
    <para>
      For an example of one way to set up Linux nodes, refer to this
      <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/resources/k8s-tutorials/infrastructure-tutorials/nodes-in-amazon-ec2/">tutorial</link>
      for setting up nodes as instances in Amazon EC2.
    </para>
  </section>
  <section xml:id="rancher-airgap-rke-setup-load-balancer">
    <title>Set up the load balancer</title>
    <para>
      You will also need to set up a load balancer to direct traffic to the
      &ranchera; replica on both nodes. That will prevent an outage of any single
      node from taking down communications to the &ranchera; management server.
    </para>
    <para>
      When &kube; gets set up in a later step, the &rke2a; tool will deploy an
      NGINX &ingress; controller. This controller will listen on ports 80 and
      443 of the worker nodes, answering traffic destined for specific
      hostnames.
    </para>
    <para>
      When &ranchera; is installed (also in a later step), the &ranchera; system
      creates an &ingress; resource. That &ingress; tells the NGINX &ingress;
      controller to listen for traffic destined for the &ranchera; host name. The
      NGINX &ingress; controller, when receiving traffic destined for the
      &ranchera; host name, will forward that traffic to the running &ranchera; pods
      in the cluster.
    </para>
    <para>
      For your implementation, consider if you want or need to use a Layer-4 or
      Layer-7 load balancer:
    </para>
    <itemizedlist>
      <listitem>
        <para>
          <emphasis role="bold">A layer-4 load balancer</emphasis> is the
          simpler of the two choices, in which you are forwarding TCP traffic to
          your nodes. We recommend configuring your load balancer as a Layer 4
          balancer, forwarding traffic to ports TCP/80 and TCP/443 to the
          &ranchera; management cluster nodes. The &ingress; controller on the
          cluster will redirect HTTP traffic to HTTPS and terminate SSL/TLS on
          port TCP/443. The &ingress; controller will forward traffic to port
          TCP/80 to the &ingress; pod in the &ranchera; deployment.
        </para>
      </listitem>
      <listitem>
        <para>
          <emphasis role="bold">A layer-7 load balancer</emphasis> is a bit more
          complicated but can offer features that you may want. For instance, a
          layer-7 load balancer is capable of handling TLS termination at the
          load balancer, as opposed to &ranchera; doing TLS termination itself.
          This can be beneficial to centralize your TLS termination in your
          infrastructure. Layer-7 load balancing also offers the capability for
          your load balancer to make decisions based on HTTP attributes such as
          cookies, etc. that a layer-4 load balancer is not able to concern
          itself with. If you decide to terminate the SSL/TLS traffic on a
          layer-7 load balancer, you will need to use the <option>--set
          tls=external</option> option when installing &ranchera; in a later step.
          For more information, refer to the
          <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/install-rancher-on-k8s/chart-options/#external-tls-termination">&ranchera;
          &helm; chart options</link>.
        </para>
      </listitem>
    </itemizedlist>
    <para>
      For an example showing how to set up an NGINX load balancer, refer to
      <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/resources/k8s-tutorials/infrastructure-tutorials/nginx-load-balancer/">this
      page</link>.
    </para>
    <para>
      For a how-to guide for setting up an Amazon ELB Network Load Balancer,
      refer to
      <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/resources/k8s-tutorials/infrastructure-tutorials/amazon-elb-load-balancer/">this
      page</link>.
    </para>
    <important>
      <para>
        Do not use this load balancer (i.e, the <literal>local</literal> cluster
        Ingress) to load balance applications other than &ranchera; following
        installation. Sharing this &ingress; with other applications may result
        in websocket errors to &ranchera; following &ingress; configuration reloads
        for other apps. We recommend dedicating the <literal>local</literal>
        cluster to &ranchera; and no other applications.
      </para>
    </important>
  </section>
  <section xml:id="rancher-airgap-rke-setup-dns-record">
    <title>Set up the DNS record</title>
    <para>
      Once you have set up your load balancer, you will need to create a DNS
      record to send traffic to this load balancer.
    </para>
    <para>
      Depending on your environment, this may be an A record pointing to the LB
      IP, or it may be a CNAME pointing to the load balancer host name. In
      either case, make sure this record is the host name that you intend
      &ranchera; to respond on.
    </para>
    <para>
      You will need to specify this host name in a later step when you install
      &ranchera;, and it is not possible to change it later. Make sure that your
      decision is a final one.
    </para>
    <para>
      For a how-to guide for setting up a DNS record to route domain traffic to
      an Amazon ELB load balancer, refer to the
      <link xlink:href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-to-elb-load-balancer.html">official
      AWS documentation</link>.
    </para>
  </section>
  <section xml:id="rancher-airgap-rke-setup-private-image-registry">
    <title>Set up a private image registry</title>
    <para>
      &ranchera; supports air gap installs using a secure private registry. You
      must have your own private registry or other means of distributing
      container images to your machines.
    </para>
    <para>
      In a later step, when you set up your &rke2a; &kube; cluster, you will
      create a
      <link xlink:href="https://rke.docs.rancher.com/config-options/private-registries">private
      registries configuration file</link> with details from this registry.
    </para>
    <para>
      If you need to create a private registry, refer to the documentation pages
      for your respective runtime:
    </para>
    <itemizedlist>
      <listitem>
        <para>
          <link xlink:href="https://github.com/containerd/containerd/blob/main/docs/cri/config.md#registry-configuration">&containerd;</link>
        </para>
        <itemizedlist>
          <listitem>
            <para>
              <link xlink:href="https://github.com/containerd/nerdctl/blob/main/docs/registry.md">Nerdctl
              commands and managed registry services</link>
            </para>
          </listitem>
        </itemizedlist>
      </listitem>
      <listitem>
        <para>
          <link xlink:href="https://docs.docker.com/registry/deploying/">&docker;</link>
        </para>
      </listitem>
    </itemizedlist>
  </section>
</topic>
