<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<!-- https://github.com/rancher/rancher-product-docs/blob/main/versions/latest/modules/en/pages/installation-and-upgrade/other-installation-methods/air-gapped/install-rancher-ha.adoc -->
<topic xml:id="rancher-installation-airgapped-rancher"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Installing &ranchermanager; in air-gapped environments: install &rancherprime;</title>
    <meta name="maintainer" content="tbazant@suse.com" its:translate="no"/>
    <abstract>
      <para>
        This section describes how to install a &k8s; cluster according to our
        best practices for the Rancher server environment. This cluster should
        be dedicated to run only the Rancher server.
      </para>
    </abstract>
  </info>
  <section xml:id="rancher-airgap-privileged-access">
    <title>Privileged access for rancher</title>
    <para>
      When the Rancher server is deployed in the &docker; container, a local
      &k8s; cluster is installed within the container for Rancher to use.
      Because many features of Rancher run as deployments, and privileged mode
      is required to run containers within containers, you will need to install
      Rancher with the <option>--privileged</option> option.
    </para>
  </section>
  <section xml:id="rancher-airgap-kubernetes-instructions">
    <title>&kube; instructions</title>
    <para>
      Rancher recommends installing Rancher on a &kube; cluster. A highly
      available &kube; install is comprised of three nodes running the Rancher
      server components on a &kube; cluster. The persistence layer (&etcd;) is
      also replicated on these three nodes, providing redundancy and data
      duplication in case one of the nodes fails.
    </para>
    <section xml:id="rancher-airgap-add-helm-repo">
      <title>Add the &helm; chart repository</title>
      <para>
        From a system that has access to the Internet, fetch the latest &helm;
        chart and copy the resulting manifests to a system that has access to
        the Rancher server cluster.
      </para>
      <procedure>
        <step>
          <para>
            If you have not already, install <command>helm</command> locally on
            a workstation that has Internet access. Refer to the
            <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/requirements/helm-requirements/">&helm;
            version requirements</link> to choose a version of &helm; to install
            Rancher.
          </para>
        </step>
        <step>
          <para>
            Use the <command>helm repo add</command> command to add the &helm;
            chart repository that contains charts to install Rancher Prime.
          </para>
<screen>&prompt.user;helm repo add rancher-prime <replaceable>helm-chart-repo-url</replaceable></screen>
        </step>
        <step>
          <para>
            Fetch the Rancher Prime chart. This will pull down the chart and
            save it in the current directory as a <filename>.tgz</filename>
            file.
          </para>
          <itemizedlist>
            <listitem>
              <para>
                To fetch the latest version:
              </para>
<screen>&prompt.user;helm fetch rancher-prime/rancher</screen>
            </listitem>
            <listitem>
              <para>
                To fetch a specific version:
              </para>
              <para>
                Check to see which version of Rancher Prime are available.
              </para>
<screen>&prompt.user;helm search repo --versions rancher-prime</screen>
              <para>
                Fetch a specific version by specifying the
                <option>--version</option> parameter:
              </para>
<screen>&prompt.user;helm fetch rancher-prime/rancher --version=<replaceable>version</replaceable></screen>
            </listitem>
          </itemizedlist>
        </step>
      </procedure>
    </section>
    <section xml:id="rancher-airgap-ssl-config">
      <title>Choose your SSL configuration</title>
      <para>
        Rancher server is designed to be secure by default and requires SSL/TLS
        configuration.
      </para>
      <para>
        When Rancher is installed on an air-gapped &kube; cluster, there are two
        recommended options for the source of the certificate.
      </para>
      <note>
        <para>
          If you want to terminate SSL/TLS externally, see
          <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/resources/chart-options/#external-tls-termination">TLS
          termination on an External Load Balancer</link>.
        </para>
      </note>
      <table>
        <title/>
        <tgroup cols="4">
          <thead>
            <row>
              <entry>Configuration</entry>
              <entry>Chart option</entry>
              <entry>Description</entry>
              <entry>Requires &certmanager;</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>Rancher Generated Self-Signed Certificates</entry>
              <entry><literal>ingress.tls.source=rancher</literal>
              </entry>
              <entry>Use certificates issued by Rancher's generated CA (self signed). This is the <emphasis role="bold">default</emphasis> and does not need to be added when rendering the &helm; template.</entry>
              <entry>yes</entry>
            </row>
            <row>
              <entry>Certificates from Files</entry>
              <entry><literal>ingress.tls.source=secret</literal>
              </entry>
              <entry>Use your own certificate files by creating &kube; secret(s). This option must be passed when rendering the Rancher &helm; template.</entry>
              <entry>no</entry>
            </row>
          </tbody>
        </tgroup>
      </table>
    </section>
    <section xml:id="rancher-airgap-helm-options">
      <title>&helm; chart options for air-gapped installations</title>
      <para>
        When setting up the Rancher &helm; template, there are several options
        in the &helm; chart that are designed specifically for air-gapped
        installations.
      </para>
      <table>
        <title/>
        <tgroup cols="3">
          <thead>
            <row>
              <entry>Chart option</entry>
              <entry>Chart value</entry>
              <entry>Description</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry><literal>certmanager.version</literal>
              </entry>
              <entry><replaceable>version</replaceable>
              </entry>
              <entry>Configure proper Rancher TLS issuer depending of running &certmanager; version.</entry>
            </row>
            <row>
              <entry><literal>systemDefaultRegistry</literal>
              </entry>
              <entry><replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>
              </entry>
              <entry>Configure Rancher server to always pull from your private registry when provisioning clusters.</entry>
            </row>
            <row>
              <entry><literal>useBundledSystemChart</literal>
              </entry>
              <entry><literal>true</literal>
              </entry>
              <entry>Configure Rancher server to use the packaged copy of &helm; system charts. The <link xlink:href="https://github.com/rancher/system-charts">system charts</link> repository contains all the catalog items required for features such as monitoring, logging, alerting and global DNS. These <link xlink:href="https://github.com/rancher/system-charts">&helm; charts</link> are located in GitHub, but since you are in an air-gapped environment, using the charts that are bundled within Rancher is much easier than setting up a Git mirror.</entry>
            </row>
          </tbody>
        </tgroup>
      </table>
    </section>
    <section xml:id="rancher-airgap-fetch-cert-manager">
      <title>Fetch the &certmanager; chart</title>
      <para>
        Based on the choice your made in
        <xref linkend="rancher-airgap-ssl-config"/>, complete one of the
        procedures below.
      </para>
      <section xml:id="rancher-airgap-self-signed-cert">
        <title>Option A: default self-signed certificate</title>
        <para>
          By default, Rancher generates a CA and uses &certmanager; to issue the
          certificate for access to the Rancher server interface.
        </para>
        <note>
          <para>
            Recent changes to &certmanager; require an upgrade. If you are
            upgrading Rancher and using a version of &certmanager; older than
            v0.11.0, please see our
            <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/resources/upgrade-cert-manager/">upgrade
            &certmanager; documentation</link>.
          </para>
        </note>
        <procedure>
          <step>
            <para>
              From a system connected to the internet, add the &certmanager;
              repo to &helm;:
            </para>
<screen>&prompt.user;helm repo add jetstack https://charts.jetstack.io
helm repo update</screen>
          </step>
          <step>
            <para>
              Fetch the latest &certmanager; chart available from the
              <link xlink:href="https://artifacthub.io/packages/helm/cert-manager/cert-manager">&helm;
              chart repository</link>.
            </para>
<screen>&prompt.user;helm fetch jetstack/cert-manager --version v1.11.0</screen>
          </step>
          <step>
            <para>
              Download the required CRD file for &certmanager;:
            </para>
<screen>&prompt.user;curl -L -o cert-manager-crd.yaml https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.crds.yaml</screen>
          </step>
        </procedure>
      </section>
    </section>
    <section xml:id="rancher-airgap-install-rancher">
      <title>Install rancher</title>
      <para>
        Copy the fetched charts to a system that has access to the Rancher
        server cluster to complete installation.
      </para>
      <section xml:id="rancher-airgap-install-cert-manager">
        <title>1. Install &certmanager;</title>
        <para>
          Install &certmanager; with the same options you would use to install
          the chart. Remember to set the <literal>image.repository</literal>
          option to pull the image from your private registry.
        </para>
        <note>
          <para>
            To see options on how to customize the &certmanager; install
            (including for cases where your cluster uses PodSecurityPolicies),
            see the
            <link xlink:href="https://artifacthub.io/packages/helm/cert-manager/cert-manager#configuration">cert-manager
            docs</link>.
          </para>
        </note>
        <para>
          If you are using self-signed certificates, install &certmanager;:
        </para>
        <procedure>
          <step>
            <para>
              Create the namespace for &certmanager;.
            </para>
<screen>&prompt.user;kubectl create namespace cert-manager</screen>
          </step>
          <step>
            <para>
              Create the &certmanager; CustomResourceDefinitions (CRDs).
            </para>
<screen>&prompt.user;kubectl apply -f cert-manager-crd.yaml</screen>
          </step>
          <step>
            <para>
              Install &certmanager;.
            </para>
<screen>&prompt.user;helm install cert-manager ./cert-manager-v1.11.0.tgz \
  --namespace cert-manager \
  --set image.repository=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>/quay.io/jetstack/cert-manager-controller \
  --set webhook.image.repository=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>/quay.io/jetstack/cert-manager-webhook \
  --set cainjector.image.repository=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>/quay.io/jetstack/cert-manager-cainjector \
  --set startupapicheck.image.repository=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>/quay.io/jetstack/cert-manager-ctl</screen>
          </step>
        </procedure>
      </section>
      <section xml:id="rancher-airgap-install-rancher-server">
        <title>Install &ranchermanager;</title>
        <para>
          Refer to
          <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/resources/tls-secrets/">Adding
          TLS Secrets</link> to publish the certificate files so Rancher and the
          &ingress; controller can use them.
        </para>
        <para>
          Create the namespace for Rancher using <command>kubectl</command>:
        </para>
<screen>&prompt.user;kubectl create namespace cattle-system</screen>
        <para>
          Install Rancher, declaring your chosen options. Use the reference
          table below to replace each placeholder. Rancher needs to be
          configured to use the private registry to provision any Rancher
          launched &kube; clusters or Rancher tools.
        </para>
        <table>
          <title/>
          <tgroup cols="2">
            <thead>
              <row>
                <entry>Placeholder</entry>
                <entry>Description</entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry><replaceable>VERSION</replaceable>
                </entry>
                <entry>The version number of the output tarball.</entry>
              </row>
              <row>
                <entry><replaceable>RANCHER.YOURDOMAIN.COM</replaceable>
                </entry>
                <entry>The DNS name you pointed at your load balancer.</entry>
              </row>
              <row>
                <entry><replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>
                </entry>
                <entry>The DNS name for your private registry.</entry>
              </row>
              <row>
                <entry><replaceable>CERTMANAGER_VERSION</replaceable>
                </entry>
                <entry>&certmanager; version running on k8s cluster.</entry>
              </row>
            </tbody>
          </tgroup>
        </table>
<screen>&prompt.user;helm install rancher ./rancher-<replaceable>VERSION</replaceable>.tgz \
  --namespace cattle-system \
  --set hostname=<replaceable>RANCHER.YOURDOMAIN.COM</replaceable> \
  --set certmanager.version=<replaceable>CERTMANAGER_VERSION</replaceable> \
  --set rancherImage=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>/rancher/rancher \
  --set systemDefaultRegistry=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable> \ # Set a default private registry to be used in Rancher
  --set useBundledSystemChart=true # Use the packaged Rancher system charts</screen>
        <para>
          <emphasis role="bold">Optional</emphasis>: to install a specific
          Rancher version, set the <literal>rancherImageTag</literal> value, for
          example: <option>--set rancherImageTag=v2.5.8</option>
        </para>
      </section>
      <section xml:id="rancher-airgap-certs-from-files">
        <title>Option B: certificates from files using &k8s; secrets</title>
        <procedure>
          <step>
            <para>
              Create &kube; secrets from your own certificates for Rancher to
              use. The common name for the cert will need to match the
              <literal>hostname</literal> option in the command below, or the
              &ingress; controller will fail to provision the site for Rancher.
            </para>
          </step>
          <step>
            <para>
              Install &ranchermanager;, declaring your chosen options. Use the
              reference table below to replace each placeholder. Rancher needs
              to be configured to use the private registry to provision any
              Rancher launched &kube; clusters or Rancher tools.
            </para>
            <table>
              <title/>
              <tgroup cols="2">
                <thead>
                  <row>
                    <entry>Placeholder</entry>
                    <entry>Description</entry>
                  </row>
                </thead>
                <tbody>
                  <row>
                    <entry><replaceable>VERSION</replaceable>
                    </entry>
                    <entry>The version number of the output tarball.</entry>
                  </row>
                  <row>
                    <entry><replaceable>RANCHER.YOURDOMAIN.COM</replaceable>
                    </entry>
                    <entry>The DNS name you pointed at your load balancer.</entry>
                  </row>
                  <row>
                    <entry><replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>
                    </entry>
                    <entry>The DNS name for your private registry.</entry>
                  </row>
                </tbody>
              </tgroup>
            </table>
<screen>&prompt.user;helm install rancher ./rancher-<replaceable>VERSION</replaceable>.tgz \
  --namespace cattle-system \
  --set hostname=<replaceable>RANCHER.YOURDOMAIN.COM</replaceable> \
  --set rancherImage=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>/rancher/rancher \
  --set ingress.tls.source=secret \
  --set systemDefaultRegistry=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable> \ # Set a default private registry to be used in Rancher
  --set useBundledSystemChart=true # Use the packaged Rancher system charts</screen>
            <para>
              If you are using a Private CA signed cert, add <option>--set
              privateCA=true</option> following <option>--set
              ingress.tls.source=secret</option>:
            </para>
<screen>&prompt.user;helm install rancher ./rancher-<replaceable>VERSION</replaceable>.tgz \
  --namespace cattle-system \
  --set hostname=<replaceable>RANCHER.YOURDOMAIN.COM</replaceable> \
  --set rancherImage=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable>/rancher/rancher \
  --set ingress.tls.source=secret \
  --set privateCA=true \
  --set systemDefaultRegistry=<replaceable>REGISTRY.YOURDOMAIN.COM:PORT</replaceable> \ # Set a default private registry to be used in Rancher
  --set useBundledSystemChart=true # Use the packaged Rancher system charts</screen>
            <para>
              The installation is complete.
            </para>
          </step>
        </procedure>
      </section>
    </section>
  </section>
  <section xml:id="rancher-airgap-additional-resources">
    <title>Additional resources</title>
    <para>
      These resources could be helpful when installing Rancher:
    </para>
    <itemizedlist>
      <listitem>
        <para>
          <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/extensions/#importing-and-installing-extensions-in-an-air-gapped-environment">Importing
          and installing extensions in an air-gapped environment</link>
        </para>
      </listitem>
      <listitem>
        <para>
          <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/resources/chart-options/">Rancher
          &helm; chart options</link>
        </para>
      </listitem>
      <listitem>
        <para>
          <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/resources/tls-secrets/">Adding
          TLS secrets</link>
        </para>
      </listitem>
      <listitem>
        <para>
          <link xlink:href="https://rancher.com/docs/rancher/v2.x/en/installation/troubleshooting/">Troubleshooting
          Rancher &kube; Installations</link>
        </para>
      </listitem>
    </itemizedlist>
  </section>
</topic>
