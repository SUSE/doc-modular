<?xml version="1.0" encoding="UTF-8"?>
<!-- This file originates from the project https://github.com/openSUSE/doc-kit -->
<!-- This file can be edited downstream. -->
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<!-- refers to legacy doc: <add github link to legacy doc piece, if applicable> -->
<!-- point back to this document with a similar comment added to your legacy doc piece -->
<!-- refer to README.md for file and id naming conventions -->
<!-- metadata is dealt with on the assembly level -->
<topic xml:id="activating-multipath-agama-installation"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Activating multipath during installation of &sle; using &agama;</title>
    <!-- can be changed via merge
      in the assembly -->
    <!-- add author's e-mail -->
    <meta name="maintainer" content="souvik.sarkar@suse.com" its:translate="no"/>
    <abstract>
      <!-- can be changed via merge in the assembly -->
      <para>
        This topic guides you to activate multipath for storage devices while installing &sle;
        using &agama;. You can force activation by modifying boot parameters, or conditionally
        activate it by modifying &agama; profiles.
      </para>
    </abstract>
  </info>
  <section xml:id="agama-installation-understanding-multipath-activation">
    <title>Understanding multipath activation during installation using &agama;</title>
    <para>
      Multipath in Linux is a device mapper framework that provides redundancy and improved
      performance for storage devices by creating a single logical device from multiple physical
      paths to the same storage target. This architecture prevents storage I/O interruptions due to
      hardware failures while enabling load balancing across paths, and is commonly used in
      enterprise environments.
    </para>
    <para>
      To enable this capability, the multipath subsystem must be activated by &agama; during
      installation of &sle;. Once activated, multipath affects all devices system-wide, meaning all
      disks must be referenced exclusively by their corresponding multipath device names. &agama;
      currently provides several mechanisms for users to activate multipath support.
    </para>
  </section>
  <section xml:id="multipath-activation-requirements">
    <title>Requirements</title>
    <itemizedlist>
      <listitem>
        <para>
          The &agama; installer, which is available with the <literal>.iso</literal> file you use
          for installing &sle;.
        </para>
      </listitem>
      <listitem>
        <para>
          For <emphasis>forced</emphasis> activation of multipath, access to command line boot
          parameters.
        </para>
      </listitem>
      <listitem>
        <para>
          For <emphasis>conditional</emphasis> activation of multipath, access to the &agama; web
          interface, or the &agama; CLI, or &agama; profiles.
        </para>
      </listitem>
    </itemizedlist>
    <para>
      By default, you should have access to all the different ways of forced and conditional
      activation of multipath.
    </para>
  </section>
  <section xml:id="forced-multipath-activation-agama-installation">
    <title>Activating multipath using boot parameters</title>
    <para>
      If you are certain that the system uses multipath, the most reliable method to ensure that
      &agama; activates the corresponding subsystems is to enable the environment variable
      <parameter>LIBSTORAGE_MULTIPATH_AUTOSTART</parameter> at the time of boot.
    </para>
    <procedure>
      <para>
        To enable multipath during installation, perform the following steps:
      </para>
      <step>
        <para>
          When the boot menu is displayed, select <keycap>e</keycap> to edit the boot parameters.
        </para>
      </step>
      <step>
        <para>
          Add the <parameter>LIBSTORAGE_MULTIPATH_AUTOSTART</parameter> parameter and set it to
          <literal>1</literal>.
        </para>
        <figure>
          <title>Activation of multipath using boot parameters</title>
          <mediaobject>
            <imageobject role="html">
              <imagedata
              fileref="agama-installation-sles-x86-64-grub-menu-multipath-forced-activation.png"
              format="PNG"></imagedata>
            </imageobject>
            <imageobject role="fo">
              <imagedata
              fileref="agama-installation-sles-x86-64-grub-menu-multipath-forced-activation.png"
              format="PNG" width="80%"></imagedata>
            </imageobject>
          </mediaobject>
        </figure>
      </step>
      <step>
        <para>
          Select <keycombo><keycap>Ctrl</keycap><keycap>x</keycap></keycombo> or
          <keycap>F10</keycap> to exit the edit window and continue with the boot.
        </para>
      </step>
    </procedure>
  </section>
  <section xml:id="conditional-multipath-activation-agama-installation">
    <title>Activating multipath using &agama; web interface, CLI, or profiles</title>
    <para>
      If multipath activation is not enforced through the boot parameter, &agama; attempts to
      detect multipath devices in the system. When detected, &agama; either prompts you to confirm
      multipath activation, or proceeds with unattended installation based on the answer provided
      in the &agama; profile.
    </para>
    <warning>
      <title>Unreliable multipath detection</title>
      <para>
        Detection of multipath devices using &agama; is not fully reliable. If you are sure that
        the system uses multipath devices, we recommend using the method of enabling the necessary
        boot parameters.
      </para>
    </warning>
    <procedure>
      <para>
        Depending on whether you are performing an interactive or an unattended installation,
        perform the necessary steps as described below.
      </para>
      <step>
        <stepalternatives>
          <step>
            <para>
              In an <emphasis role="strong">interactive</emphasis> installation, &agama; prompts
              you to confirm whether to activate multipath. The prompt can be answered
              interactively using the web interface, or in the command-line interface using the
              <command>agama questions</command> command.
            </para>
            <stepalternatives>
              <step>
                <para>
                  If using the web interface, confirm when you see a prompt similar to the
                  following:
                </para>
                <figure>
                  <title>Activation of multipath using the &agama; web interface</title>
                  <mediaobject>
                    <imageobject role="html">
                      <imagedata
              fileref="agama-installation-sles-x86-64-grub-menu-multipath-conditional-activation.png"
              format="PNG"></imagedata>
                    </imageobject>
                    <imageobject role="fo">
                      <imagedata
              fileref="agama-installation-sles-x86-64-grub-menu-multipath-conditional-activation.png"
              format="PNG" width="80%"></imagedata>
                    </imageobject>
                  </mediaobject>
                </figure>
              </step>
              <step>
                <para>
                  If using the &agama; CLI, perform the following:
                </para>
                <substeps>
                  <step>
                    <para>
                      Edit the &agama; profile to include the following JSON configuration:
                    </para>
<screen>
{
  "questions": {
    "answers": [
      {
        "class": "storage.activate_multipath",
        "answer": "yes"
      }
    ]
  }
}
</screen>
                  </step>
                  <step>
                    <para>
                      Provide the path to answers of &agama; questions using the following command:
                    </para>
<screen>&prompt.root;<command>agama questions answers <replaceable>PATH/TO/JSON/FILE</replaceable></command></screen>
                  </step>
                </substeps>
              </step>
            </stepalternatives>
          </step>
          <step>
            <para>
              In an <emphasis role="strong">unattended</emphasis> installation, &agama; looks for
              an answer to the question about multipath activation in the &agama; profile.
            </para>
            <substeps>
              <step>
                <para>
                  Edit the &agama; profile to include the following JSON configuration:
                </para>
<screen>
{
  "questions": {
    "answers": [
      {
        "class": "storage.activate_multipath",
        "answer": "yes"
      }
    ]
  }
}
</screen>
              </step>
              <step>
                <para>
                  Provide the path to the &agama; profile using the
                  <parameter>inst.auto=<replaceable>URL/PATH/TO/AGAMA/JSON/PROFILE</replaceable></parameter>
                  boot parameter.
                </para>
              </step>
            </substeps>
          </step>
        </stepalternatives>
      </step>
    </procedure>
  </section>
  <section xml:id="multipath-activation-summary">
    <title>Summary of multipath activation</title>
    <para>
      If you are performing a manual installation of &sle; using &agama;, you can activate
      multipath support by adding the <parameter>LIBSTORAGE_MULTIPATH_AUTOSTART=1</parameter> boot
      parameter, or confirming multipath activation using the web or command-line interfaces of
      &agama; during the installation process.
    </para>
    <para>
      If you are performing an unattended installation using &agama;, edit the &agama; profile to
      include answer to the question of multipath activation, and pass the path to the profile as
      the value of the <parameter>inst.auto</parameter> boot parameter.
    </para>
  </section>
  <section xml:id="multipath-activation-troubleshooting">
    <title>Troubleshooting multipath activation</title>
    <para>
      Depending on the chosen method of multipath activation, use one of more of the following
      troubleshooting tips:
    </para>
    <itemizedlist>
      <listitem>
        <para>
          If using forced activation, ensure that you correctly add the
          <parameter>LIBSTORAGE_MULTIPATH_AUTOSTART=1</parameter> boot parameter. After the boot,
          you can verify it in the content of the &grub; configuration file of your system.
        </para>
      </listitem>
      <listitem>
        <para>
          If using answers to &agama; questions, ensure that you have used the correct JSON snippet
          for multipath activation, by running the <command>agama config show</command> command.
        </para>
      </listitem>
    </itemizedlist>
  </section>
</topic>
