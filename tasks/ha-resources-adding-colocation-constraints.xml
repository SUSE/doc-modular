<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>

<!-- refers to legacy doc: https://github.com/SUSE/doc-sleha/blob/main/xml/ha_resource_constraints.xml -->

<topic xml:id="ha-resources-adding-colocation-constraints"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Adding colocation constraints</title>
    <meta name="maintainer" content="tahlia.richardson@suse.com" its:translate="no"/>
    <abstract>
      <para>
        A colocation constraint tells the cluster which resources may or may not
        run together on a node. As a colocation constraint defines a dependency
        between resources, you need at least two resources to create a colocation
        constraint.
        </para>
        <para>
          The score determines the location
              relationship between the resources. Positive values indicate that the
              resources should run on the same node. Negative values indicate that the
              resources should not run on the same node. The score is combined with
              other factors to decide where to put the resource.
        </para>
        <para>
        You can add colocation constraints using either &hawk; or &crmsh;.
        </para>
    </abstract>
  </info>

  <variablelist role="tabs">
    <varlistentry>
      <term>&crmshell;</term>
      <listitem>
        <para>
          You can perform this procedure on any node in the cluster.
        </para>
        <procedure>
          <step>
            <para>
              Log in either as the &rootuser; user or as a user with <command>sudo</command> privileges.
            </para>
          </step>
          <step>
            <para>
            You can set a score of either +inf or -inf, defining
            resources that must always or must never run on the same node.
            You can also use non-infinite scores. In that case the colocation
            is called <emphasis>advisory</emphasis> and the cluster may decide not
            to follow them in favor of not stopping other resources if there is a
            conflict.
            </para>
            <para>
            For example, to always run the resources <literal>resource1</literal>
            and <literal>resource2</literal> on the same host, use the following constraint:
            </para>
<screen>&prompt.user;<command>sudo crm configure colocation coloc-2resource inf: resource1 resource2</command></screen>
            <para>
            For a primary/secondary configuration, it is necessary to know if the
            current node is a primary in addition to running the resource locally.
            </para>
            <para>
     If you want to use resource sets to replace a configuration of
     colocation constraints, consider the following two examples:
    </para>
    <example>
     <title>A chain of colocated resources</title>
<screen>&lt;constraints&gt;
    &lt;rsc_colocation id="coloc-1" rsc="B" with-rsc="A" score="INFINITY"/&gt;
    &lt;rsc_colocation id="coloc-2" rsc="C" with-rsc="B" score="INFINITY"/&gt;
    &lt;rsc_colocation id="coloc-3" rsc="D" with-rsc="C" score="INFINITY"/&gt;
&lt;/constraints&gt;</screen>
    </example>
    <para>
     The same configuration expressed by a resource set:
    </para>
<screen>&lt;constraints&gt;
   &lt;rsc_colocation id="coloc-1" score="INFINITY" &gt;
    &lt;resource_set id="colocated-set-example" sequential="true"&gt;
     &lt;resource_ref id="A"/&gt;
     &lt;resource_ref id="B"/&gt;
     &lt;resource_ref id="C"/&gt;
     &lt;resource_ref id="D"/&gt;
    &lt;/resource_set&gt;
   &lt;/rsc_colocation&gt;
&lt;/constraints&gt;</screen>
          </step>
        </procedure>
      </listitem>
    </varlistentry>
    <varlistentry>
      <term>&hawk;</term>
      <listitem>
        <para>
          You can access the &hawk; Web interface from any machine that has network access to the nodes.
        </para>
        <procedure>
          <step>
            <para>
              In a Web browser, go to
              <literal>https://<replaceable>HAWKSERVER</replaceable>:7630/</literal>
              and log in.
            </para>
          </step>
          <step>
            <para>
              From the left navigation bar, select <menuchoice><guimenu>Configuration</guimenu>
              <guimenu>Add Constraint</guimenu></menuchoice>.
            </para>
          </step>
          <step>
            <para>
              Click <guimenu>Colocation</guimenu>.
            </para>
          </step>
          <step>
            <para>
              Enter a unique <guimenu>Constraint ID</guimenu>.
            </para>
          </step>
          <step>
            <para>
              Enter a numeric <guimenu>Score</guimenu> or select a value form the drop-down list:
            </para>
            <itemizedlist>
              <listitem>
              <para>
                <literal>Always</literal> sets the score to <literal>INFINITY</literal>, which
                means that the resources must run on the same node.
              </para>
              </listitem>
              <listitem>
              <para>
                <literal>Never</literal> sets the score to <literal>-INFINITY</literal>, which
                means that the resources must run on different nodes.
              </para>
              </listitem>
            </itemizedlist>
          </step>
          <step>
            <para>
              From the drop-down list in the <guimenu>Resources</guimenu> section, select a
              resource. A new drop-down list appears. Repeat this step to add more resources.
            </para>
            <para>
              The cluster first decides where to put the last resource, then places the other resources based on that decision. To change the order of the resources, click the up arrow icon to swap a resource with the one above it.
            </para>
            <para>
              To remove a resource from the constraint, click the minus icon.
            </para>
          </step>
          <step performance="optional">
            <para>
              To create a resource set, click the chain icon to link a resource to the
              one above it. You can link multiple resources into a set or create
              multiple resource sets.
            </para>
            <para>
              To remove a resource from the set, click the scissors icon.
            </para>
          </step>
          <step performance="optional">
            <para>
              If required, select a condition (<literal>Start</literal>, <literal>Stop</literal>,
              <literal>Promote</literal> or <literal>Demote</literal>) from the drop-down list
              next to a resource. The colocation constraint only applies to this resource when
              it meets this condition.
            </para>
          </step>
          <step performance="optional">
            <para>
              You can add a <guimenu>Node Attribute</guimenu> to colocate the resources on a group of nodes instead of one specific node. If the nodes have an attribute assigned, the resources in this constraint will all be placed on nodes with the same value for that attribute.
            </para>
          </step>
          <step>
            <para>
              Click <guimenu>Create</guimenu> to finish the configuration.
            </para>
            <para>
              A message at the top of the screen shows if the action was successful.
            </para>
          </step>
        </procedure>
      </listitem>
    </varlistentry>
  </variablelist>
</topic>
