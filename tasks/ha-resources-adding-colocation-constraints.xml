<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>

<!-- refers to legacy doc: https://github.com/SUSE/doc-sleha/blob/main/xml/ha_resource_constraints.xml -->

<topic xml:id="ha-resources-adding-colocation-constraints"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Adding colocation constraints</title>
    <meta name="maintainer" content="tahlia.richardson@suse.com" its:translate="no"/>
    <abstract>
      <para>
        A colocation constraint tells the cluster which resources may or may not
        run together on a node. As a colocation constraint defines a dependency
        between resources, you need at least two resources to create a colocation
        constraint.
        </para>
        <para>
          The score determines the location
              relationship between the resources. Positive values indicate that the
              resources should run on the same node. Negative values indicate that the
              resources should not run on the same node. The score is combined with
              other factors to decide where to put the resource. You can set a score of either +inf or -inf, defining resources that must always or must never run on the same node.
            You can also use non-infinite scores. In that case the colocation
            is called <emphasis>advisory</emphasis> and the cluster may decide not
            to follow them in favor of not stopping other resources if there is a
            conflict.
        </para>
        <para>
        You can add colocation constraints using either &hawk; or &crmsh;.
        </para>
    </abstract>
  </info>

  <variablelist role="tabs">
    <varlistentry>
      <term>&crmshell;</term>
      <listitem>
        <para>
          You can perform this procedure on any node in the cluster.
        </para>
        <procedure>
          <step>
            <para>
              Log in either as the &rootuser; user or as a user with <command>sudo</command> privileges.
            </para>
          </step>
          <step>
            <para>
              Add a colocation constraint. The basic command requires a name, a score and at least two resources:
            </para>
<screen>&prompt.user;<command>sudo crm configure colocation <replaceable>COLOCATION_NAME SCORE: RESOURCE1 RESOURCE2</replaceable></command></screen>
            <para>
              The <replaceable>SCORE</replaceable> can be <literal>inf</literal>, <literal>-inf</literal> or a numeric value (positive or negative).
            </para>
            <variablelist>
              <title>Additional options</title>
              <varlistentry>
                <term>Resource sets</term>
                <listitem>
                  <para>
                    You can use square brackets to do something or other with multiple resources, and something about the options <literal>require-all</literal> and <literal>sequential</literal>.
                  </para>
<screen>&prompt.user;<command>sudo crm configure colocation res1-with-res2-res3 \
  inf: res1 [ res2 res3 ]</command></screen>
<!-- `crm configure colocation res1-with-res2-res3 inf: res1 [ res2 res3 ]` worked
 but `crm configure colocation res1-with-res2-res3 inf: res1 ( res2 res3 )` didn't
 but when you configure the same set with Hawk, it uses round () brackets -->
                </listitem>
              </varlistentry>
              <varlistentry>
                <term>Roles</term>
                <listitem>
                  <para>
                    You can require a role (<literal>Started</literal>, <literal>Stopped</literal>, <literal>Promoted</literal> or <literal>Promotable</literal>) for one or more resources. The colocation constraint only applies when the resource fulfills this role.
                  </para>
<screen>&prompt.user;<command>sudo crm configure colocation res1-with-promoted-clone2 \
  inf: res1 clone2:Promoted</command></screen>
                </listitem>
              </varlistentry>
              <varlistentry>
                <term>Node attributes</term>
                <listitem>
                  <para>
                    You can add a node attribute to colocate the resources on a group of nodes instead of one specific node. If the nodes have an attribute assigned, the resources in this constraint will all be placed on nodes with the same value for that attribute.
                  </para>
<screen>&prompt.user;<command>sudo crm configure colocation res1-res2-in-same-dc \
  inf: res1 res2 node-attribute=datacenter</command></screen>
                </listitem>
              </varlistentry>
            </variablelist>
          </step>
          <step>
            <para>
              Check the status to see which node the resources are now running on:
            </para>
<screen>&prompt.user;<command>sudo crm status</command></screen>
          </step>
        </procedure>
      </listitem>
    </varlistentry>
    <varlistentry>
      <term>&hawk;</term>
      <listitem>
        <para>
          You can access the &hawk; Web interface from any machine that has network access to the nodes.
        </para>
        <procedure>
          <step>
            <para>
              In a Web browser, go to
              <literal>https://<replaceable>HAWKSERVER</replaceable>:7630/</literal>
              and log in.
            </para>
          </step>
          <step>
            <para>
              From the left navigation bar, select <menuchoice><guimenu>Configuration</guimenu>
              <guimenu>Add Constraint</guimenu></menuchoice>.
            </para>
          </step>
          <step>
            <para>
              Click <guimenu>Colocation</guimenu>.
            </para>
          </step>
          <step>
            <para>
              Enter a unique <guimenu>Constraint ID</guimenu>.
            </para>
          </step>
          <step>
            <para>
              Enter a numeric <guimenu>Score</guimenu> or select a value from the drop-down list:
            </para>
            <itemizedlist>
              <listitem>
              <para>
                <literal>Always</literal> sets the score to <literal>INFINITY</literal>, which
                means that the resources must run on the same node.
              </para>
              </listitem>
              <listitem>
              <para>
                <literal>Never</literal> sets the score to <literal>-INFINITY</literal>, which
                means that the resources must run on different nodes.
              </para>
              </listitem>
            </itemizedlist>
          </step>
          <step>
            <para>
              From the drop-down list in the <guimenu>Resources</guimenu> section, select a
              resource. A new drop-down list appears. Repeat this step to add more resources.
            </para>
            <para>
              The cluster first decides where to put the last resource, then places the other resources based on that decision. To change the order of the resources, click the up arrow icon to swap a resource with the one above it.
            </para>
            <para>
              To remove a resource from the constraint, click the minus icon.
            </para>
          </step>
          <step performance="optional">
            <para>
              To create a resource set, click the chain icon to link a resource to the
              one above it. You can link multiple resources into a set or create
              multiple resource sets.
            </para>
            <para>
              To remove a resource from the set, click the scissors icon.
            </para>
          </step>
          <step performance="optional">
            <para>
              If required, select a role (<literal>Started</literal>, <literal>Stopped</literal>,
              <literal>Promoted</literal> or <literal>Promotable</literal>) from the drop-down list
              next to a resource. The colocation constraint only applies when the resource
              fulfills this role.
            </para>
          </step>
          <step performance="optional">
            <para>
              You can add a <guimenu>Node Attribute</guimenu> to colocate the resources on a group of nodes instead of one specific node. If the nodes have an attribute assigned, the resources in this constraint will all be placed on nodes with the same value for that attribute.
            </para>
          </step>
          <step>
            <para>
              Click <guimenu>Create</guimenu> to finish the configuration.
            </para>
            <para>
              A message at the top of the screen shows if the action was successful.
            </para>
          </step>
        </procedure>
      </listitem>
    </varlistentry>
  </variablelist>
  <itemizedlist>
    <title>For more information</title>
    <listitem>
      <para>
        <command>crm configure colocation --help</command>
      </para>
    </listitem>
    <listitem>
      <para>
        <command>crm configure help Resourcesets</command>
      </para>
    </listitem>
  </itemizedlist>
</topic>
