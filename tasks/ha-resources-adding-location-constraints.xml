<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>

<!-- refers to legacy doc: https://github.com/SUSE/doc-sleha/blob/main/xml/ha_resource_constraints.xml -->

<topic xml:id="ha-resources-adding-location-constraints"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Adding location constraints</title>
    <meta name="maintainer" content="tahlia.richardson@suse.com" its:translate="no"/>
    <abstract>
      <para>
   A location constraint determines on which node a resource may be run, is
   preferably run, or may not be run. An example of a location constraint is to
   place all resources related to a certain database on the same node. This type
   of constraint may be added multiple times for each resource. All location
   constraints are evaluated for a given resource.
  </para>
  <para>
    The score indicates the value you are
              assigning to this resource constraint. Positive values indicate the
              resource can run on the <guimenu>Node</guimenu> you specify in the next
              step. Negative values mean it should not run on that node. Constraints
              with higher scores are applied before those with lower scores.
  </para>
  <para>
   You can add location constraints using either &hawk; or &crmsh;.
  </para>
    </abstract>
  </info>

  <variablelist role="tabs">
    <varlistentry>
      <term>&crmshell;</term>
      <listitem>
        <para>
          You can perform this procedure on any node in the cluster.
        </para>
        <procedure>
          <step>
            <para>
              Log in either as the &rootuser; user or as a user with <command>sudo</command> privileges.
            </para>
          </step>
          <step>
            <para>
              A simple example that expresses a preference to run the
              resource <literal>fs1</literal> on the node with the name
              <systemitem class="server">&node1;</systemitem> to 100 would be the
              following:
              </para>
<screen>&prompt.user;<command>sudo crm configure location loc-fs1 fs1 100: &node1;</command></screen>
              <para>
              Another example is a location with ping:
              </para>
<screen>&prompt.user;<command>sudo crm configure primitive ping ping \
  params name=ping dampen=5s multiplier=100 host_list="r1 r2" \
  op monitor timeout=60s interval=10s</command>
&prompt.user;<command>sudo crm configure clone cl-ping ping meta interleave=true</command>
&prompt.user;<command>sudo crm configure location loc-node_pref internal_www \
  rule 50: #uname eq &node1; \
  rule ping: defined ping</command></screen>
              <para>
              The parameter <parameter>host_list</parameter> is a space-separated list
              of hosts to ping and count.
              Another use case for location constraints are grouping primitives as a
              <emphasis>resource set</emphasis>. This can be useful if several
              resources depend on, for example, a ping attribute for network
              connectivity. In former times, the <literal>-inf/ping</literal> rules
              needed to be duplicated several times in the configuration, making it
              unnecessarily complex.
              </para>
              <para>
              The following example creates a resource set
              <varname>loc-&node1;</varname>, referencing the virtual IP addresses
              <varname>vip1</varname> and <varname>vip2</varname>:
              </para>
<screen>&prompt.user;<command>sudo crm configure primitive vip1 IPaddr2 params ip=&subnetI;.5 \
  op monitor timeout=20s interval=10s</command>
&prompt.user;<command>sudo crm configure primitive vip2 IPaddr2 params ip=&subnetI;.6 \
  op monitor timeout=20s interval=10s</command>
&prompt.user;<command>sudo crm configure location loc-&node1; { vip1 vip2 } inf: &node1;</command></screen>
              <para>
              In some cases it is much more efficient and convenient to use resource
              patterns for your <command>location</command> command. A resource
              pattern is a regular expression between two slashes. For example, the
              above virtual IP addresses can be all matched with the following:
              </para>
<screen>&prompt.user;<command>sudo crm configure location loc-&node1; /vip.*/ inf: &node1;</command></screen>

          <example xml:id="ex-config-basic-resourceset-loc">
     <title>A resource set for location constraints</title>
     <para>
      For example, you can use the following configuration of a resource
      set (<varname>loc-&node1;</varname>) in the &crmsh; to place
      two virtual IPs (<varname>vip1</varname> and <varname>vip2</varname>)
      on the same node, <varname>&node1;</varname>:
     </para>
<screen>&prompt.crm.conf;<command>primitive vip1 IPaddr2 params ip=&subnetI;.5 op monitor timeout=20s interval=10s</command>
&prompt.crm.conf;<command>primitive vip2 IPaddr2 params ip=&subnetI;.6 op monitor timeout=20s interval=10s</command>
&prompt.crm.conf;<command>location loc-&node1; { vip1 vip2 } inf: &node1;</command></screen>
    </example>
          </step>
        </procedure>
      </listitem>
    </varlistentry>
    <varlistentry>
      <term>&hawk;</term>
      <listitem>
        <para>
          You can access the &hawk; Web interface from any machine that has network access to the nodes.
        </para>
        <procedure>
          <step>
            <para>
              In a Web browser, go to
              <literal>https://<replaceable>HAWKSERVER</replaceable>:7630/</literal>
              and log in.
            </para>
          </step>
          <step>
            <para>
              From the left navigation bar, select <menuchoice><guimenu>Configuration</guimenu>
              <guimenu>Add Constraint</guimenu></menuchoice>.
            </para>
          </step>
          <step>
            <para>
              Click <guimenu>Location</guimenu>.
            </para>
          </step>
          <step>
            <para>
              Enter a unique <guimenu>Constraint ID</guimenu>.
            </para>
          </step>
          <step>
            <para>
              Select one or more <guimenu>Resources</guimenu> to apply the constraint to.
            </para>
            <para>
              To remove a resource from the constraint, press <keycap function="control"/> and
              click the resource again.
            </para>
          </step>
          <step>
            <para>
              Enter a numeric <guimenu>Score</guimenu> or select a value from the drop-down list:
            </para>
            <itemizedlist>
              <listitem>
              <para>
                <literal>Always</literal> sets the score to <literal>INFINITY</literal>, which
                means that the resources must run on the specified node.
              </para>
              </listitem>
              <listitem>
              <para>
                <literal>Never</literal> sets the score to <literal>-INFINITY</literal>, which
                means that the resources must <emphasis>not</emphasis> run on the specified node.
              </para>
              </listitem>
              <listitem>
              <para>
                <literal>Advisory</literal> sets the score to <literal>0</literal>, which disables
                the constraint. This can be useful when you enable resource discovery but do not
                want to constrain the resources.
              </para>
              </listitem>
            </itemizedlist>
          </step>
          <step>
            <para>
              Select a <guimenu>Node</guimenu> to apply the constraint to.
            </para>
          </step>
          <step performance="optional">
            <para>
              Click the <guimenu>Advanced</guimenu> tab if you need to set further parameters.
            </para>
          </step>
          <step performance="optional">
            <para>
              wtf is <guimenu>Resource Discovery</guimenu>
            </para>
          </step>
          <step performance="optional">
            <para>
              <guimenu>Rule</guimenu>
            </para>
            <itemizedlist>
              <listitem>
                <para>
                  <guimenu>Score</guimenu>
                </para>
              </listitem>
              <listitem>
                <para>
                  <guimenu>Role</guimenu>
                </para>
              </listitem>
              <listitem>
                <para>
                  <guimenu>Boolean Operator</guimenu>
                </para>
              </listitem>
              <listitem>
                <para>
                  <guimenu>Expressions</guimenu>
                </para>
              </listitem>
            </itemizedlist>
          </step>
          <step>
            <para>
              Click <guimenu>Create</guimenu> to finish the configuration.
            </para>
            <para>
              A message at the top of the screen shows if the action was successful.
            </para>
          </step>
        </procedure>
      </listitem>
    </varlistentry>
  </variablelist>
</topic>
