<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>

<!-- refers to legacy doc: https://github.com/SUSE/doc-sleha/blob/main/xml/ha_resource_constraints.xml -->

<topic xml:id="ha-resources-adding-order-constraints"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Adding order constraints</title>
    <meta name="maintainer" content="tahlia.richardson@suse.com" its:translate="no"/>
    <abstract>
      <para>
   Order constraints can be used to start or stop a service right before or
   after a different resource meets a special condition, such as being started,
   stopped, or promoted to primary. For example, you cannot mount a file system
   before the device is available to a system. As an order constraint defines
   a dependency between resources, you need at least two resources to create
   an order constraint.
  </para>
  <para>
   You can add order constraints using either &hawk; or &crmsh;.
  </para>
    </abstract>
  </info>

  <variablelist role="tabs">
    <varlistentry>
      <term>&crmshell;</term>
      <listitem>
        <para>
          You can perform this procedure on any node in the cluster.
        </para>
        <procedure>
          <step>
            <para>
              Log in either as the &rootuser; user or as a user with <command>sudo</command> privileges.
            </para>
          </step>
          <step>
            <para>
              Add an order constraint. The basic command requires a name, a kind, and at least two resources:
            </para>
<screen>&prompt.user;<command>sudo crm configure order <replaceable>ORDER_NAME KIND: RESOURCE1 RESOURCE2</replaceable></command></screen>
            <para>
              The <replaceable>KIND</replaceable> can be <literal>Mandatory</literal>, <literal>Optional</literal> or <literal>Serialize</literal>.
            </para>
            <variablelist>
              <title>Additional options</title>
              <varlistentry>
                <term>Resource sets</term>
                <listitem>
                  <para>
                    You can use round brackets to do something or other with multiple resources, and something about the options <literal>require-all</literal> and <literal>sequential</literal> to switch between <literal>AND</literal> and <literal>OR</literal> logic.
                  </para>
<screen>&prompt.user;<command>sudo crm configure order res1-before-res2-res3 \
  Serialize: res1 ( res2 res3 )</command></screen>
                </listitem>
              </varlistentry>
              <varlistentry>
                <term>Symmetry</term>
                <listitem>
                  <para>
                    Most of the time you won't have to set this as the default is true
                  </para>
<screen>&prompt.user;<command>sudo crm configure order res1-before-res2 \
  Mandatory: res1 res2 symmetrical=false</command></screen>
                </listitem>
              </varlistentry>
              <varlistentry>
                <term>Actions</term>
                <listitem>
                  <para>
                    You can require an action (<literal>start</literal>, <literal>stop</literal>, <literal>promote</literal> or <literal>demote</literal>) for one or more resources. The resource must perform this action before the resources after it can start.
                  </para>
<screen>&prompt.user;<command>sudo crm configure order promoted-clone2-before-res1 \
  Mandatory: clone2:promote res1</command></screen>
                </listitem>
              </varlistentry>
            </variablelist>
          </step>
          <step>
            <para>
              You can view all order constraints with the following command:
            </para>
<screen>&prompt.user;<command>sudo crm configure show type:order</command></screen>
          </step>
        </procedure>
      </listitem>
    </varlistentry>
    <varlistentry>
      <term>&hawk;</term>
      <listitem>
        <para>
          You can access the &hawk; Web interface from any machine that has network access to the nodes.
        </para>
        <procedure>
          <step>
            <para>
              In a Web browser, go to
              <literal>https://<replaceable>HAWKSERVER</replaceable>:7630/</literal>
              and log in.
            </para>
          </step>
          <step>
            <para>
              From the left navigation bar, select <menuchoice><guimenu>Configuration</guimenu>
              <guimenu>Add Constraint</guimenu></menuchoice>.
            </para>
          </step>
          <step>
            <para>
              Click <guimenu>Order</guimenu>.
            </para>
          </step>
          <step>
            <para>
              Enter a unique <guimenu>Constraint ID</guimenu>.
            </para>
          </step>
          <step>
            <para>
              Select a <guimenu>Kind</guimenu> from the drop-down list:
            </para>
            <itemizedlist>
              <listitem>
              <para>
                <literal>Mandatory</literal>: Resources <emphasis>must</emphasis> start in
                this order.
              </para>
              </listitem>
              <listitem>
              <para>
                <literal>Optional</literal>: The start order is only a suggestion.
              </para>
              </listitem>
              <listitem>
              <para>
                <literal>Serialize</literal>: The first resource must finish starting before
                the next resource can begin starting. This is useful for resources that put a
                high load on the node during start-up, for example.
              </para>
              </listitem>
            </itemizedlist>
          </step>
          <step>
            <para>
              In most cases, you should keep the option <guimenu>Symmetrical</guimenu> enabled.
              This means that resources stop in the reverse of their start order.
            </para>
          </step>
          <step>
            <para>
              From the drop-down list in the <guimenu>Resources</guimenu> section, select a
              resource. A new drop-down list appears. Repeat this step to add more resources.
            </para>
            <para>
              The resources will start in the order shown on the screen. To change the order,
              click the up arrow icon to swap a resource with the one above it.
            </para>
            <para>
              To remove a resource from the constraint, click the minus icon.
            </para>
          </step>
          <step performance="optional">
            <para>
              To create a resource set, click the chain icon to link a resource to the
              one above it. You can link multiple resources into a set or create
              multiple resource sets.
            </para>
            <para>
              To remove a resource from the set, click the scissors icon.
            </para>
          </step>
          <step performance="optional">
            <para>
              If required, select a condition (<literal>Start</literal>, <literal>Stop</literal>,
              <literal>Promote</literal> or <literal>Demote</literal>) from the drop-down list
              next to a resource. The resource must meet this condition before the resources
              after it can start.
            </para>
          </step>
          <step>
            <para>
              Click <guimenu>Create</guimenu> to finish the configuration.
            </para>
            <para>
              A message at the top of the screen shows if the action was successful.
            </para>
          </step>
        </procedure>
      </listitem>
    </varlistentry>
  </variablelist>
    <itemizedlist>
    <title>For more information</title>
    <listitem>
      <para>
        <command>crm configure order --help</command>
      </para>
    </listitem>
    <listitem>
      <para>
        <command>crm configure help Resourcesets</command>
      </para>
    </listitem>
  </itemizedlist>
</topic>
