<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>

<!-- refers to legacy doc: https://github.com/SUSE/doc-sleha/blob/main/xml/ha_storage_protection.xml -->

<topic xml:id="ha-sbd-changing-diskless-to-diskbased"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Changing diskless &sbd; to disk-based &sbd;</title>
    <meta name="maintainer" content="tahlia.richardson@suse.com" its:translate="no"/>
    <abstract>
      <para>
        Use this procedure to change diskless &sbd; to disk-based &sbd;. This might be needed if
        the cluster's workload changes and now needs multiple &stonith; devices.
      </para>
    </abstract>
  </info>

  <important>
    <title>Cluster restart required</title>
    <para>
      In this procedure, the setup script automatically puts the cluster into maintenance mode
      and restarts the cluster services. In maintenance mode, the cluster stops monitoring all
      resources. This allows the services managed by the resources to keep running even during
      the cluster restart. However, be aware that the resources will not have cluster protection
      while in maintenance mode.
    </para>
  </important>
  <warning>
    <title>Overwriting existing data</title>
    <para>
      Make sure any device you want to use for &sbd; does not hold any important data. Configuring
      a device for use with &sbd; overwrites the existing data.
    </para>
  </warning>
  <itemizedlist>
    <title>Requirements</title>
    <listitem>
      <para>
        Diskless &sbd; is configured and running.
      </para>
    </listitem>
    <listitem>
      <para>
        All nodes can access shared storage.
      </para>
    </listitem>
    <listitem>
      <para>
        The path to the shared storage device is consistent across all nodes. Use stable device
        names such as <filename>/dev/disk/by-id/<replaceable>DEVICE_ID</replaceable></filename>.
      </para>
    </listitem>
  </itemizedlist>
  <para>
    Perform this procedure on only one node in the cluster:
  </para>
  <procedure>
    <step>
      <para>
        Log in either as the &rootuser; user or as a user with <command>sudo</command> privileges.
      </para>
    </step>
    <step>
      <para>
        Check the status of &sbd;:
      </para>
<screen>&prompt.user;<command>sudo crm sbd status</command>
# Type of &sbd;:
Diskless &sbd; configured</screen>
    </step>
    <step>
      <para>
        Configure disk-based &sbd;. Use <option>--force</option> (or <option>-F</option>) to allow
        you to reconfigure &sbd; even when it is already running, and <option>--sbd-device</option>
        (or <option>-s</option>) to specify the shared storage device:
      </para>
<screen>&prompt.user;<command>sudo crm --force cluster init sbd --sbd-device /dev/disk/by-id/<replaceable>DEVICE_ID</replaceable></command></screen>
      <tip role="compact">
        <para>
          You can use <option>--sbd-device</option> (or <option>-s</option>) multiple times to
          configure up to three &sbd; devices.
        </para>
      </tip>
      <para>
        The script initializes &sbd; on the shared storage device, creates a &stonith; cluster
        resource, and updates the &sbd; configuration file and timeout settings. The script also
        puts the cluster into maintenance mode, restarts the cluster services, then puts the
        cluster back into normal operation.
      </para>
    </step>
    <step>
      <para>
        Check the status of the cluster:
      </para>
<screen>&prompt.user;<command>sudo crm status</command></screen>
      <para>
        The nodes should be <literal>Online</literal> and the resources <literal>Started</literal>.
      </para>
    </step>
    <step>
      <para>
        Check the status of &sbd;:
      </para>
<screen>&prompt.user;<command>sudo crm sbd status</command>
# Type of &sbd;:
Disk-based &sbd; configured</screen>
    </step>
  </procedure>
</topic>
