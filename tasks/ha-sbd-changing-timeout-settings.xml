<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>

<!-- partially refers to legacy doc: https://github.com/SUSE/doc-sleha/blob/main/xml/ha_storage_protection.xml -->

<topic xml:id="ha-sbd-changing-timeout-settings"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Changing the &sbd; timeout settings</title>
    <meta name="maintainer" content="tahlia.richardson@suse.com" its:translate="no"/>
    <abstract>
      <para>
        &sbd; relies on multiple different timeout settings to manage node fencing. When you
        configure &sbd; using the &crmshell;, these timeouts and their relationships to one another
        are automatically calculated and adjusted.
      </para>
      <para>
        Use the <command>crm sbd configure</command> command if you need to change the timeout
        values. This command adjusts related timeouts automatically. It also warns you if you
        try to change related timeouts to inappropriate values, and displays the required formula.
    </para>
    </abstract>
  </info>

  <para>
    TODO: Add cluster restart warning when available.
  </para>
  <itemizedlist>
    <title>Requirements</title>
    <listitem>
      <para>
        &sbd; is already configured and running.
      </para>
    </listitem>
  </itemizedlist>
  <para>
    Perform this procedure on only one node in the cluster:
  </para>
<procedure>
    <step>
      <para>
        Log in either as the &rootuser; user or as a user with <command>sudo</command> privileges.
      </para>
    </step>
    <step>
      <para>
        Check the current timeout settings:
      </para>
<screen>&prompt.user;<command>sudo crm sbd configure show</command></screen>
    </step>
    <step>
      <para>
        Change one or more of the following timeout settings as needed:
      </para>
<screen>&prompt.user;<command>sudo crm sbd configure \</command>
  <command>watchdog-timeout=<replaceable>INTEGER_IN_SECONDS</replaceable> \</command><co xml:id="co-sbd-watchdog-timeout"/>
  <command>msgwait-timeout=<replaceable>INTEGER_IN_SECONDS</replaceable> \</command><co xml:id="co-sbd-msgwait-timeout"/>
  <command>allocate-timeout=<replaceable>INTEGER_IN_SECONDS</replaceable> \</command><co xml:id="co-sbd-allocate-timeout"/>
  <command>loop-timeout=<replaceable>INTEGER_IN_SECONDS</replaceable></command><co xml:id="co-sbd-loop-timeout"/></screen>
      <calloutlist>
        <callout arearefs="co-sbd-watchdog-timeout">
          <para>
            If the watchdog is not <quote>fed</quote> by &sbd; within this time, it fences the node. For diskless &sbd;, this timeout is set in the <filename>/etc/sysconfig/sbd</filename> file. For disk-based &sbd;, it is set in the device metadata, which takes precedence over the settings in <filename>/etc/sysconfig/sbd</filename>.
          </para>
          <para>
            If the &sbd; devices are on a multipath setup or iSCSI, the timeout must be long enough to detect a path failure and switch to the next path. In <filename>/etc/multipath.conf</filename>, the value of <literal>max_polling_interval</literal> must be less than the <literal>watchdog-timeout</literal>.
         </para>
        </callout>
        <callout arearefs="co-sbd-msgwait-timeout">
          <para>
            <emphasis>Disk-based &sbd; only.</emphasis> This defines the time after which a message written to a node's slot on the &sbd; device is considered delivered. It should be long enough for the node to detect that it needs to self-fence. This must be at least double the <literal>watchdog-timeout</literal>.
          </para>
        </callout>
        <callout arearefs="co-sbd-allocate-timeout">
          <para>
            <emphasis>Disk-based &sbd; only.</emphasis> OK but what actually is it though?? The default setting is sufficient for most use cases.
          </para>
        </callout>
        <callout arearefs="co-sbd-loop-timeout">
          <para>
            <emphasis>Disk-based &sbd; only.</emphasis> And what is this?? The default setting is sufficient for most use cases.
          </para>
        </callout>
      </calloutlist>
    </step>
    <step>
      <para>
        TODO: Add cluster restart steps when available
      </para>
    </step>
    <step>
      <para>
        The global cluster properties <literal>stonith-timeout</literal> and <literal>stonith-watchdog-timeout</literal> are automatically adjusted when you change the <literal>watchdog-timeout</literal> or <literal>msgwait-timeout</literal>. If you need to change the values for these properties, you can use the following commands. However, be aware that <command>crm configure property</command> does <emphasis>not</emphasis> warn you if you set these timeouts too low for the related &sbd; timeouts.
      </para>
<screen>&prompt.user;<command>sudo crm configure property stonith-timeout=<replaceable>INTEGER_IN_SECONDS</replaceable></command><co xml:id="co-stonith-timeout"/>
&prompt.user;<command>sudo crm configure property stonith-watchdog-timeout=<replaceable>INTEGER_IN_SECONDS</replaceable></command><co xml:id="co-stonith-watchdog-timeout"/></screen>
      <calloutlist>
        <callout arearefs="co-stonith-timeout">
          <para>
            This defines how long to wait for the &stonith; action to complete.
          </para>
       </callout>
       <callout arearefs="co-stonith-watchdog-timeout">
          <para>
            <emphasis>Diskless &sbd; only.</emphasis> This defines how long to wait for the node
            to be fenced by the watchdog.
          </para>
        </callout>
      </calloutlist>
    </step>
    <step>
      <para>
        Confirm that the timeout settings changed:
      </para>
<screen>&prompt.user;<command>sudo crm sbd configure show</command></screen>
    </step>
  </procedure>

  <variablelist xml:id="ha-sbd-calculating-timeouts">
    <title>Manually calculating timeouts</title>
    <para>
      If you need to manually calculate any timeouts, you can use these basic formulas for most
      use cases:
    </para>
    <varlistentry>
      <term>Disk-based &sbd;</term>
      <listitem>
<screen>msgwait-timeout &gt;= (watchdog-timeout * 2)
stonith-timeout &gt;= msgwait-timeout + 20%</screen>
      </listitem>
    </varlistentry>
    <varlistentry>
      <term>Diskless &sbd;</term>
      <listitem>
<screen>stonith-watchdog-timeout &gt;= (watchdog-timeout * 2)
stonith-timeout &gt;= stonith-watchdog-timeout + 20%</screen>
      </listitem>
    </varlistentry>
  </variablelist>
</topic>
