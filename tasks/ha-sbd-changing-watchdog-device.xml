<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>

<topic xml:id="ha-sbd-changing-watchdog-device"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Changing the &sbd; watchdog device</title>
    <meta name="maintainer" content="tahlia.richardson@suse.com" its:translate="no"/>
    <abstract>
      <para>
        Use this procedure to change the watchdog device that &sbd; uses. This can be useful if
        your system has multiple hardware watchdogs available or if you need to switch from the
        software watchdog to a hardware watchdog.
      </para>
    </abstract>
  </info>

  <important><!-- Replace with snippet when available -->
    <title>Cluster restart required</title>
    <para>
      In this procedure, the script checks whether it is safe to restart the cluster services
      automatically. If any non-&stonith; resources are running, the script warns you to restart
      the cluster services manually. This allows you to put the cluster into maintenance mode first
      to avoid resource downtime. However, be aware that the resources will not have cluster
      protection while in maintenance mode.
    </para>
  </important>
  <itemizedlist>
    <title>Requirements</title>
    <listitem>
      <para>
        &sbd; is already configured and running.
      </para>
    </listitem>
    <listitem>
      <para>
        All nodes have the new watchdog device available.
      </para>
    </listitem>
  </itemizedlist>
  <para>
    Perform this procedure on only one node in the cluster:
  </para>
  <procedure>
    <step>
      <para>
        Log in either as the &rootuser; user or as a user with <command>sudo</command> privileges.
      </para>
    </step>
    <step>
      <para>
        Check the available watchdog devices:
      </para>
<screen>&prompt.user;<command>sudo sbd query-watchdog</command></screen>
      <para>
        The output shows which watchdog is being used by &sbd; and which other watchdogs are available.
      </para>
    </step>
    <step>
      <para>
        Change the &sbd; watchdog device, specifying either the device name (for example,
        <filename>/dev/watchdog1</filename>) or the driver name (for example,
        <systemitem>iTCO_wdt</systemitem>):
      </para>
<screen>&prompt.user;<command>sudo crm sbd configure watchdog-device=<replaceable>WATCHDOG</replaceable></command></screen>
      <para>
        The script updates the &sbd; configuration file with the new watchdog device and checks
        whether it is safe to restart the cluster services automatically. If any non-&stonith;
        resources are running, the script warns you to restart the cluster services manually.
      </para>
    </step>
    <step><!-- Replace with snippet when available -->
      <para>
        If you need to restart the cluster services manually, follow these steps to avoid
        resource downtime:
      </para>
      <substeps>
        <step>
          <para>
            Put the cluster into maintenance mode:
          </para>
<screen>&prompt.user;<command>sudo crm maintenance on</command></screen>
          <para>
            In this state, the cluster stops monitoring all resources. This allows the services
            managed by the resources to keep running during the cluster restart. However, be aware
            that the resources will not have cluster protection while in maintenance mode.
          </para>
        </step>
        <step>
          <para>
            Restart the cluster services on all nodes:
          </para>
<screen>&prompt.user;<command>sudo crm cluster restart --all</command></screen>
        </step>
        <step>
          <para>
            Check the status of the cluster:
          </para>
<screen>&prompt.user;<command>sudo crm status</command></screen>
          <para>
            The nodes will have the status <literal>UNCLEAN (offline)</literal>, but will soon
            change to <literal>Online</literal>.
          </para>
        </step>
        <step>
          <para>
            When the nodes are back online, put the cluster back into normal operation:
          </para>
<screen>&prompt.user;<command>sudo crm maintenance off</command></screen>
        </step>
      </substeps>
    </step>
    <step>
      <para>
        Check the watchdog devices again:
      </para>
<screen>&prompt.user;<command>sudo sbd query-watchdog</command></screen>
      <para>
        The output should now show the new watchdog device being used by &sbd;.
      </para>
    </step>
    <step>
      <para>
        Check that the correct watchdog is configured on all nodes:
      </para>
<screen>&prompt.user;<command>sudo crm sbd status</command></screen>
      <para>
        In the section <literal>Watchdog info</literal>, the watchdog device and driver should be
        the same on every node.
      </para>
    </step>
  </procedure>
</topic>
