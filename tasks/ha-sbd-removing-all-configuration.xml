<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>

<topic xml:id="ha-sbd-removing-all-configuration"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Removing all &sbd; configuration</title>
    <meta name="maintainer" content="tahlia.richardson@suse.com" its:translate="no"/>
    <abstract>
      <para>
        Use this procedure to remove all &sbd;-related configuration from the cluster. You might
        need to do this if you want to switch from &sbd; to a physical &stonith; device. Keep in
        mind that to be supported, all &sleha; clusters <emphasis>must</emphasis> have either
        &sbd; or a physical &stonith; device configured.
      </para>
    </abstract>
  </info>

  <important><!-- Replace with snippet when available -->
    <title>Cluster restart required</title>
    <para>
      In this procedure, the script checks whether it is safe to restart the cluster services
      automatically. If any non-&stonith; resources are running, the script warns you to restart
      the cluster services manually. This allows you to put the cluster into maintenance mode first
      to avoid resource downtime. However, be aware that the resources will not have cluster
      protection while in maintenance mode.
    </para>
  </important>
  <para>
    Perform this procedure on only one node in the cluster:
  </para>
  <procedure>
    <step>
      <para>
        Log in either as the &rootuser; user or as a user with <command>sudo</command> privileges.
      </para>
    </step>
    <step>
      <para>
        Remove the &sbd; configuration from the cluster:
      </para>
<screen>&prompt.user;<command>sudo crm sbd purge</command></screen>
      <para>
        The script stops the &sbd; service on all nodes, moves the &sbd; configuration file to a
        backup file, and adjusts any &sbd;-related cluster properties. The script also checks
        whether it is safe to restart the cluster services automatically. If any non-&stonith;
        resources are running, the script warns you to restart the cluster services manually.
      </para>
    </step>
    <step><!-- Replace with snippet when available -->
      <para>
        If you need to restart the cluster services manually, follow these steps to avoid
        resource downtime:
      </para>
      <substeps>
        <step>
          <para>
            Put the cluster into maintenance mode:
          </para>
<screen>&prompt.user;<command>sudo crm maintenance on</command></screen>
          <para>
            In this state, the cluster stops monitoring all resources. This allows the services
            managed by the resources to keep running during the cluster restart. However, be aware
            that the resources will not have cluster protection while in maintenance mode.
          </para>
        </step>
        <step>
          <para>
            Restart the cluster services on all nodes:
          </para>
<screen>&prompt.user;<command>sudo crm cluster restart --all</command></screen>
        </step>
        <step>
          <para>
            Check the status of the cluster:
          </para>
<screen>&prompt.user;<command>sudo crm status</command></screen>
          <para>
            The nodes will have the status <literal>UNCLEAN (offline)</literal>, but will soon
            change to <literal>Online</literal>.
          </para>
        </step>
        <step>
          <para>
            When the nodes are back online, put the cluster back into normal operation:
          </para>
<screen>&prompt.user;<command>sudo crm maintenance off</command></screen>
        </step>
      </substeps>
    </step>
    <step>
      <para>
        Confirm that the &sbd; configuration is gone:
      </para>
<screen>&prompt.user;<command>sudo crm sbd status</command>
ERROR: SBD configuration file /etc/sysconfig/sbd not found</screen>
    </step>
    <step>
      <para>
        Check the cluster configuration:
      </para>
<screen>&prompt.user;<command>sudo crm configure show</command></screen>
      <para>
        The output should show <literal>stonith-enabled=false</literal> and no other &sbd;-related
        properties.
      </para>
    </step>
  </procedure>
</topic>
