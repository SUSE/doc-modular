<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>

<!-- refers to legacy doc: https://github.com/SUSE/doc-sleha/blob/main/xml/ha_storage_protection.xml -->

<topic xml:id="ha-sbd-simulating-failure"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Simulating an &sbd; failure</title>
    <meta name="maintainer" content="tahlia.richardson@suse.com" its:translate="no"/>
    <abstract>
      <para>
        Check that the watchdog successfully restarts the node if the &sbd; service fails.
        This procedure uses example nodes called <systemitem>&node1;</systemitem> and
        <systemitem>&node2;</systemitem>.
      </para>
    </abstract>
  </info>
  <procedure>
    <step>
      <para>
        On <systemitem>&node2;</systemitem>, identify the process ID of the &sbd; inquisitor:
      </para>
<screen>&prompt.user;<command>systemctl status sbd</command>
● sbd.service - Shared-storage based fencing daemon
[...]
   Main PID: 1246 (sbd)
      Tasks: 4
     CGroup: /system.slice/sbd.service
       ├─<emphasis role="bold">1246 "sbd: inquisitor"</emphasis>
       ├─1247 "sbd: watcher: /dev/disk/by-id/<replaceable>DEVICE_ID</replaceable>"
       ├─1248 "sbd: watcher: Pacemaker"
       └─1249 "sbd: watcher: Cluster"</screen>
    </step>
    <step>
      <para>
        Simulate an &sbd; failure by terminating the &sbd; inquisitor process. In this example,
        the process ID of the &sbd; inquisitor is <literal>1246</literal>:
      </para>
<screen>&prompt.user;<command>sudo kill -9 1246</command></screen>
    </step>
    <step>
      <para>
        On <systemitem>&node1;</systemitem>, check the cluster status. It should show a pending fencing action for <systemitem>&node2;</systemitem>:
      </para>
<screen>&prompt.user;<command>sudo crm status</command>
[...]
Pending Fencing Actions:
  * reboot of &node2; for pacemaker-controld.1600@&node1; last pending</screen>
      <para>
        If any resources were running on <systemitem>&node2;</systemitem>, they should migrate to
        <systemitem>&node1;</systemitem>.
      </para>
    </step>
    <step>
      <para>
        Keep checking the cluster status until it stabilizes. <systemitem>&node2;</systemitem>
        will go through multiple statuses, including <literal>UNCLEAN (offline)</literal>,
        <literal>UNCLEAN (online)</literal> and <literal>pending</literal>, until finally it
        comes back <literal>Online</literal>.
      </para>
    </step>
  </procedure>
</topic>
