<?xml version="1.0" encoding="UTF-8"?>
<!-- This file originates from the project https://github.com/openSUSE/doc-kit -->
<!-- This file can be edited downstream. -->
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<!DOCTYPE article
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<topic xml:id="keylime-run-with-podman" xml:lang="en"
 role="task"
 xmlns="http://docbook.org/ns/docbook" version="5.1"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink">
  <info>
    <meta name="maintainer" content="tbazant@suse.com" its:translate="no"/>
    <title>Running the &keylime; workload using &podman;</title>
    <abstract>
      <para>
        &keylime; is a remote attestation solution. It helps you monitor the
        health of remote nodes. The verifier and registrar are essential
        &keylime; components. You use these components on remote systems to
        register and attest &keylime; agents.
      </para>
    </abstract>
  </info>
  <note>
    <para>
      This document describes a container. The container delivers &keylime;
      control plane services. These services include the verifier, registrar,
      and tenant command-line interface (CLI).
    </para>
  </note>
  <para>
    Before installing and registering agents, prepare the verifier and registrar
    on remote hosts. The following procedure describes how to prepare them.
  </para>
  <procedure>
    <step>
      <para>
        Identify the &keylime; workload image.
      </para>
<screen>
&prompt.root;podman search keylime
[...]
registry.opensuse.org/devel/microos/containers/containerfile/opensuse/keylime-control-plane
</screen>
    </step>
    <step>
      <para>
        Pull the image from the registry.
      </para>
<screen>&prompt.root;podman pull\
  registry.opensuse.org/devel/microos/containers/containerfile/opensuse/keylime-control-plane:latest</screen>
    </step>
    <step>
      <para>
        Create the <literal>keylime-control-plane</literal> volume. This
        persists the database and certificates for attestation.
      </para>
<screen>&prompt.root;podman container runlabel install \
  registry.opensuse.org/devel/microos/containers/containerfile/opensuse/keylime-control-plane:latest</screen>
    </step>
    <step>
      <para>
        Start the container and its services.
      </para>
<screen>&prompt.root;podman container runlabel run \
  registry.opensuse.org/devel/microos/containers/containerfile/opensuse/keylime-control-plane:latest</screen>
      <para>
        This creates the <literal>keylime-control-plane</literal> container. The
        container includes configured and running registrar and verifier
        services. It internally exposes ports 8881, 8890, and 8891 to the host.
        These ports use default values. Validate your firewall configuration.
        Ensure it allows access to these ports and communication between
        containers. The tenant CLI requires this communication.
      </para>
    </step>
  </procedure>
  <tip>
    <para>
      To stop the &keylime; services, run this command:
    </para>
<screen>&prompt.root;<command>podman kill keylime-control-plane-container</command></screen>
  </tip>
  <section xml:id="keylime-monitor">
    <title>Monitoring &keylime; services</title>
    <para>
      To check the status of running containers on the host, run this command:
    </para>
<screen>&prompt.root;podman ps</screen>
    <para>
      To view the &keylime; service logs, run this command:
    </para>
<screen>&prompt.root;podman logs keylime-control-plane-container</screen>
  </section>
  <section xml:id="keylime-executing-tenant">
    <title>Executing the tenant CLI</title>
    <para>
      The container includes the tenant CLI tool. If the host firewall does not
      interfere with the exposed ports, you can execute the CLI using the same
      image:
    </para>
<screen>&prompt.root;<command>podman run --rm \
-v keylime-control-plane-volume:/var/lib/keylime/ \
keylime-control-plane:latest \
keylime_tenant -v 10.88.0.1 -r 10.88.0.1 --cert default -c reglist</command></screen>
  </section>
  <section xml:id="keylime-extract-certificates">
    <title>Extracting the &keylime; certificate</title>
    <para>
      When you first execute the &keylime; container, its services create a
      certificate. Several agents require this certificate. Extract the
      certificate from the container. Then, copy it to the agent's
      <filename>/var/lib/keylime/cv_ca/</filename> directory.
    </para>
<screen>&prompt.root;<command>podman cp \
keylime-control-plane-container:/var/lib/keylime/cv_ca/cacert.crt
.</command>
&prompt.root;scp cacert.crt
<replaceable>AGENT_HOST:/var/lib/keylime/cv_ca/</replaceable></screen>
    <tip>
      <para>
        For more details about installing the agent, see
        <xref linkend="keylime-install-agent"/>.
      </para>
    </tip>
  </section>
</topic>
