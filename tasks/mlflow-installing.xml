<?xml version="1.0" encoding="UTF-8"?>
<!-- This file originates from the project https://github.com/openSUSE/doc-kit -->
<!-- This file can be edited downstream. -->
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<topic xml:id="mlflow-installing"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Installing &mlflow;</title>
    <meta name="maintainer" content="tbazant@suse.com" its:translate="no"/>
    <abstract>
      <para>
        &mlflow; is an open-source platform for managing the end-to-end machine
        learning lifecycle. It provides a centralized model registry to track
        and manage the entire lifecycle of machine learning models. &mlflow;
        includes tools for experiment tracking, model packaging, versioning and
        deployment. This helps to streamline the process of moving models from
        development to production, ensuring reproducibility and collaboration
        among data science teams.
      </para>
    </abstract>
  </info>
  <para>
    This section describes how to deploy &mlflow; using either &docker; or
    &helm; on a &kube; cluster.
  </para>
<!-- 2025-11-26 tbazant: commenting for now as we don't have an mlflow chart in appco
  <section xml:id="mlflow-installing-app-details">
    <title>Details about the &mlflow; application</title>
    <para>
      Before deploying &mlflow;, it is important to know more about the
      supported configurations and documentation. The following command provides
      the corresponding details:
    </para>
<screen>helm show values oci://dp.apps.rancher.io/charts/mlflow</screen>
    <para>
      Alternatively, you can also refer to the &mlflow; &helm; chart page on the
      &sappco; site at
      <link xlink:href="https://apps.rancher.io/applications/mlflow"/>. It
      contains &mlflow; dependencies, available versions and the link to pull
      the &mlflow; container image.
    </para>
  </section>
-->
  <section xml:id="mlflow-installing-kubernetes">
    <title>Installing &mlflow; using &helm; on a &kube; cluster</title>
    <procedure>
      <xi:include href="../snippets/ai-library-requirement.xml"/>
      <step>
        <para>
          Create a skeleton for a new <literal>&mlflow;</literal> &helm; chart.
        </para>
<screen>&prompt.user;<command>helm create mlflow</command></screen>
        <para>
          The command creates an <filename>mlflow</filename> directory with the
          basic file structure for a chart.
        </para>
      </step>
      <step>
        <para>
          Replace <filename>mlflow/values.yaml</filename> with the following
          content. Replace <replaceable>CHART_VERSION</replaceable> with the
          current chart version.
        </para>
<screen># values.yaml
replicaCount: 1
image:
  repository: dp.apps.rancher.io/containers/mlflow 
  pullPolicy: IfNotPresent
  tag: "<replaceable>CHART_VERSION</replaceable>"
imagePullSecrets:
  - name: application-collection
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

service:
  type: ClusterIP
  port: 5000

ingress:
  enabled: true
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: suse-mlflow
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local


resources:
   limits:
     cpu: "2"
     memory: "2Gi"
   requests:
     cpu: "1"
     memory: "1Gi"

livenessProbe:
  httpGet:
    path: /health
    port: 5000
readinessProbe:
  httpGet:
    path: /health
    port: 5000

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

# Additional volumes on the output Deployment definition.
volumes: []
# - name: foo
#   secret:
#     secretName: mysecret
#     optional: false

# Additional volumeMounts on the output Deployment definition.
volumeMounts: []
# - name: foo
#   mountPath: "/etc/foo"
#   readOnly: true

nodeSelector: {}

tolerations: []

affinity: {}</screen>
      </step>
      <step>
        <para>
          Replace <filename>mlflow/template/deployment.yaml</filename> with the
          following content:
        </para>
<screen>apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mlflow.fullname" . }}
  labels:
    {{- include "mlflow.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "mlflow.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "mlflow.labels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "mlflow.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /usr/bin/mlflow 
            - server
            - --host
            - "0.0.0.0"
            - --port
            - "5000"
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          livenessProbe:
            {{- toYaml .Values.livenessProbe | nindent 12 }}
          readinessProbe:
            {{- toYaml .Values.readinessProbe | nindent 12 }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          {{- with .Values.volumeMounts }}
          volumeMounts:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- with .Values.volumes }}
      volumes:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}</screen>
      </step>
      <step>
        <para>
          Install &mlflow; using the following command:
        </para>
<screen>&prompt.user;<command>helm install mlflow ./mlflow \
  -n <replaceable>SUSE_AI_NAMESPACE</replaceable></command></screen>
      </step>
      <step>
        <para>
          Validate that &ingress; is enabled for &mlflow;.
        </para>
<screen>&prompt.user;<command>kubectl get ingress --all-namespaces</command>
NAMESPACE        AME       CLASS HOSTS                ADDRESS     PORTS     AGE
[...]
suse-private-ai  mlflow     nginx suse-mlflow         10.0.3.184  80        153m
suse-private-ai  pen-webui nginx suse-ollama-webui    10.0.3.184  80, 443   8h</screen>
      </step>
    </procedure>
    <section xml:id="mlflow-uninstalling">
      <title>Uninstalling &mlflow;</title>
      <para>
        To uninstall &mlflow;, run the following command:
      </para>
<screen>&prompt.user;<command>helm uninstall mlflow -n <replaceable>SUSE_AI_NAMESPACE</replaceable></command></screen>
    </section>
  </section>
  <section xml:id="mlflow-installing-docker">
    <title>Installing &mlflow; using &docker;</title>
    <para>
      There are two ways to install &mlflow; using &docker;:
    </para>
    <itemizedlist>
      <listitem>
        <para>
          By downloading and running the
          <xref linkend="mlflow-docker-container"
          xrefstyle="template: &mlflow; container"/>
          directly.
        </para>
      </listitem>
      <listitem>
        <para>
          By creating an
          <xref linkend="mlflow-docker-compose"
          xrefstyle="template: &mlflow; &docker; Compose"/>
          YAML file.
        </para>
      </listitem>
    </itemizedlist>
    <procedure xml:id="mlflow-docker-container">
      <title>Installing &mlflow; using a &docker; container</title>
      <step>
        <para>
          Download the &mlflow; container. Replace
          <replaceable>CHART_VERSION</replaceable> with the current chart
          version.
        </para>
<screen>&prompt.user;<command>docker pull dp.apps.rancher.io/containers/mlflow:<replaceable>CHART_VERSION</replaceable></command></screen>
      </step>
      <step performance="optional">
        <para>
          Verify the downloaded image.
        </para>
<screen>&prompt.user;<command>docker images</command>
REPOSITORY                           TAG    IMAGE ID     CREATED      SIZE
dp.apps.rancher.io/containers/mlflow 3.6.0  d984124afc22 33 hours ago 715MB</screen>
      </step>
      <step>
        <para>
          Run the &mlflow; server by starting the container at port 5000.
          Replace <replaceable>CHART_VERSION</replaceable> with the current
          chart version.
        </para>
<screen>&prompt.user;<command> docker run -p 5000:5000 \
  dp.apps.rancher.io/containers/mlflow:<replaceable>CHART_VERSION</replaceable> mlflow server \
  --host 0.0.0.0 --port 5000</command>
[2025-11-27 18:34:15 +0000] [12] [INFO] Starting gunicorn 23.0.0
[2025-11-27 18:34:15 +0000] [12] [INFO] Listening at: http://0.0.0.0:5000 (12)
[2025-11-27 18:34:15 +0000] [12] [INFO] Using worker: sync
[2025-11-27 18:34:15 +0000] [13] [INFO] Booting worker with pid: 13
[2025-11-27 18:34:15 +0000] [14] [INFO] Booting worker with pid: 14
[2025-11-27 18:34:15 +0000] [15] [INFO] Booting worker with pid: 15
[2025-11-27 18:34:15 +0000] [16] [INFO] Booting worker with pid: 16</screen>
      </step>
    </procedure>
    <procedure xml:id="mlflow-docker-compose">
      <title>Installing &mlflow; using a &docker; Compose YAML file</title>
      <step>
        <para>
          Create a <filename>docker-compose.yaml</filename> file with the
          following content:
        </para>
<screen>services:
  mlflow:
    image: dp.apps.rancher.io/containers/mlflow:<replaceable>CHART_VERSION</replaceable>
    container_name: mlflow
    restart: always
    ports:
      - "5000:5000"
    command:
      - /usr/bin/mlflow
      - server
      - --host
      - "0.0.0.0"
      - --port
      - "5000"</screen>
      </step>
      <step>
        <para>
          Run &mlflow; using the following command:
        </para>
<screen>&prompt.user;<command>docker-compose up -d</command>
[...]
[+] Running 2/2
 \u2714 Network &exampleuser_plain;_default  Created                0.0s 
 \u2714 Container mlflow      Started                         4s</screen>
      </step>
      <step performance="optional">
        <para>
          Verify that the container is running.
        </para>
<screen><command>(venv) &exampleuser_plain;@localhost:~[] docker ps</command>
CONTAINER ID IMAGE    ...     STATUS          PORTS                     NAMES
1e58723cb3d  mlflow:3.6.0     Up 23 seconds   0.0.0.0:5000-&gt;5000/tcp... mlflow</screen>
      </step>
      <step performance="optional">
        <para>
          Follow the logs to ensure that the &mlflow; server has started
          correctly.
        </para>
<screen>&prompt.user;<command>(venv) &exampleuser_plain;@localhost:~[] docker-compose logs -f</command>
mlflow [2025-11-01 00:56:54 +0000] [3] [INFO] Starting gunicorn 23.0.0
mlflow [2025-11-01 00:56:54 +0000] [3] [INFO] Listening at: http://0.0.0.0:5000 (3)
mlflow [2025-11-01 00:56:54 +0000] [3] [INFO] Using worker: sync
mlflow [2025-11-01 00:56:54 +0000] [4] [INFO] Booting worker with pid: 4
mlflow [2025-11-01 00:56:54 +0000] [5] [INFO] Booting worker with pid: 5
mlflow [2025-11-01 00:56:55 +0000] [6] [INFO] Booting worker with pid: 6
mlflow [2025-11-01 00:56:55 +0000] [7] [INFO] Booting worker with pid: 7</screen>
      </step>
    </procedure>
  </section>
  <section xml:id="mlflow-accessing">
    <title>Accessing &mlflow; Web UI</title>
    <para>
      After the &mlflow; server is up and running, you can access it from a Web
      browser either on the local host or exposed via &ingress;.
    </para>
    <para>
      To access &mlflow; locally, point your Web browser to
      <literal>http://localhost:5000</literal>.
    </para>
    <para>
      To access &mlflow; via &ingress;, add a corresponding line to your
      <filename>/etc/hosts</filename>, for example:
    </para>
<screen>10.0.3.184 suse-mflow</screen>
    <para>
      Then point your Web browser to <literal>http://suse-mlflow</literal>.
    </para>
    <figure xml:id="fg-mlflow-webui">
      <title>&mlflow; Web UI</title>
      <mediaobject>
        <imageobject role="fo">
          <imagedata fileref="mlflow-webui.png" width="100%"/>
        </imageobject>
        <imageobject role="html">
          <imagedata fileref="mlflow-webui.png" width="100%"/>
        </imageobject>
        <textobject role="description"><phrase>A screenshot showing the &mlflow; Web user interface</phrase>
        </textobject>
      </mediaobject>
    </figure>
    <tip>
      <title>For more information</title>
      <para>
        Explore &mlflow; core features, model training, tracing (observability)
        and more by following the
        <link xlink:href="https://github.com/mlflow/mlflow?tab=readme-ov-file#-core-components">official
        documentation</link>.
      </para>
    </tip>
  </section>
</topic>
