<?xml version="1.0" encoding="UTF-8"?>
<!-- This file originates from the project https://github.com/openSUSE/doc-kit -->
<!-- This file can be edited downstream. -->
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<topic xml:id="mlflow-installing"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Installing &mlflow;</title>
    <meta name="maintainer" content="tbazant@suse.com" its:translate="no"/>
    <abstract>
      <para>
        &mlflow; is an open-source platform for managing the end-to-end machine
        learning lifecycle. It provides a centralized model registry to track
        and manage the entire lifecycle of machine learning models. &mlflow;
        includes tools for experiment tracking, model packaging, versioning and
        deployment. This helps to streamline the process of moving models from
        development to production, ensuring reproducibility and collaboration
        among data science teams.
      </para>
    </abstract>
  </info>
  <para>
    This section describes how to deploy &mlflow; using either &docker; or
    &helm; on a &kube; cluster.
  </para>
  <section xml:id="mlflow-installing-app-details">
    <title>Details about the &mlflow; application</title>
    <para>
      Before deploying &mlflow;, it is important to know more about the
      supported configurations and documentation. The following command provides
      the corresponding details:
    </para>
<screen>helm show values oci://dp.apps.rancher.io/charts/mlflow</screen>
    <para>
      Alternatively, you can also refer to the &mlflow; &helm; chart page on the
      &sappco; site at
      <link xlink:href="https://apps.rancher.io/applications/mlflow"/>. It
      contains &mlflow; dependencies, available versions and the link to pull
      the &mlflow; container image.
    </para>
  </section>
  <section xml:id="mlflow-installing-procedure">
    <title>Installing &mlflow; using &helm; on a &kube; cluster</title>
    <procedure>
      <xi:include href="../snippets/ai-library-requirement.xml"/>
      <step>
        <para>
          Create a skeleton for a new <literal>&mlflow;</literal> &helm; chart.
        </para>
<screen>&prompt.user;<command>helm create mlflow</command></screen>
        <para>
          The command creates a <filename>mlflow</filename> directory with the
          basic files structure for a chart.
        </para>
      </step>
      <step>
        <para>
          Replace <filename>mlflow/values.yaml</filename> with the following
          content:
        </para>
<screen># values.yaml
replicaCount: 1
image:
  repository: dp.apps.rancher.io/containers/mlflow 
  pullPolicy: IfNotPresent
  tag: "2.20.2"
imagePullSecrets:
  - name: application-collection
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

service:
  type: ClusterIP
  port: 5000

ingress:
  enabled: true
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: suse-mlflow
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local


resources:
   limits:
     cpu: "2"
     memory: "2Gi"
   requests:
     cpu: "1"
     memory: "1Gi"

livenessProbe:
  httpGet:
    path: /health
    port: 5000
readinessProbe:
  httpGet:
    path: /health
    port: 5000

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

# Additional volumes on the output Deployment definition.
volumes: []
# - name: foo
#   secret:
#     secretName: mysecret
#     optional: false

# Additional volumeMounts on the output Deployment definition.
volumeMounts: []
# - name: foo
#   mountPath: "/etc/foo"
#   readOnly: true

nodeSelector: {}

tolerations: []

affinity: {}</screen>
      </step>
      <step>
        <para>
          Replace <filename>mlflow/template/deployment.yaml</filename> with the
          following content:
        </para>
<screen>apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mlflow.fullname" . }}
  labels:
    {{- include "mlflow.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "mlflow.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "mlflow.labels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "mlflow.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /usr/bin/mlflow 
            - server
            - --host
            - "0.0.0.0"
            - --port
            - "5000"
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          livenessProbe:
            {{- toYaml .Values.livenessProbe | nindent 12 }}
          readinessProbe:
            {{- toYaml .Values.readinessProbe | nindent 12 }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          {{- with .Values.volumeMounts }}
          volumeMounts:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- with .Values.volumes }}
      volumes:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}</screen>
      </step>
      <step>
        <para>
          Install &mlflow; using the following command:
        </para>
<screen>&prompt.user;<command>helm install mlflow ./mlflow \
  --values ./mlflow/values.yaml \
  -n <replaceable>SUSE_AI_NAMESPACE</replaceable></command></screen>
      </step>
      <step>
        <para>
          Validate that &ingress; is enabled for &mlflow;.
        </para>
<screen>&prompt.user;<command>kubectl get ingress --all-namespaces</command>
NAMESPACE        AME       CLASS HOSTS                ADDRESS     PORTS     AGE
[...]
suse-private-ai  mlflow     nginx suse-mlflow         10.0.3.184  80        153m
suse-private-ai  pen-webui nginx suse-ollama-webui    10.0.3.184  80, 443   8h</screen>
      </step>
    </procedure>
    <section xml:id="mlflow-uninstalling">
      <title>Uninstalling &mlflow;</title>
      <para>
        To uninstall &mlflow;, run the following command:
      </para>
<screen>&prompt.user;<command>helm uninstall mlflow -n <replaceable>SUSE_AI_NAMESPACE</replaceable></command></screen>
    </section>
  </section>
  <section xml:id="mlflow-accessing">
    <title>Accessing &mlflow; Web UI</title>
    <para>
      After the &mlflow; server is up and running, you can access it from the
      Web browser either on the local host or exposed via &ingress;.
    </para>
    <para>
      To access &mlflow; locally, point your Web browser to
      <literal>http://localhost:5000</literal>.
    </para>
    <para>
      To access &mlflow; via &ingress;, add a corresponding line to your
      <filename>/etc/hosts</filename>&mdash;such as <literal>10.0.3.184
      suse-mflow</literal>&mdash;and point your Web browser to
      <literal>http://suse-mlflow</literal>.
    </para>
    <figure xml:id="fg-mlflow-webui">
      <title>&mlflow; Web UI</title>
      <mediaobject>
        <imageobject role="fo">
          <imagedata fileref="mlflow-webui.png" width="100%"/>
        </imageobject>
        <imageobject role="html">
          <imagedata fileref="mlflow-webui.png" width="100%"/>
        </imageobject>
        <textobject role="description"><phrase>A screenshot showing the &mlflow; Web user interface</phrase>
        </textobject>
      </mediaobject>
    </figure>
    <tip>
      <title>
        For more information
      </title>
      <para>
        Explore &mlflow; core features, model training, tracing (observability)
        and more by following the
        <link xlink:href="https://github.com/mlflow/mlflow?tab=readme-ov-file#-core-components">official
        documentation</link>.
      </para>
    </tip>
  </section>
</topic>
