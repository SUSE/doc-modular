<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<topic xml:id="ntp-configure-nts"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Configuring NTS</title>
<!-- add author's e-mail -->
    <meta name="maintainer" content="tbazant@suse.com"/>
    <abstract>
      <para>
        &ntp; (NTP) is a protocol used to synchronize and keep the system time
        of one or more hosts in the network accurate. This article describes how
        to secure NTP using &nts; (NTS).
      </para>
    </abstract>
  </info>
  <para>
    NTP protocol does not introduce security mechanism to make the communication
    between the time server and client authenticated and encrypted. &nts; (NTS)
    is an extension that improves the security of NTP. &chrony; supports NTS and
    can authenticate time sources and protect against certain network attacks.
  </para>
  <para>
    The following procedures outline how to configure the time server and client
    machine for secure time synchronization.
  </para>
  <procedure>
    <title>Configuring the time server</title>
    <step performance="optional">
      <para>
        It is a good idea to configure the time server to update its time via
        NTS. This ensures secure time synchronization from the very beginning of
        the synchronization chain. Comment out any existing time sources in
        <filename>/etc/chrony.conf</filename> that do not support NTS and add at
        least one that supports NTS, for example:
      </para>
<screen>server time.cloudflare.com iburst nts</screen>
      <tip>
        <para>
          The <option>nts</option> option requests NTS connection if it is
          available, otherwise it falls back to NTP if NTS is not available.
        </para>
      </tip>
    </step>
    <step>
      <para>
        Restart the &chronyd; service.
      </para>
<screen>&prompt.sudo;<command>systemctl restart chronyd.srvice</command></screen>
    </step>
    <step>
      <para>
        Verify the configured time sources.
      </para>
<screen>&prompt.user;<command>chronyc sources -v</command>
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
^? time.cloudflare.com           3   6     1     2   -947ms[ -947ms] +/-   12ms
^? pyrrha.fi.muni.cz             2   6     1     1   -948ms[ -948ms] +/-   39ms
^* whitesoft-intex16.c.cbsn>     1   6     1     2   -948ms[ -948ms] +/- 5444us
^? mail.combatostrich.dev        2   6     1     1   -948ms[ -948ms] +/-   28ms</screen>
      <note>
        <para>
          The line that starts with <literal>^*</literal> includes the time
          source that was selected as best.
        </para>
      </note>
      <para>
        Verify that the configured time source uses the NTS mode.
      </para>
<screen>&prompt.user;<command>chronyc -N authdata</command>
Name/IP address             Mode KeyID Type KLen Last Atmp  NAK Cook CLen
=========================================================================
[...]
time.cloudflare.com          NTS     1   15  256    3    0    0    8   96</screen>
    </step>
    <step>
      <para>
        Verify that the server configuration includes the <option>allow</option>
        option that specifies which clients can synchronize time with the time
        server, for example:
      </para>
<screen>allow 192.168.1.0/24</screen>
    </step>
    <step performance="optional">
      <para>
        If the time server is running behind a firewall, allow communication on
        ports for both NTP and NTS. They are 123 and 4460 by default.
      </para>
    </step>
    <step>
      <para>
        Obtain a TLS certificate and a corresponding private key and copy them
        to <filename>/var/lib/chrony/</filename>. Verify they are readable by
        &chrony;, for example:
      </para>
<screen>&prompt.sudo;install -m 0440 -o chrony -g chrony <replaceable>nts.key</replaceable> /var/lib/chrony/
&prompt.sudo;install -m 0440 -o chrony -g chrony <replaceable>nts.crt</replaceable> /var/lib/chrony/</screen>
      <tip>
        <para>
          Find detailed information about TLS certificates in a
          <link
    xlink:href="https://documentation.suse.com/smart/security/html/tls-certificates/index.html">dedicated
          article.</link>
        </para>
      </tip>
    </step>
    <step>
      <para>
        Edit <filename>/etc/chrony.conf</filename> and verify that the
        <option>ntsdumpdir /var/lib/chrony</option> is active. Then append the
        paths to the TLS key and certificate.
      </para>
<screen>ntsdumpdir /var/lib/chrony
ntsserverkey /var/lib/chrony/nts.key
ntsservercert /var/lib/chrony/nts.crt</screen>
    </step>
    <step>
      <para>
        Restart the &chronyd; service.
      </para>
<screen>&prompt.sudo;systemctl restart chronyd.service </screen>
    </step>
  </procedure>
</topic>
