<?xml version="1.0" encoding="UTF-8"?>
<!-- This file originates from the project https://github.com/openSUSE/doc-kit -->
<!-- This file can be edited downstream. -->
<!DOCTYPE topic
[
  <!ENTITY % entities SYSTEM "../common/generic-entities.ent">
    %entities;
]>
<topic xml:id="opensearch-installing"
 role="task" xml:lang="en"
 xmlns="http://docbook.org/ns/docbook" version="5.2"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:trans="http://docbook.org/ns/transclusion">
  <info>
    <title>Installing &opensearch;</title>
    <meta name="maintainer" content="tbazant@suse.com" its:translate="no"/>
    <abstract>
      <para>
        &opensearch; is a community-driven, open source search and analytics
        suite. It is used to search, visualize and analyze data. &opensearch;
        consists of a data store and search engine (&opensearch;), a
        visualization and user interface (&opensearch; Dashboards), and a
        server-side data collector (Data Prepper). Its functionality can be
        extended by plug-ins that enhance features like search, analytics,
        observability, security or machine learning.
      </para>
    </abstract>
  </info>
  <section xml:id="opensearch-installing-app-details">
    <title>Details about the &opensearch; application</title>
    <para>
      Before deploying &opensearch;, it is important to know more about the
      supported configurations and documentation. The following command provides
      the corresponding details:
    </para>
<screen>helm show values oci://dp.apps.rancher.io/charts/opensearch</screen>
    <para>
      Alternatively, you can also refer to the &opensearch; &helm; chart page on
      the &sappco; site at
      <link xlink:href="https://apps.rancher.io/applications/opensearch"/>. It
      contains &opensearch; dependencies, available versions and the link to
      pull the &opensearch; container image.
    </para>
  </section>
  <section xml:id="opensearch-installing-procedure">
    <title>&opensearch; installation procedure</title>
    <para>
      &opensearch; can operate as a single-node or multi-node cluster. The
      following override file examples outline both scenarios.
    </para>
    <important>
      <para>
        Both scenarios require increasing the value of the
        <option>vm.max_map_count</option> to at least 262144. To check the
        current value, run the following command:
      </para>
<screen>&prompt.user;cat /proc/sys/vm/max_map_count</screen>
      <para>
        To increase the value, add the following to
        <filename>/etc/sysctl.conf</filename>:
      </para>
<screen>vm.max_map_count=262144</screen>
      <para>
        Then run <command>sudo sysctl -p</command> to reload.
      </para>
    </important>
    <procedure>
      <xi:include href="../snippets/ai-library-requirement.xml"/>
      <step>
        <para>
          Create an <filename>opensearch_custom_overrides.yaml</filename> file
          to override the default values of the &helm; chart.
        </para>
        <para>
          For a single-node cluster, use the following template file:
        </para>
<screen># opensearch_custom_overrides.yaml
global:
  imagePullSecrets:
    - application-collection
singleNode: true
replicas: 1
persistence:
  enabled: true
  storageClass: local-path

extraEnvs:
  - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
    value: "MySecurePass123"

service:
  type: NodePort
  httpPort: 9200
  transportPort: 9300
  metricsPort: 9600

resources:
  limits:
    memory: "6Gi"
    cpu: "2"

config:
  opensearch.yml: |
    plugins.security.disabled: true</screen>
        <para>
          For a multi-node cluster, use the following template file:
        </para>
<screen># opensearch_custom_overrides.yaml
global:
  imagePullSecrets:
    - application-collection
singleNode: false
replicas: 3
persistence:
  enabled: true
  storageClass: local-path

extraEnvs:
  - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
    value: "MySecurePass123"
  - name: ES_JAVA_OPTS
    value: "-Xms3g -Xmx3g" 

service:
  type: NodePort
  httpPort: 9200
  transportPort: 9300
  metricsPort: 9600

resources:
  limits:
    memory: "6Gi"
    cpu: "2"
  requests:
    memory: "4Gi"
    cpu: "1"

startupProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 12

readinessProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6

livenessProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 120
  periodSeconds: 20
  timeoutSeconds: 5
  failureThreshold: 3

config:
  opensearch.yml: |
    plugins.security.disabled: true
</screen>
      </step>
      <step>
        <para>
          After saving the override file as
          <filename>opensearch_custom_overrides.yaml</filename>, apply its
          configuration with the following command.
        </para>
<screen>&prompt.user;<command>helm upgrade --install \
  opensearch oci://dp.apps.rancher.io/charts/opensearch \
  -n <replaceable>SUSE_AI_NAMESPACE</replaceable> \
  -f <replaceable>opensearch_custom_overrides.yaml</replaceable></command></screen>
      </step>
      <step>
        <para>
          Check that the pods and services are running.
        </para>
<screen>&prompt.user;kubectl get pods -n <replaceable>SUSE_AI_NAMESPACE</replaceable> | grep "opensearch"
opensearch-cluster-master-0           1/1     Running   0          5h34m</screen>
        <para>
          A multi-node cluster configuration shows that the replicas are
          distributed across multiple nodes.
        </para>
<screen>&prompt.user;kubectl get pods -n <replaceable>SUSE_AI_NAMESPACE</replaceable> | grep "opensearch"
opensearch-cluster-master-0 1/1 Running 0 2m30s 10.42.1.32 mgmt-rancher-wkrgpu1
opensearch-cluster-master-1 1/1 Running 0 2m30s 10.42.1.33 mgmt-rancher-wkrgpu1
opensearch-cluster-master-2 1/1 Running 0 2m30s 10.42.0.27 mgmt-rancher</screen>
      </step>
    </procedure>
  </section>
  <section xml:id="opensearch-owui-integration">
    <title>Integrating &opensearch; with &owui;</title>
    <para>
      To integrate &opensearch; with &owui;, follow these steps:
    </para>
    <procedure>
      <step>
        <para>
          Edit the override file for &owui;,
          <filename>owui_custom_overrides.yaml</filename>, and update the
          <literal>extraEnvVars</literal> section as follows.
        </para>
        <itemizedlist>
          <listitem>
            <para>
              Change the <literal>VECTOR_DB</literal> value to
              <literal>opensearch</literal>.
            </para>
          </listitem>
          <listitem>
            <para>
              Remove the <literal>MILVUS_URI</literal> variable.
            </para>
          </listitem>
          <listitem>
            <para>
              Add all the &opensearch;-related environment variables.
            </para>
          </listitem>
        </itemizedlist>
<screen>extraEnvVars:
- name: DEFAULT_MODELS
  value: "gemma:2b"
- name: DEFAULT_USER_ROLE
  value: "pending"
- name: ENABLE_SIGNUP
  value: "true"
- name: GLOBAL_LOG_LEVEL
  value: INFO
- name: RAG_EMBEDDING_MODEL
  value: "sentence-transformers/all-MiniLM-L6-v2"
- name: INSTALL_NLTK_DATASETS
  value: "true"
- name: VECTOR_DB
  value: "opensearch"
#- name: MILVUS_URI
#  value: http://milvus.<replaceable>SUSE_AI_NAMESPACE</replaceable>.svc.cluster.local:19530
- name: OPENAI_API_KEY
  value: "0p3n-w3bu!"
- name: OPENSEARCH_SSL
  value: "false"
- name: OPENSEARCH_URI
  value: http://opensearch-cluster-master.<replaceable>SUSE_AI_NAMESPACE</replaceable>.svc.cluster.local:9200
- name: OPENSEARCH_USERNAME
  value: admin
- name: OPENSEARCH_PASSWORD
  value: MySecurePass123
- name: OPENSEARCH_CERT_VERIFY
  value: "false"</screen>
      </step>
      <step>
        <para>
          Redeploy &owui;.
        </para>
<screen>&prompt.user;<command>helm upgrade --install \
  open-webui oci://dp.apps.rancher.io/charts/open-webui \
  -n <replaceable>SUSE_AI_NAMESPACE</replaceable> \
  -f <replaceable>owui_custom_overrides.yaml</replaceable></command></screen>
      </step>
      <step>
        <para>
          Verify that <literal>VECTOR_DB</literal> is set to
          <literal>opensearch</literal>.
        </para>
<screen>&prompt.user;kubectl exec -it open-webui-0 -n <replaceable>SUSE_AI_NAMESPACE</replaceable> \
  -- sh -c 'echo "VECTOR_DB=$VECTOR_DB"'

Defaulted container "open-webui" out of: open-webui, copy-app-data (init)
VECTOR_DB=opensearch</screen>
      </step>
    </procedure>
  </section>
  <section xml:id="opensearch-upgrading" condition="deployment_standard">
    <title>Upgrading &opensearch;</title>
    <para>
      The &opensearch; chart receives application updates and updates of the
      &helm; chart templates. New versions may include changes that require
      manual steps. These steps are listed in the corresponding
      <filename>README</filename> file. All &opensearch; dependencies are
      updated automatically during an &opensearch; upgrade.
    </para>
    <para>
      To upgrade &opensearch;, identify the new version number and run the
      following command below:
    </para>
<screen>&prompt.user;<command>helm upgrade --install \
  mcpo oci://dp.apps.rancher.io/charts/opensearch \
  -n <replaceable>SUSE_AI_NAMESPACE</replaceable> \
  --version <replaceable>VERSION_NUMBER</replaceable> \
  -f <replaceable>opensearch_custom_overrides.yaml</replaceable></command></screen>
    <tip>
      <para>
        If you omit the <option>--version</option> option, &opensearch; gets
        upgraded to the latest available version.
      </para>
    </tip>
  </section>
  <section xml:id="opensearch-uninstalling">
    <title>Uninstalling &opensearch;</title>
    <para>
      To uninstall &opensearch;, run the following command:
    </para>
<screen>&prompt.user;<command>helm uninstall opensearch -n <replaceable>SUSE_AI_NAMESPACE</replaceable></command></screen>
  </section>
</topic>
