<?xml version="1.0" encoding="UTF-8"?>
<article xmlns="http://docbook.org/ns/docbook" xml:base="SLE-Micro-public-cloud.xml" version="5.0" xml:id="slema-public-cloud" xml:lang="en">
  <info>
     <title xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its"><phrase><phrase os="slemicro">SUSE Linux Enterprise Micro</phrase></phrase> in Public Clouds</title>
     <revhistory xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its">
       <title>Changelog</title>
       <revision>
         <revnumber>1</revnumber>
         <date>2023-03-29</date>
         <revdescription>
           <para>Initial version</para>
         </revdescription>
       </revision>
     </revhistory>
     
     <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" name="updated" content="2023-03-09" its:translate="no"/>

     <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" name="maintainer" content="jsindelarova@suse.com" its:translate="no"/>
     
     <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" name="architecture" content="x86_64;zseries;power;aarch64"/>
     
     <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" name="productname" its:translate="no">
       <productname version="slemicro">SUSE Linux Enterprise Micro</productname>
      </meta>
     
     <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" name="title" its:translate="yes">SLE Micro in Public Clouds</meta>
     <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" name="description" its:translate="yes">
       Learn how to deploy <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> in public clouds. Learn how to add users to suit your needs.
     </meta>
     <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" name="social-descr" its:translate="yes">
       Learn how to deploy <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> in public clouds.
     </meta>
     
     <meta xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its" name="category" content="Systems Management" its:translate="no"/>
     <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its">
       <dm:bugtracker>
         <dm:url>https://bugzilla.suse.com/enter_bug.cgi</dm:url>
         <dm:component>Smart Docs</dm:component>
         <dm:product>Documentation</dm:product>
         <dm:assignee>jsindelarova@suse.com</dm:assignee>
       </dm:bugtracker>
       <dm:editurl>https://github.com/SUSE/doc-modular/tree/main/articles/</dm:editurl>
       <dm:translation>no</dm:translation>
     </dm:docmanager>
     <abstract xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" xmlns:its="http://www.w3.org/2005/11/its">       
       <variablelist>
        <varlistentry>
            <term>TOPIC</term>
            <listitem>
              <para>
                This article provides details about the <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> images intended for use in public clouds. On top of that, it also provides information on creating new users of the system.
              </para>
            </listitem>
          </varlistentry>
         <varlistentry>
            <term>REQUIREMENTS</term>
            <listitem>
            <itemizedlist>
         <listitem>
          <para>Basic understanding of public clouds.</para>
        </listitem>
         <listitem>
           <para>
             <systemitem class="username">root</systemitem> or sudo privileges. 
           </para>
         </listitem>
         </itemizedlist>
         </listitem>
         </varlistentry>
       </variablelist>
     </abstract>
   </info>
  <section xml:lang="en" role="concept" version="5.2" xml:id="micro-public-clouds"><info>
            <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">Basic information about the <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> public cloud images</title>
      <abstract xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">
        <para>
          <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> uses several tools for its deployment in public clouds. This topic also describes required disk size and registration, and provides details about the default user.
        </para>
      </abstract>
    </info>
           
  <section xml:id="micro-cloud-introduction">
    <title>Introduction</title>
    <para>
      This article provides details specific to <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> images that
      are intended for deployment in public cloud environments. The 
      generic information about public cloud images is provided in the
      <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://documentation.suse.com/sle-public-cloud/all/html/public-cloud/public-cloud.html">Public Cloud Guide</link>. For more <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> 
      documentation, refer to the
      <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://documentation.suse.com/sle-micro/"><phrase><phrase os="slemicro">SUSE Linux Enterprise Micro</phrase></phrase>
      documentation set</link>.
    </para>
  </section>
  <section xml:id="micro-cloud-tools-deployment">
    <title>Tools involved in initializing <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> in public clouds</title>
    <para>
      The instance initialization is performed using Ignition and Afterburn.
      In the default Ignition configuration, Ignition is responsible for
      creating the default user: <literal>suse</literal>. Ignition interacts
      with the instance metadata service of the cloud provider only to get the
      so-called user data. Other data, like the user specified in Azure
      or SSH key from the GCE, are not parsed from this metadata service.
    </para>
    <para>
      Afterburn writes the SSH key to the <literal>suse</literal> home
      directory using the instance metadata service (IMDS). To transfer the SSH
      key from the IMDS, the <literal>afterburn-sshkeys@suse</literal> is used.
      The service is started automatically by <systemitem class="daemon">systemd</systemitem>.
    </para>
    <para>
      Ignition runs on the first boot only. To distinguish the first boot
      from succeeding boots, the flag file
      <filename>/boot/writable/firstboot_happened</filename> is created.
      Whenever you want to trigger Ignition again, you need to remove this
      file.
    </para>
    <para>
      The default Ignition configuration is stored in the configuration file:
      <filename>/usr/lib/ignition/base.d/base.ign</filename>. You can modify
      this file to perform configuration changes. For details, refer to
      <xref linkend="task-modifying-ignition-cloud"/>.
    </para>
    <note>
      <title>Combustion not included in the <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> public 
      cloud images</title>
      <para>
        To configure your instance with Combustion, you need to
        create a separate disk in the cloud framework. The disk must have
        the required directory structure. Then you need to create an instance
        with this configuration disk attached. If the use of Combustion is
        needed for integration into your environment, you can build your own
        images using keg and keg-recipes. The keg-recipes project contains the
        image description used by SUSE to build the images we publish. For
        details, refer to
        <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/SUSE-Enceladus/keg-recipes/">keg-recipes</link>.
      </para>
    </note>
  </section>
  <section xml:id="micro-cloud-disk-size-clouds">
    <title>Required and available disk size</title>
    <para>
      The root volume is set to the size specified by the cloud vendors, for
      example, 10 GB in AWS and GCE and 30 GB in Azure.
    </para>
    <para>
      The recommended size for <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> is 12 GB. However, the
      size depends on the number and size of workloads you intend to run.
    </para>
    <para>
      As with each run of the <command>transactional-update</command> command, a new snapshot is created. Keep
      in mind that these snapshots also take up some size, even though Btrfs
      snapshots are space-efficient.
    </para>
    <para>
      The root volume automatically grows as you change the size of the
      underlying disk. When you are running low on disk space, you can always
      stop your instance and increase the size of the system disk, up to the limitation
      of individual disk sizes in each cloud framework.
    </para>
  </section>
  <section xml:id="micro-cloud-snapshots-cloud-vs-slema">
    <title>Snapshotting</title>
    <para>
      <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> creates its own internal snapshots that are not related
      nor can interfere with the external snapshots of the disk. External 
      snapshots can be created using the cloud framework tools for backup 
      purposes or for making new images. For details about <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> 
      snapshots, refer to
      <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://documentation.suse.com/sle-micro/html/SLE-Micro-all/cha-snapshots.html"><phrase><phrase os="slemicro">SLE Micro</phrase></phrase> snapshotting</link>.
    </para>
  </section>
  <section xml:id="micro-cloud-registration">
    <title>Registration</title>
    <para>
      After you deploy the image, you need to register the system. In newer
      images, you can use the <command>registercloudguest</command> command to
      register the system. For details, refer to the
      <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://documentation.suse.com/sle-public-cloud/all/html/public-cloud/cha-admin.html#sec-admin-register">Public Cloud Guide</link>.
    </para>
    <para>
      Alternatively, you can register your system as described in
      the <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://documentation.suse.com/sle-micro/5.3/html/SLE-Micro-all/cha-postintall-registration.html#sec-images-registration"><phrase><phrase os="slemicro">SLE Micro</phrase></phrase>
      registration</link>.
    </para>
  </section>
  <section xml:id="micro-cloud-default-users">
    <title>Default users of <phrase><phrase os="slemicro">SLE Micro</phrase></phrase></title>
    <para>
      <phrase><phrase os="slemicro">SLE Micro</phrase></phrase> images come with a predefined user
      <literal>suse</literal> that has <command>sudo</command> privileges
      assigned. Therefore, you can switch to the <systemitem class="username">root</systemitem> using the
      <command>sudo -i</command> command.
    </para>
    <para>
      As the default user possibly does not suit your needs, you have several
      options for adding users. You can either define users in the Ignition
      configuration file, or use the <command>useradd</command> command
      to add users to the running system.
    </para>
    <para>
      For more details about adding users via Ignition, refer to the
      <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://documentation.suse.com/sle-micro/html/SLE-Micro-all/cha-images-ignition.html#sec-ignition-examples">deployment guide</link>
      and <xref linkend="modifying-ignition-cnfiguration-cloud"/>. For more 
      details about using the <command>useradd</command> command, see
      <xref linkend="task-slemicro-useradd"/>.
    </para>
  </section>
</section>
  <section role="task" xml:lang="en" version="5.2" xml:id="task-modifying-ignition-cloud"><info>
    <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">Reconfiguring the system after first boot</title>
    <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="jsindelarova@suse.com"/>
  </info>
  
  <section xml:id="slemicro-ignition-cloud-introduction">
    <title>Introduction</title>
    <para>
      SLE Micro cloud images come with a default first-boot configuration that
      might not suit your needs. This article gives you instructions on 
      how to proceed to reconfigure your system.
    </para>
  </section>
  <section xml:id="modifying-ignition-cnfiguration-cloud">
    <title>Modifying the default Ignition configuration</title>
    <para>
      The default Ignition configuration is stored in
      <filename>/usr/lib/ignition/base.d/base.ign</filename> that is a part of
      the read-only file system. Therefore, direct changes to this file are not
      allowed. To modify this file, perform the following steps:
    </para>
    <procedure>
      <step>
        <para>
          Remove the flag file
          <filename>/boot/writable/firstboot_happened</filename>.
        </para>
      </step>
      <step>
        <para>
          Run the following command:
        </para>
<screen><prompt role="root"># </prompt><command>transactional-update shell</command></screen>
      </step>
      <step>
        <para>
          Edit the <filename>/usr/lib/ignition/base.d/base.ign</filename> file
          to suit your needs. For details about the Ignition configuration,
          refer to
          <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://documentation.suse.com/sle-micro/html/SLE-Micro-all/cha-images-ignition.html#sec-ignition-examples">Ignition
          configuration examples</link>.
        </para>
      </step>
      <step>
        <para>
          Exit the <command>transactional-update</command> shell by entering <command>exit</command>.
        </para>
      </step>
      <step>
        <para>
          As Ignition runs in the <filename>initramfs</filename>, you need to
          rebuild it by running the command:
        </para>
<screen><prompt role="root"># </prompt><command>transactional-update initrd</command></screen>
      </step>
      <step>
        <para>
          To grant the newly created user access rights using the SSH key 
          provided by the cloud framework, ensure that the following <systemitem class="daemon">systemd</systemitem>
          service is started:
        </para>
<screen><prompt role="root"># </prompt><command>systemctl start afterburn-sshkeys@<replaceable>USER_NAME</replaceable></command></screen>
      </step>
      <step>
        <para>
          Reboot the system.
        </para>
      </step>
    </procedure>
  </section>
</section>
  <section role="task" xml:lang="en" version="5.2" xml:id="task-slemicro-useradd"><info>
    <title xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion">Adding users with the <command>useradd</command> command</title>
    <meta xmlns:its="http://www.w3.org/2005/11/its" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:trans="http://docbook.org/ns/transclusion" name="maintainer" content="jsindelarova@suse.com"/>
  </info>
  
  <section xml:id="slemicro-useradd-introduction">
    <title>Introduction</title>
    <para>
      You can use the <command>useradd</command> command to add users to an
      already running system. However, as SLE Micro is Btrfs-based, the
      <filename>/home</filename> directory is mounted as a subvolume.
      Therefore, you must use the <command>useradd</command> command
      accordingly.
    </para>
  </section>
  <section xml:id="adding-useradd-on-btrfs">
    <title>Adding users with <command>useradd</command></title>
    <para>
      The procedure of creating users in a running system differs according to
      the type of user you want to add.
    </para>
    <para>
      To add a regular user without <command>sudo</command> privileges,
      proceed as described below:
    </para>
    <procedure>
      <step>
        <para>
          Run the <command>useradd</command> command as follows:
        </para>
<screen><prompt role="root"># </prompt><command>useradd --btrfs-subvolume-home --create-home <replaceable>USER_NAME</replaceable></command></screen>
        <para>
          The <option>--btrfs-subvolume-home</option> option denotes that the
          <filename>/home</filename> directory is mounted as a subvolume. The
          <option>--create-home</option> option creates the 
          <filename>/home</filename> under the particular subvolume. If you 
          omit these options, the <filename>/home</filename> directory for 
          the particular user will not be created.
        </para>
      </step>
      <step>
        <para>
          Set a password for the new user:
        </para>
<screen><prompt role="root"># </prompt>passwd <replaceable>USER_NAME</replaceable></screen>
      </step>
    </procedure>
    <para>
      To give the new user <command>sudo</command> privileges, add
      the user to the <literal>wheel</literal> group:
    </para>
<screen><prompt role="root"># </prompt>usermod -aG wheel <replaceable>USER_NAME</replaceable></screen>
  </section>
</section>
</article>
