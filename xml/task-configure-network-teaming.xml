<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<!DOCTYPE article
[
  <!ENTITY % entities SYSTEM "generic-entities.ent">
    %entities;
]>

<!--metadata
 * product all
 * product version all?
 * topic category/ies sysadmin, network
 * target group(s)
 * initially published
 * last modified-->

<!-- Adapted from net_teaming.xml
https://documentation.suse.com/sles/15-SP3/html/SLES-all/cha-network.html#sec-network-iface-teaming

Does not include 'Use case: VLAN over team device', which should be a separate article -->

<article xml:id="task-configure-network-teaming" xml:lang="en"
 role="task"
 xmlns="http://docbook.org/ns/docbook" version="5.1"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink">

 <info>
   <title>Configuring network teaming</title>
   <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
    <dm:bugtracker>
     <dm:url>https://bugzilla.suse.com/enter_bug.cgi</dm:url>
     <dm:component>Smart Docs</dm:component>
     <dm:product>Documentation</dm:product>
     <dm:assignee>tahlia.richardson@suse.com</dm:assignee>
    </dm:bugtracker>
    <dm:translation>no</dm:translation>
   </dm:docmanager>
 </info>

 <section xml:id="environment-configure-network-teaming">
  <title>Environment</title>
   <para>This document applies to the following products and product versions:</para>
   <itemizedlist>
   <listitem>
    <para>&sles;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
   </listitem>
   <listitem>
    <para>&sles4sap;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
   </listitem>
   <listitem>
    <para>&sleha;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
   </listitem>
   <listitem>
    <para>&slehpc;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA</para>
   </listitem>
   <listitem>
    <para>&sled;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
   </listitem>
   <listitem>
    <para>&slert;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
   </listitem>
  </itemizedlist>
 </section>

 <section xml:id="introduction-configure-network-teaming">
  <title>Introduction</title>
  <para>
   Network teaming can be used for different use cases. The two most important use
   cases are explained later and involve:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     Load balancing between different network devices.
    </para>
   </listitem>
   <listitem>
    <para>
     Failover from one network device to another in case one of the devices
     should fail.
    </para>
   </listitem>
  </itemizedlist>
  <para>
   The following teaming modes are available:
  </para>
  <variablelist>
   <varlistentry>
    <term>broadcast</term>
    <listitem>
     <para>
      The team device transmits packets via all its ports.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>roundrobin</term>
    <listitem>
     <para>
      The team device transmits packets via all its ports with round-robin method.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>activebackup</term>
    <listitem>
     <para>
      The team device monitors ports' link changes and uses a port with an active
      link to transmit packets.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>loadbalance</term>
    <listitem>
     <para>
      The team device transmits packets via all its ports, performing load
      balancing (passive or active) with a use of hash functions. For passive
      load balancing, only the BPF hash function is used. For active load
      balancing, the runner finds the best balance by moving hashes between
      available ports.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>lacp</term>
    <listitem>
     <para>
      Implements the 802.3ad LACP protocol.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   Currently, &yast; cannot create a teaming device. You must configure network
   teaming manually using an <filename>ifcfg</filename> file.
  </para>
 </section>

 <section xml:id="requirements-configure-network-teaming">
  <title>Requirements</title>
  <itemizedlist>
   <listitem>
    <para>
     Make sure you have all the necessary packages installed. Install the
     packages
     <package>libteam-tools</package>,
     <package>libteamdctl0</package>, and
     <package>python-libteam</package>.
    </para>
   </listitem>
   <listitem>
    <para>

    </para>
   </listitem>
   <listitem>
    <para>

    </para>
   </listitem>
  </itemizedlist>
 </section>

 <section xml:id="configure-network-teaming">
  <title>Configuring network teaming</title>
  <procedure>
   <step>
    <para>
     Create a configuration file under
     <filename>/etc/sysconfig/network/</filename>. Usually it will be
     <filename>ifcfg-team0</filename>. If you need more than one network teaming
     device, give them ascending numbers.
    </para>
    <para>
     This configuration file contains several variables which are explained in
     the man pages (see <command>man ifcfg</command> and <command>man
     ifcfg-team</command>). An example configuration can be found in your
     system in the file <filename>/etc/sysconfig/network/ifcfg.template</filename>.
    </para>
<screen>STARTMODE=auto <co xml:id="co-team-startmode"/>
BOOTPROTO=static <co xml:id="co-team-boot-and-ip"/>
IPADDRESS="&subnetI;.1/24" <xref linkend="co-team-boot-and-ip"/>
IPADDR6="fd00:deca:fbad:50::1/64" <xref linkend="co-team-boot-and-ip"/>

TEAM_RUNNER="loadbalance" <co xml:id="co-team-loadbalance"/>

TEAM_PORT_DEVICE_0="eth0" <co xml:id="co-team-dev"/>
TEAM_PORT_DEVICE_1="eth1" <xref linkend="co-team-dev"/>

TEAM_LW_NAME="ethtool" <co xml:id="co-team-name"/>
TEAM_LW_ETHTOOL_DELAY_UP="10" <co xml:id="co-team-ethtool-delay"/>
TEAM_LW_ETHTOOL_DELAY_DOWN="10" <xref linkend="co-team-ethtool-delay"/></screen>
    <calloutlist>
     <callout arearefs="co-team-startmode">
      <para>
       Controls the start of the teaming device. The value of
       <literal>auto</literal> means, the interface will be set up when the
       network service is available and will be started automatically on every
       reboot.
      </para>
      <para>
       In case you need to control the device yourself (and prevent it from
       starting automatically), set <varname>STARTMODE</varname> to
       <literal>manual</literal>.
      </para>
     </callout>
     <callout arearefs="co-team-boot-and-ip">
      <para>
       Sets a static IP address (here
       <systemitem
        class="ipaddress">&subnetI;.1</systemitem>
       for IPv4 and
       <systemitem class="ipaddress">fd00:deca:fbad:50::1</systemitem> for
       IPv6).
      </para>
      <para>
       If the network teaming device should use a dynamic IP address, set
       <literal>BOOTPROTO="dhcp"</literal> and remove (or comment) the line with
       <varname>IPADDRESS</varname> and <varname>IPADDR6</varname>.
      </para>
     </callout>
     <callout arearefs="co-team-loadbalance">
      <para>
       Sets <varname>TEAM_RUNNER</varname> to <literal>loadbalance</literal> to
       activate the load balancing mode.
      </para>
     </callout>
     <callout arearefs="co-team-dev">
      <para>
       Specifies one or more devices which should be aggregated to create the
       network teaming device.
      </para>
     </callout>
     <callout arearefs="co-team-name">
      <para>
       Defines a link watcher to monitor the state of subordinate devices. The
       default value <literal>ethtool</literal> checks only if the device is up
       and accessible. This makes this check fast enough. However, it does not
       check if the device can really send or receive packets.
      </para>
      <para>
       If you need a higher confidence in the connection, use the
       <literal>arp_ping</literal> option. This sends pings to an arbitrary host
       (configured in the <varname>TEAM_LW_ARP_PING_TARGET_HOST</varname>
       variable). The network teaming device is considered to be up only if the
       replies are received.
      </para>
     </callout>
     <callout arearefs="co-team-ethtool-delay">
      <para>
       Defines the delay in milliseconds between the link coming up (or down)
       and the runner being notified.
      </para>
     </callout>
    </calloutlist>
    <para>
     Load balancing is used to improve bandwidth. Use the following configuration
     file to create a network teaming device with load balancing capabilities.
    </para>
    <example xml:id="ex-team-lb">
     <title>Configuration for load balancing with network teaming</title>
<screen>STARTMODE=auto
BOOTPROTO=static
IPADDRESS="&subnetI;.1/24"
IPADDR6="fd00:deca:fbad:50::1/64"

TEAM_RUNNER="loadbalance"
TEAM_LB_TX_HASH="ipv4,ipv6,eth,vlan"
TEAM_LB_TX_BALANCER_NAME="basic"
TEAM_LB_TX_BALANCER_INTERVAL="100"

TEAM_PORT_DEVICE_0="eth0"
TEAM_PORT_DEVICE_1="eth1"

TEAM_LW_NAME="ethtool"
TEAM_LW_ETHTOOL_DELAY_UP="10"
TEAM_LW_ETHTOOL_DELAY_DOWN="10"</screen>
    </example>
    <para>
     Failover is used to ensure high availability of a critical network teaming device
     by involving a parallel backup network device. The backup network device is
     running all the time and takes over if and when the main device fails.
    </para>
    <para>
     Use the following configuration file to create a network teaming device with
     failover capabilities.
    </para>
    <example xml:id="ex-team-failover">
     <title>Configuration for DHCP network teaming device</title>
<screen>STARTMODE=auto
BOOTPROTO=static
IPADDR="&subnetI;.2/24"
IPADDR6="fd00:deca:fbad:50::2/64"

TEAM_RUNNER=activebackup
TEAM_PORT_DEVICE_0="eth0"
TEAM_PORT_DEVICE_1="eth1"

TEAM_LW_NAME=ethtool
TEAM_LW_ETHTOOL_DELAY_UP="10"
TEAM_LW_ETHTOOL_DELAY_DOWN="10"</screen>
    </example>
   </step>
   <step>
    <para>
     Remove the configuration files of the interfaces which will be used for the
     teaming device (usually <filename>ifcfg-eth0</filename> and
     <filename>ifcfg-eth1</filename>).
    </para>
    <para>
     It is recommended to make a backup and remove both files. Wicked will
     re-create the configuration files with the necessary parameters for
     teaming.
    </para>
   </step>
   <step>
    <para>
     Optionally, check if everything is included in Wicked's configuration file:
    </para>
 <screen>&prompt.sudo;<command>wicked show-config</command></screen>
   </step>
   <step>
    <para>
     Start the network teaming device <systemitem class="service">team0</systemitem>:
    </para>
 <screen>&prompt.sudo;<command>wicked ifup all team0</command></screen>
    <para>
     In case you need additional debug information, use the option
     <option>--debug all</option> after the <command>all</command> subcommand.
    </para>
   </step>
   <step>
    <para>
     Check the status of the network teaming device. This can be done by the following
     commands:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Get the state of the teamd instance from Wicked:
      </para>
 <screen>&prompt.sudo;<command>wicked ifstatus --verbose team0</command></screen>
     </listitem>
     <listitem>
      <para>
       Get the state of the entire instance:
      </para>
 <screen>&prompt.sudo;<command>teamdctl team0 state</command></screen>
     </listitem>
     <listitem>
      <para>
       Get the systemd state of the teamd instance:
      </para>
 <screen>&prompt.sudo;<command>systemctl status teamd@team0</command></screen>
     </listitem>
    </itemizedlist>
    <para>
     Each of them shows a slightly different view depending on your needs.
    </para>
   </step>
   <step>
    <para>
     In case you need to change something in the
     <filename>ifcfg-team0</filename> file afterward, reload its configuration
     with:
    </para>
 <screen>&prompt.sudo;<command>wicked ifreload team0</command></screen>
   </step>
  </procedure>
  <para>
   Do <emphasis>not</emphasis> use <command>systemctl</command> for starting or
   stopping the teaming device! Instead, use the <command>wicked</command>
   command as shown above.
  </para>

  <!-- ???????? -->

  <para>
   To completely remove the team device, use this procedure:
  </para>
  <procedure>
   <title>Removing a team device</title>
   <step>
    <para>
     Stop the network teaming device <systemitem class="service">team0</systemitem>:
    </para>
    <screen>&prompt.sudo;<command>wicked ifdown team0</command></screen>
   </step>
   <step>
    <para>
     Rename the file <filename>/etc/sysconfig/network/ifcfg-team0</filename> to <filename>/etc/sysconfig/network/.ifcfg-team0</filename>.
     Inserting a dot in front of the file name makes it
     <quote>invisible</quote> for wicked. If you really do not need the
     configuration anymore, you can also remove the file.
    </para>
   </step>
   <step>
    <para>Reload the configuration:</para>
    <screen>&prompt.sudo;<command>wicked ifreload all</command></screen>
   </step>
  </procedure>
 </section>

 <section xml:id="summary-configure-network-teaming">
  <title>Summary</title>
  <para>
   A paragraph of text, summing up the result of the task.
  </para>
 </section>

 <section xml:id="troubleshooting-configure-network-teaming">
  <title>Troubleshooting</title>
  <para>A paragraph of text.</para>
  <variablelist>
   <varlistentry>
    <term>Problem phrased as question</term>
    <listitem>
     <para>
      A paragraph of text.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Another problem phrased as question</term>
    <listitem>
     <para>
      Another paragraph of text.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </section>

 <section xml:id="next-configure-network-teaming">
  <title>Next steps</title>
  <itemizedlist>
   <listitem>
    <para>
     Adding VLANs over a network team
    </para>
   </listitem>
   <listitem>
    <para>

    </para>
   </listitem>
   <listitem>
    <para>

    </para>
   </listitem>
  </itemizedlist>
 </section>

 <section xml:id="related-configure-network-teaming">
  <title>Related topics</title>
  <itemizedlist>
   <listitem>
    <para>
     Configuring network bonding
    </para>
   </listitem>
   <listitem>
    <para>
     Differences between bonding and teaming (title TBD)
    </para>
   </listitem>
   <listitem>
    <para>

    </para>
   </listitem>
  </itemizedlist>
 </section>
</article>
