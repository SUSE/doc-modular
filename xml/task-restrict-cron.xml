<?xml version="1.0" encoding="UTF-8"?>
<!-- This file originates from the project https://github.com/openSUSE/doc-kit -->
<!-- This file can be edited downstream. -->

<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<!DOCTYPE article
[
  <!ENTITY % entities SYSTEM "generic-entities.ent">
    %entities;
]>

<!--metadata
 * product(s): SLES, SLED, SLE-HA, SLES-SAP, SLE-HPC, SLE-RT
 * product version(s): 15 SP3, 15 SP2, 15 GA
 * topic category/ies: system administration, security
 * target group(s): system administrators
 * initially published: ?
 * last modified: 2021-11-26 -->
 
<article xml:id="task-restrict-cron" xml:lang="en"
 role="task"
 xmlns="http://docbook.org/ns/docbook" version="5.1"
 xmlns:its="http://www.w3.org/2005/11/its"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink">

 <info>
  <title>Restricting the &crond; daemon</title>
   <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
    <dm:bugtracker>
     <dm:url>https://bugzilla.suse.com/enter_bug.cgi</dm:url>
     <dm:component>Smart Docs</dm:component>
     <dm:product>Documentation</dm:product>
     <dm:assignee>cwickert@suse.com</dm:assignee>
    </dm:bugtracker>
    <dm:translation>no</dm:translation>
   </dm:docmanager>
 </info>

 <section xml:id="environment-restrict-cron">
 <title>Environment</title>
  <para>This document applies to the following products and product versions:</para>
  <itemizedlist>
  <listitem>
   <para>&sles;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
  </listitem>
  <listitem>
   <para>&sles4sap;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
  </listitem>
  <listitem>
   <para>&sleha;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
  </listitem>
  <listitem>
   <para>&slehpc;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA</para>
  </listitem>
  <listitem>
   <para>&sled;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
  </listitem>
  <listitem>
   <para>&slert;&nbsp;15&nbsp;SP3, 15&nbsp;SP2, 15&nbsp;SP1, 15&nbsp;GA, 12&nbsp;SP5, 12&nbsp;SP4, 12&nbsp;SP3</para>
  </listitem>
 </itemizedlist>
</section>

 <section xml:id="introduction-restrict-cron">
  <title>Introduction</title>
  <para>
   The &crond; system is used to automatically run commands in the background at
   predefined times.
   <!-- For more information about &crond;, refer to the <xref
    linkend="sec-suse-packages-cron"/>. -->
  </para>
  <para>
   The <filename>cron.allow</filename> file specifies a list of users that are
   allowed to execute jobs via &crond;. The file does not exist by default, so
   all users can create &crond; jobs&mdash;except for those listed in
   <filename>cron.deny</filename>.
  </para>
 </section>

 <section xml:id="requirements-restrict-cron">
  <title>Requirements</title>
  <itemizedlist>
   <listitem>
    <para>
     You have installed your product and your system is up and running.
    </para>
   </listitem>
   <listitem>
    <para>
     The <package>cron</package> package is installed. If not, run
     <command>zypper in cron</command> to install it.
    </para>
   </listitem>
  </itemizedlist>
  <!-- cwickert 2021-10-05: No idea why the template contains another <para> here. 
  <para>
   A paragraph of text.
  </para>
  -->
 </section>

 <section xml:id="restrict-cron">
  <title>Restrict access to the &crond; daemon</title>
  <!-- cwickert 2021-10-05: No idea why the template has two introductions, one
   before and one at the beginning of the procedure. 
  <para>
   To prevent users except for root from creating &crond; jobs, perform the
   following steps.
  </para>
  -->
  <procedure>
   <para>
    To prevent users except for root from creating &crond; jobs, perform the
    following steps.
   </para>
   <step>
    <para>
     Create an empty file <filename>/etc/cron.allow</filename>:
    </para>
<screen>&prompt.sudo;<command>touch</command> /etc/cron.allow</screen>
   </step>
   <step>
    <para>
     Allow users to create &crond; jobs by adding their usernames to the file:
    </para>
<screen>&prompt.sudo;<command>echo</command> "&exampleuser_plain;" >> /etc/cron.allow</screen>
   </step>
   <step>
    <para>
     To verify, try creating a &crond; job as non-root user listed in
     <filename>cron.allow</filename>. You should see the message:
    </para>
<screen>&prompt.user;<command>crontab -e</command>
no crontab for &exampleuser_plain; - using an empty one</screen>
    <para>
     Quit the crontab editor and try the same with a user
     <emphasis>not</emphasis> listed in <filename>cron.allow</filename> (or
     before adding them to the file in step 2 of this procedure):
    </para>
<screen>&prompt.user2;<command>crontab -e</command>
You (&exampleuserII_plain;) are not allowed to use this program (crontab)
See crontab(1) for more information</screen>
   </step>
  </procedure>
 </section>

 <section xml:id="summary-restrict-cron">
  <title>Summary</title>
  <para>
   You have successfully restricted creation of new &crond; jobs for non-root
   users.
  </para>
  <important>
   <title>Existing &crond; jobs</title>
   <para>
    Implementing <function>cron.allow</function> only prevents users from
    creating new &crond; jobs. Existing jobs will still be run, even for users
    listed in <filename>cron.deny</filename>. To prevent this, create the file
    as described and remove existing user crontabs from the directory
    <filename>/var/spool/cron/tabs</filename> to ensure they are not run
    anymore.
   </para>
  </important>
 </section>
 
 <section xml:id="troubleshooting-restrict-cron">
  <title>Troubleshooting</title>
  <para>When implementing <filename>/etc/cron.allow</filename>, there are
   basically only two problems that can occur:
  </para>
  <variablelist>
   <varlistentry>
    <term>A user <emphasis>can</emphasis> create a <systemitem
     class="daemon">cron</systemitem> job although they should
     <emphasis>not</emphasis>.</term>
    <listitem>
     <para>
      Check that the username in <filename>/etc/cron.allow</filename> matches
      the actual username.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>A user can <emphasis>not</emphasis> create <systemitem
     class="daemon">cron</systemitem> jobs although they
     <emphasis>should</emphasis>.</term>
    <listitem>
     <para>
      If the user is correctly listed in <filename>/etc/cron.allow</filename>
      but cannot create new &crond; jobs,
      check if they are also listed in <filename>/etc/cron.deny</filename>. If
      the user appears in both files, <filename>/etc/cron.deny</filename> wins.
      Remove the user from the file to allow them to create <systemitem
       class="daemon">cron</systemitem> jobs.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </section>

 <section xml:id="next-restrict-cron">
  <title>Next steps</title>
  <itemizedlist>
   <listitem>
    <para>
     To further improve security, also consider restricting access to the
     <systemitem class="daemon">at</systemitem> scheduler.
    </para>
   </listitem>
   <listitem>
    <para>
     You should also consider switching to &systemd; timer units, as they allow
     for more powerful and reliable task execution. By default, users cannot use
     them to run code when they are not logged in. This limits the way users can
     interact with the system while not being connected to it.
    </para>
    <!--
    <para>
     For more information about &systemd; timer units, refer to <xref
      linkend="sec-boot-systemd-timer-units"/>.
    </para>
    -->
   </listitem>
  </itemizedlist>
 </section>

 <section xml:id="related-restrict-cron">
  <title>Related topics</title>
  <itemizedlist>
   <listitem>
    <para>
     Restricting the <systemitem class="daemon">at</systemitem> scheduler
    </para>
   </listitem>
   <listitem>
    <para>
     <link xlink:href="https://documentation.suse.com/smart/linux/html/task-create-systemd-timers/">Create &systemd; timers</link>
     <!-- cwickert 2021-10-05: use this link instead once we build
      all smartdocs in one:
     <xref linkend="task-create-systemd-timers"/>
     -->
    </para>
   </listitem>
  </itemizedlist>
 </section>
</article>
